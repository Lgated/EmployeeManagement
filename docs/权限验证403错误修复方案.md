# æƒé™éªŒè¯ 403 é”™è¯¯ä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜è¯Šæ–­

### é”™è¯¯ç°è±¡
- **è´¦å·**ï¼šadminï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
- **é”™è¯¯**ï¼šè®¿é—® `/api/employ` è¿”å› `403 Forbidden`
- **é”™è¯¯æç¤º**ï¼š
  - "æ²¡æœ‰æƒé™è®¿é—®èµ„æº"
  - "åŠ è½½å‘˜å·¥åˆ—è¡¨å¤±è´¥ï¼šRequest failed with status code 403"

### æ ¹æœ¬åŸå› åˆ†æ

#### é—®é¢˜1ï¼šJwtAuthFilter ä¸­ Principal è®¾ç½®é”™è¯¯

**å½“å‰ä»£ç **ï¼ˆ`JwtAuthFilter.java:54-59`ï¼‰ï¼š
```java
UserAuthentication authentication = new UserAuthentication(
    username,          // principal è®¾ç½®ä¸ºå­—ç¬¦ä¸²
    null,
    List.of(),
    userId
);
```

**é—®é¢˜**ï¼š
- `principal` è¢«è®¾ç½®ä¸ºç®€å•çš„ `username` å­—ç¬¦ä¸²
- ä½† `SecurityUtil` æœŸæœ› `principal` æ˜¯ä¸€ä¸ª **Map** ç±»å‹
- å¯¼è‡´ `SecurityUtil.getCurrentUserId()` è¿”å› **null**
- æƒé™åˆ‡é¢æ— æ³•è·å–ç”¨æˆ·IDï¼ŒéªŒè¯å¤±è´¥

#### é—®é¢˜2ï¼šSecurityUtil çš„ç±»å‹åˆ¤æ–­ä¸åŒ¹é…

**å½“å‰ä»£ç **ï¼ˆ`SecurityUtil.java:19`ï¼‰ï¼š
```java
if (authentication != null && authentication.getPrincipal() instanceof Map) {
    // æœŸæœ› principal æ˜¯ Map
}
```

**ä½†å®é™…**ï¼š
- `JwtAuthFilter` ä¼ å…¥çš„æ˜¯ `String` ç±»å‹çš„ username
- ç±»å‹åˆ¤æ–­å¤±è´¥ï¼Œæ–¹æ³•è¿”å› `null`

#### é—®é¢˜3ï¼šæƒé™åˆ‡é¢ä¾èµ– UserId

**å½“å‰ä»£ç **ï¼ˆ`PermissionAspect.java:39`ï¼‰ï¼š
```java
Long userId = SecurityUtil.getCurrentUserId();  // è¿”å› null

if (!permissionService.hasPermission(userId, permissionCode)) {
    // userId ä¸º nullï¼ŒæŸ¥è¯¢å¤±è´¥
    throw new PermissionDeniedException("æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ");
}
```

### æ•°æ®æµåˆ†æ

```
ç™»å½• â†’ JWT Token ç”Ÿæˆï¼ˆåŒ…å« userIdã€roleã€departmentï¼‰
  â†“
è¯·æ±‚ /api/employ â†’ JwtAuthFilter è§£æ Token
  â†“
åˆ›å»º UserAuthenticationï¼ˆprincipal = username å­—ç¬¦ä¸²ï¼‰âŒ
  â†“
å­˜å…¥ SecurityContext
  â†“
æƒé™åˆ‡é¢ â†’ SecurityUtil.getCurrentUserId()
  â†“
åˆ¤æ–­ principal instanceof Map â†’ false âŒ
  â†“
è¿”å› null
  â†“
PermissionService.hasPermission(null, "employee:read") â†’ å¼‚å¸¸
  â†“
403 Forbidden
```

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ€»è§ˆ

éœ€è¦ä¿®æ”¹ **3 ä¸ªæ–‡ä»¶**ï¼š
1. âœ… `JwtAuthFilter.java` - å°†è§’è‰²ä¿¡æ¯å­˜å…¥ Principal
2. âœ… `SecurityUtil.java` - æ”¹ä¸ºä» UserAuthentication è·å–ä¿¡æ¯
3. âœ… `UserAuthentication.java` - æ‰©å±•å­—æ®µå­˜å‚¨è§’è‰²å’Œéƒ¨é—¨

---

## ğŸ“ è¯¦ç»†ä¿®æ”¹æ­¥éª¤

### æ­¥éª¤1ï¼šæ‰©å±• UserAuthentication ç±»

**æ–‡ä»¶**ï¼š`src/main/java/com/example/empmgmt/security/UserAuthentication.java`

**ä¿®æ”¹ç›®çš„**ï¼šå­˜å‚¨å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆè§’è‰²ã€éƒ¨é—¨ã€å‘˜å·¥IDï¼‰

**å®Œæ•´ä»£ç **ï¼š
```java
package com.example.empmgmt.security;

import lombok.Getter;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;

import java.util.Collection;

/**
 * è‡ªå®šä¹‰è®¤è¯å¯¹è±¡
 * æ‰©å±• UsernamePasswordAuthenticationTokenï¼Œå­˜å‚¨ç”¨æˆ·å®Œæ•´ä¿¡æ¯
 */
@Getter
public class UserAuthentication extends UsernamePasswordAuthenticationToken {

    private final Long userId;
    private final String role;           // æ–°å¢ï¼šè§’è‰²
    private final String department;     // æ–°å¢ï¼šéƒ¨é—¨
    private final Long employeeId;       // æ–°å¢ï¼šå‘˜å·¥ID

    /**
     * æ„é€ å‡½æ•°
     * @param principal ç”¨æˆ·å
     * @param credentials å¯†ç ï¼ˆé€šå¸¸ä¸º nullï¼‰
     * @param authorities æƒé™é›†åˆ
     * @param userId ç”¨æˆ·ID
     * @param role ç”¨æˆ·è§’è‰²
     * @param department ç”¨æˆ·éƒ¨é—¨
     * @param employeeId å…³è”çš„å‘˜å·¥ID
     */
    public UserAuthentication(
            Object principal,
            Object credentials,
            Collection<? extends GrantedAuthority> authorities,
            Long userId,
            String role,
            String department,
            Long employeeId
    ) {
        super(principal, credentials, authorities);
        this.userId = userId;
        this.role = role;
        this.department = department;
        this.employeeId = employeeId;
    }
}
```

**å…³é”®å˜åŒ–**ï¼š
- âœ… æ–°å¢ `role` å­—æ®µ
- âœ… æ–°å¢ `department` å­—æ®µ
- âœ… æ–°å¢ `employeeId` å­—æ®µ
- âœ… æ„é€ å‡½æ•°å¢åŠ å¯¹åº”å‚æ•°

---

### æ­¥éª¤2ï¼šä¿®æ”¹ JwtAuthFilter è§£æå¹¶å­˜å‚¨è§’è‰²ä¿¡æ¯

**æ–‡ä»¶**ï¼š`src/main/java/com/example/empmgmt/config/JwtAuthFilter.java`

**ä¿®æ”¹ç›®çš„**ï¼šä» Token ä¸­è§£æè§’è‰²ã€éƒ¨é—¨ã€å‘˜å·¥IDï¼Œå¹¶å­˜å…¥è®¤è¯å¯¹è±¡

**ä¿®æ”¹ä½ç½®**ï¼š`doFilterInternal` æ–¹æ³•çš„ç¬¬ 44-59 è¡Œ

**åŸä»£ç **ï¼š
```java
try {
    String username = jwtUtil.parseUsername(token);
    Long userId = jwtUtil.parseUserId(token);

    if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
        UserAuthentication authentication = new UserAuthentication(
            username,
            null,
            List.of(),
            userId
        );
        authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
        SecurityContextHolder.getContext().setAuthentication(authentication);
    }
}
```

**ä¿®æ”¹åçš„ä»£ç **ï¼š
```java
try {
    // 3. è§£æ Tokenï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
    String username = jwtUtil.parseUsername(token);
    Long userId = jwtUtil.parseUserId(token);
    String role = jwtUtil.getRoleFromToken(token);           // æ–°å¢ï¼šè§£æè§’è‰²
    String department = jwtUtil.getDepartmentFromToken(token); // æ–°å¢ï¼šè§£æéƒ¨é—¨
    
    // è§£æå‘˜å·¥IDï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
    Claims claims = jwtUtil.getClaimsFromToken(token);
    Long employeeId = claims.get("employeeId", Long.class);

    // 4. éªŒè¯ Token æ˜¯å¦æœ‰æ•ˆ
    if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
        // 5. åˆ›å»ºè®¤è¯å¯¹è±¡ï¼ˆåŒ…å«å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼‰
        UserAuthentication authentication = new UserAuthentication(
            username,
            null,
            List.of(),
            userId,
            role,         // ä¼ å…¥è§’è‰²
            department,   // ä¼ å…¥éƒ¨é—¨
            employeeId    // ä¼ å…¥å‘˜å·¥ID
        );

        // 6. è®¾ç½®è®¤è¯è¯¦æƒ…
        authentication.setDetails(
            new WebAuthenticationDetailsSource().buildDetails(request)
        );

        // 7. å°†è®¤è¯ä¿¡æ¯å­˜å…¥ SecurityContext
        SecurityContextHolder.getContext().setAuthentication(authentication);
        
        log.debug("ç”¨æˆ· {} (ID: {}, è§’è‰²: {}) è®¤è¯æˆåŠŸ", username, userId, role);
    }
} catch (Exception e) {
    log.error("JWT Token éªŒè¯å¤±è´¥: {}", e.getMessage());
}
```

**å…³é”®å˜åŒ–**ï¼š
- âœ… è°ƒç”¨ `jwtUtil.getRoleFromToken(token)` è§£æè§’è‰²
- âœ… è°ƒç”¨ `jwtUtil.getDepartmentFromToken(token)` è§£æéƒ¨é—¨
- âœ… è§£æ `employeeId`
- âœ… åˆ›å»º `UserAuthentication` æ—¶ä¼ å…¥å®Œæ•´ä¿¡æ¯
- âœ… æ·»åŠ æ—¥å¿—è®°å½•è®¤è¯æˆåŠŸ

**éœ€è¦å¯¼å…¥çš„åŒ…**ï¼š
```java
import io.jsonwebtoken.Claims;  // æ–°å¢
```

**åŒæ—¶åœ¨ JwtUtil ä¸­æ·»åŠ å…¬å¼€æ–¹æ³•**ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š
```java
/**
 * å…¬å¼€æ–¹æ³•ï¼šä» Token ä¸­è§£æ Claims
 */
public Claims getClaimsFromToken(String token) {
    try {
        return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody();
    } catch (Exception e) {
        throw new IllegalArgumentException("æ— æ•ˆçš„Token", e);
    }
}
```

---

### æ­¥éª¤3ï¼šä¿®æ”¹ SecurityUtil ä» UserAuthentication è·å–ä¿¡æ¯

**æ–‡ä»¶**ï¼š`src/main/java/com/example/empmgmt/common/util/SecurityUtil.java`

**ä¿®æ”¹ç›®çš„**ï¼šä» `UserAuthentication` å¯¹è±¡ç›´æ¥è·å–ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä» Map

**å®Œæ•´æ›¿æ¢ä»£ç **ï¼š
```java
package com.example.empmgmt.common.util;

import com.example.empmgmt.security.UserAuthentication;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;

/**
 * ä» Spring Security ä¸Šä¸‹æ–‡ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
 */
public class SecurityUtil {

    /**
     * è·å–å½“å‰ç”¨æˆ·ID
     */
    public static Long getCurrentUserId() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        
        // ä» UserAuthentication å¯¹è±¡ç›´æ¥è·å–
        if (authentication instanceof UserAuthentication) {
            return ((UserAuthentication) authentication).getUserId();
        }
        
        return null;
    }

    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·å
     */
    public static String getCurrentUsername() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        
        if (authentication instanceof UserAuthentication) {
            return authentication.getName();  // getName() è¿”å› principal
        }
        
        return null;
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·è§’è‰²
     */
    public static String getCurrentUserRole() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        
        if (authentication instanceof UserAuthentication) {
            return ((UserAuthentication) authentication).getRole();
        }
        
        return null;
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·éƒ¨é—¨
     */
    public static String getCurrentUserDepartment() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        
        if (authentication instanceof UserAuthentication) {
            return ((UserAuthentication) authentication).getDepartment();
        }
        
        return null;
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·å…³è”çš„å‘˜å·¥ID
     */
    public static Long getCurrentEmployeeId() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        
        if (authentication instanceof UserAuthentication) {
            return ((UserAuthentication) authentication).getEmployeeId();
        }
        
        return null;
    }

    /**
     * åˆ¤æ–­æ˜¯å¦å·²è®¤è¯
     */
    public static boolean isAuthenticated() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        return authentication != null && authentication.isAuthenticated();
    }
}
```

**å…³é”®å˜åŒ–**ï¼š
- âŒ åˆ é™¤ï¼š`instanceof Map` åˆ¤æ–­
- âœ… æ”¹ä¸ºï¼š`instanceof UserAuthentication` åˆ¤æ–­
- âœ… ç›´æ¥è°ƒç”¨ `UserAuthentication` çš„ getter æ–¹æ³•
- âœ… ä»£ç æ›´ç®€æ´ã€ç±»å‹å®‰å…¨

---

## âœ… éªŒè¯æ­¥éª¤

### 1. ç¼–è¯‘é¡¹ç›®

```bash
cd d:/java/data/EmployManagement
mvn clean compile
```

ç¡®è®¤æ²¡æœ‰ç¼–è¯‘é”™è¯¯ã€‚

### 2. é‡å¯åç«¯æœåŠ¡

```bash
mvn spring-boot:run
```

### 3. é‡æ–°ç™»å½•è·å–æ–° Token

**ä½¿ç”¨ Postman æˆ–å‰ç«¯ç™»å½•**ï¼š
```http
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "tokenType": "Bearer",
    "expiresIn": 3600
  }
}
```

### 4. æµ‹è¯•å‘˜å·¥åˆ—è¡¨æ¥å£

```http
GET http://localhost:8080/api/employ?page=1&size=10
Authorization: Bearer <æ–°è·å–çš„token>
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [...],
    "total": 10,
    "page": 1,
    "size": 10
  }
}
```

### 5. æ£€æŸ¥åç«¯æ—¥å¿—

åº”è¯¥çœ‹åˆ°ç±»ä¼¼æ—¥å¿—ï¼š
```
ç”¨æˆ· admin (ID: 1, è§’è‰²: SUPER_ADMIN) è®¤è¯æˆåŠŸ
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **Principal ç±»å‹** | String (username) | ä¾ç„¶æ˜¯ Stringï¼Œä½†é¢å¤–ä¿¡æ¯åœ¨ UserAuthentication å¯¹è±¡ä¸­ |
| **è§’è‰²ä¿¡æ¯** | âŒ ä¸¢å¤± | âœ… å­˜å‚¨åœ¨ UserAuthentication.role |
| **éƒ¨é—¨ä¿¡æ¯** | âŒ ä¸¢å¤± | âœ… å­˜å‚¨åœ¨ UserAuthentication.department |
| **SecurityUtil.getCurrentUserId()** | âŒ è¿”å› null | âœ… è¿”å›å®é™…ç”¨æˆ·ID |
| **æƒé™éªŒè¯** | âŒ å¤±è´¥ (403) | âœ… æˆåŠŸ (200) |
| **ä»£ç å¤æ‚åº¦** | é«˜ï¼ˆMap å¼ºè½¬ï¼‰ | ä½ï¼ˆç›´æ¥ getterï¼‰ |

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¦è¿™æ ·æ”¹ï¼Ÿ

### æ”¹é€  1ï¼šæ‰©å±• UserAuthentication

**ç›®çš„**ï¼šå°†ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯ï¼ˆè§’è‰²ã€éƒ¨é—¨ã€å‘˜å·¥IDï¼‰å­˜å‚¨åœ¨è®¤è¯å¯¹è±¡ä¸­

**å¥½å¤„**ï¼š
- âœ… é¿å…æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“
- âœ… æé«˜æ€§èƒ½ï¼ˆä»å†…å­˜è¯»å–ï¼‰
- âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼ˆToken ç”Ÿæˆæ—¶çš„å¿«ç…§ï¼‰

### æ”¹é€  2ï¼šJwtAuthFilter è§£æå¹¶å­˜å‚¨

**ç›®çš„**ï¼šä» JWT Token ä¸­è§£æå‡ºè§’è‰²ã€éƒ¨é—¨ç­‰ä¿¡æ¯ï¼Œå¹¶å­˜å…¥ `UserAuthentication`

**å¥½å¤„**ï¼š
- âœ… Token ä¸­å·²ç»åŒ…å«è¿™äº›ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
- âœ… ä¸éœ€è¦é¢å¤–æŸ¥è¯¢æ•°æ®åº“
- âœ… å‡å°‘ç³»ç»Ÿå‹åŠ›

### æ”¹é€  3ï¼šSecurityUtil ç®€åŒ–è·å–é€»è¾‘

**ç›®çš„**ï¼šç›´æ¥ä» `UserAuthentication` å¯¹è±¡è·å–ä¿¡æ¯

**å¥½å¤„**ï¼š
- âœ… ç±»å‹å®‰å…¨ï¼ˆä¸éœ€è¦ Map å¼ºè½¬ï¼‰
- âœ… ä»£ç æ›´ç®€æ´
- âœ… IDE æœ‰ç±»å‹æç¤º

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆä¸åœ¨ JwtUtil.getClaimsFromToken ä¸­è®¾ä¸º publicï¼Ÿ

**A**ï¼šè¿™ä¸ªæ–¹æ³•ç°åœ¨æ˜¯ `private`ï¼Œä¸ºäº†æ”¯æŒåœ¨ `JwtAuthFilter` ä¸­è§£æ `employeeId`ï¼Œéœ€è¦æ”¹ä¸º `public` æˆ–è€…å¢åŠ ä¸“é—¨çš„ `getEmployeeIdFromToken()` æ–¹æ³•ã€‚

**æ¨èæ–¹å¼**ï¼šå¢åŠ ä¸“é—¨æ–¹æ³•
```java
public Long getEmployeeIdFromToken(String token) {
    Claims claims = getClaimsFromToken(token);
    return claims.get("employeeId", Long.class);
}
```

ç„¶ååœ¨ `JwtAuthFilter` ä¸­ï¼š
```java
Long employeeId = jwtUtil.getEmployeeIdFromToken(token);
```

### Q2ï¼šä¸ºä»€ä¹ˆ SecurityUtil ä¸ç”¨ Map äº†ï¼Ÿ

**A**ï¼š
- **ä¹‹å‰**ï¼šæœŸæœ› `principal` æ˜¯ Mapï¼Œä½†å®é™…æ˜¯ Stringï¼Œç±»å‹ä¸åŒ¹é…
- **ç°åœ¨**ï¼šç›´æ¥ä» `UserAuthentication` å¯¹è±¡è·å–ï¼Œç±»å‹å®‰å…¨

### Q3ï¼šè€ Token è¿˜èƒ½ç”¨å—ï¼Ÿ

**A**ï¼š
- âŒ ä¸èƒ½ï¼å› ä¸ºè€ Token è™½ç„¶åŒ…å«è§’è‰²ä¿¡æ¯ï¼Œä½†è€ä»£ç æ²¡æœ‰è§£æ
- âœ… éœ€è¦é‡æ–°ç™»å½•è·å–æ–° Token
- âœ… æ–° Token ä¼šè¢«æ–°ä»£ç æ­£ç¡®è§£æ

### Q4ï¼šå‰ç«¯éœ€è¦æ”¹å—ï¼Ÿ

**A**ï¼š
- âœ… ä¸éœ€è¦ï¼å‰ç«¯åªéœ€è¦é‡æ–°ç™»å½•è·å–æ–° Token
- âœ… API æ¥å£è°ƒç”¨æ–¹å¼ä¸å˜

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

### 1. æ‰€æœ‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•

ä¿®æ”¹åï¼Œè€çš„ Token ä¸ä¼šè¢«æ­£ç¡®è§£æï¼ˆè™½ç„¶åŒ…å«ä¿¡æ¯ï¼Œä½†è€ä»£ç æ²¡ç”¨ä¸Šï¼‰ã€‚

**å»ºè®®**ï¼š
- æ¸…ç©ºå‰ç«¯ localStorage ä¸­çš„ token
- æç¤ºç”¨æˆ·é‡æ–°ç™»å½•

### 2. JwtUtil éœ€è¦å…¬å¼€ getClaimsFromToken æˆ–å¢åŠ  getEmployeeIdFromToken

**ä¸¤ç§æ–¹å¼**ï¼š

**æ–¹å¼1**ï¼šæ”¹ä¸º publicï¼ˆç®€å•ç²—æš´ï¼‰
```java
public Claims getClaimsFromToken(String token) {
    // ... ç°æœ‰ä»£ç 
}
```

**æ–¹å¼2**ï¼šå¢åŠ ä¸“é—¨æ–¹æ³•ï¼ˆæ¨èï¼‰
```java
public Long getEmployeeIdFromToken(String token) {
    Claims claims = getClaimsFromToken(token);
    return claims.get("employeeId", Long.class);
}

// getClaimsFromToken ä¿æŒ private
```

### 3. æ—¥å¿—è®°å½•

å»ºè®®åœ¨ `JwtAuthFilter` ä¸­æ·»åŠ æ—¥å¿—ï¼š
```java
log.debug("ç”¨æˆ· {} (ID: {}, è§’è‰²: {}) è®¤è¯æˆåŠŸ", username, userId, role);
```

è¿™æ ·å¯ä»¥æ–¹ä¾¿è°ƒè¯•æƒé™é—®é¢˜ã€‚

---

## ğŸš€ ä¿®å¤æ•ˆæœ

ä¿®å¤åï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ï¼š

1. âœ… **åç«¯æ—¥å¿—**ï¼š`ç”¨æˆ· admin (ID: 1, è§’è‰²: SUPER_ADMIN) è®¤è¯æˆåŠŸ`
2. âœ… **å‘˜å·¥åˆ—è¡¨åŠ è½½æˆåŠŸ**ï¼šè¿”å› 200ï¼Œæ˜¾ç¤ºå‘˜å·¥æ•°æ®
3. âœ… **æƒé™éªŒè¯é€šè¿‡**ï¼šè¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ¥å£
4. âœ… **æ—  403 é”™è¯¯**ï¼šæ‰€æœ‰æœ‰æƒé™çš„æ“ä½œéƒ½èƒ½æ­£å¸¸æ‰§è¡Œ

---

## ğŸ“„ æ–‡ä»¶æ¸…å•

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š

| æ–‡ä»¶ | è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|------|------|---------|
| **UserAuthentication.java** | `src/main/java/com/example/empmgmt/security/` | å¢åŠ  roleã€departmentã€employeeId å­—æ®µ |
| **JwtAuthFilter.java** | `src/main/java/com/example/empmgmt/config/` | è§£æå¹¶å­˜å‚¨è§’è‰²ã€éƒ¨é—¨ã€å‘˜å·¥ID |
| **SecurityUtil.java** | `src/main/java/com/example/empmgmt/common/util/` | æ”¹ä¸ºä» UserAuthentication è·å–ä¿¡æ¯ |
| **JwtUtil.java**ï¼ˆå¯é€‰ï¼‰ | `src/main/java/com/example/empmgmt/common/util/` | å…¬å¼€ getClaimsFromToken æˆ–å¢åŠ  getEmployeeIdFromToken |

---

## ğŸ’¡ æ€»ç»“

**æ ¹æœ¬åŸå› **ï¼š
- JWT Token ä¸­åŒ…å«è§’è‰²ä¿¡æ¯ï¼Œä½† `JwtAuthFilter` æ²¡æœ‰è§£æå¹¶å­˜å‚¨
- `SecurityUtil` æœŸæœ›ä» Map è·å–ä¿¡æ¯ï¼Œä½†å®é™… principal æ˜¯ String
- æƒé™åˆ‡é¢æ— æ³•è·å– userIdï¼Œå¯¼è‡´æƒé™éªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… æ‰©å±• `UserAuthentication` å­˜å‚¨å®Œæ•´ä¿¡æ¯
- âœ… `JwtAuthFilter` è§£æå¹¶å­˜å‚¨è§’è‰²ã€éƒ¨é—¨ã€å‘˜å·¥ID
- âœ… `SecurityUtil` æ”¹ä¸ºä» `UserAuthentication` ç›´æ¥è·å–

**é¢„è®¡ä¿®å¤æ—¶é—´**ï¼š15-20 åˆ†é’Ÿ

æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ä¿®æ”¹åï¼Œæƒé™éªŒè¯åŠŸèƒ½å°±èƒ½æ­£å¸¸å·¥ä½œäº†ï¼ğŸ‰
