# å‘˜å·¥ç®¡ç†ç³»ç»ŸåŠŸèƒ½æ‰©å±•å»ºè®®

  

## ä¸€ã€ç°æœ‰åŠŸèƒ½ç›˜ç‚¹ âœ…

  

ä½ å·²ç»å®ç°çš„åŠŸèƒ½ï¼š

- âœ… å‘˜å·¥CRUDï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ï¼‰

- âœ… è½¯åˆ é™¤æœºåˆ¶

- âœ… åˆ†é¡µæŸ¥è¯¢ï¼ˆåç«¯åˆ†é¡µï¼‰

- âœ… æœç´¢åŠŸèƒ½ï¼ˆæŒ‰å§“åã€éƒ¨é—¨ï¼‰

- âœ… ç»Ÿè®¡åŠŸèƒ½ï¼ˆéƒ¨é—¨äººæ•°ã€å¹³å‡è–ªèµ„ã€å·¥é¾„ï¼‰

- âœ… JWTè®¤è¯

- âœ… ç”¨æˆ·æ³¨å†Œç™»å½•

- âœ… Spring Securityé›†æˆ

- âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç†

  

---

  

## äºŒã€ä¼ä¸šçº§å‘˜å·¥ç®¡ç†ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½å¯¹æ¯”

  

### 2.1 çœŸå®ä¼ä¸šçº§ç³»ç»Ÿé€šå¸¸åŒ…å«çš„åŠŸèƒ½æ¨¡å—

  

| åŠŸèƒ½æ¨¡å— | ä½ çš„ç³»ç»Ÿ | ä¼ä¸šçº§ç³»ç»Ÿ | ä¼˜å…ˆçº§ |

|---------|---------|-----------|--------|

| **åŸºç¡€ç®¡ç†** | | | |

| å‘˜å·¥ä¿¡æ¯ç®¡ç† | âœ… | âœ… | - |

| éƒ¨é—¨ç®¡ç† | âš ï¸ ç®€å•å­—æ®µ | âœ… ç‹¬ç«‹æ¨¡å— | ğŸ”¥ é«˜ |

| èŒä½ç®¡ç† | âš ï¸ ç®€å•å­—æ®µ | âœ… ç‹¬ç«‹æ¨¡å— | ğŸ”¥ é«˜ |

| ç»„ç»‡æ¶æ„æ ‘ | âŒ | âœ… | ğŸ”¥ é«˜ |

| **äººäº‹ç®¡ç†** | | | |

| å‘˜å·¥å…¥èŒ | âœ… åŸºç¡€ | âœ… å®Œæ•´æµç¨‹ | ğŸŸ¡ ä¸­ |

| å‘˜å·¥ç¦»èŒ | âœ… è½¯åˆ é™¤ | âœ… ç¦»èŒæµç¨‹ | ğŸŸ¡ ä¸­ |

| å‘˜å·¥è°ƒå²— | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| å‘˜å·¥æ™‹å‡ | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| åˆåŒç®¡ç† | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| **è€ƒå‹¤ç®¡ç†** | | | |

| è€ƒå‹¤æ‰“å¡ | âŒ | âœ… | ğŸ”¥ é«˜ |

| è¯·å‡ç®¡ç† | âŒ | âœ… | ğŸ”¥ é«˜ |

| åŠ ç­ç®¡ç† | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| è€ƒå‹¤ç»Ÿè®¡ | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| **è–ªèµ„ç®¡ç†** | | | |

| è–ªèµ„è®¡ç®— | âŒ | âœ… | ğŸ”¥ é«˜ |

| è–ªèµ„å‘æ”¾ | âŒ | âœ… | ğŸ”¥ é«˜ |

| è–ªèµ„æ¡ | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| **æ–‡ä»¶ç®¡ç†** | | | |

| å‘˜å·¥å¤´åƒ | âŒ | âœ… | ğŸŸ¢ ä½ |

| è¯ä»¶ä¸Šä¼  | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| åˆåŒæ–‡ä»¶ | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| **ç³»ç»ŸåŠŸèƒ½** | | | |

| æ“ä½œæ—¥å¿— | âŒ | âœ… | ğŸ”¥ é«˜ |

| æ•°æ®å¯¼å‡º | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| æ•°æ®å¯¼å…¥ | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| æ¶ˆæ¯é€šçŸ¥ | âŒ | âœ… | ğŸŸ¡ ä¸­ |

| æƒé™ç®¡ç† | âš ï¸ åŸºç¡€ | âœ… RBAC | ğŸ”¥ é«˜ |

  

---

  

## ä¸‰ã€æ¨èä¼˜å…ˆå®ç°çš„åŠŸèƒ½ï¼ˆæŒ‰æŠ€æœ¯ä»·å€¼æ’åºï¼‰

  

### ğŸ”¥ é«˜ä¼˜å…ˆçº§ï¼ˆæŠ€æœ¯æ ˆæå‡æ˜æ˜¾ï¼‰

  

#### 1. **æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½** ğŸ“

  

**åº”ç”¨åœºæ™¯ï¼š**

- å‘˜å·¥å¤´åƒä¸Šä¼ 

- èº«ä»½è¯ã€å­¦å†è¯ä¹¦ç­‰è¯ä»¶ä¸Šä¼ 

- åˆåŒæ–‡ä»¶ä¸Šä¼ 

  

**æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”ï¼š**

  

**æ–¹æ¡ˆAï¼šæœ¬åœ°å­˜å‚¨ï¼ˆé€‚åˆå¼€å‘/å°é¡¹ç›®ï¼‰**

```java

// ä¾èµ–

// Spring Boot Starter Web å·²åŒ…å«ï¼Œæ— éœ€é¢å¤–ä¾èµ–

  

// é…ç½® application.yml

spring:

Â  servlet:

Â  Â  multipart:

Â  Â  Â  max-file-size: 10MB Â  Â  Â # å•ä¸ªæ–‡ä»¶æœ€å¤§10MB

Â  Â  Â  max-request-size: 50MB Â  # æ€»è¯·æ±‚æœ€å¤§50MB

Â  Â  Â  enabled: true

  

// æ–‡ä»¶å­˜å‚¨è·¯å¾„é…ç½®

file:

Â  upload:

Â  Â  path: D:/uploads/employee Â # Windows

Â  Â  # path: /var/uploads/employee Â # Linux

Â  Â  url-prefix: /uploads/ Â  Â  Â # è®¿é—®URLå‰ç¼€

```

  

**å®ç°ä»£ç ç¤ºä¾‹ï¼š**

```java

@Service

public class FileService {

Â  Â  @Value("${file.upload.path}")

Â  Â  private String uploadPath;

Â  Â  @Value("${file.upload.url-prefix}")

Â  Â  private String urlPrefix;

Â  Â  public String uploadFile(MultipartFile file, String subPath) {

Â  Â  Â  Â  // 1. éªŒè¯æ–‡ä»¶

Â  Â  Â  Â  if (file.isEmpty()) {

Â  Â  Â  Â  Â  Â  throw new BusinessException("æ–‡ä»¶ä¸èƒ½ä¸ºç©º");

Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å

Â  Â  Â  Â  String originalFilename = file.getOriginalFilename();

Â  Â  Â  Â  String extension = originalFilename.substring(originalFilename.lastIndexOf("."));

Â  Â  Â  Â  String newFilename = UUID.randomUUID().toString() + extension;

Â  Â  Â  Â  // 3. åˆ›å»ºç›®å½•

Â  Â  Â  Â  File dir = new File(uploadPath + "/" + subPath);

Â  Â  Â  Â  if (!dir.exists()) {

Â  Â  Â  Â  Â  Â  dir.mkdirs();

Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. ä¿å­˜æ–‡ä»¶

Â  Â  Â  Â  File dest = new File(dir, newFilename);

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  file.transferTo(dest);

Â  Â  Â  Â  } catch (IOException e) {

Â  Â  Â  Â  Â  Â  throw new BusinessException("æ–‡ä»¶ä¸Šä¼ å¤±è´¥: " + e.getMessage());

Â  Â  Â  Â  }

Â  Â  Â  Â  // 5. è¿”å›è®¿é—®URL

Â  Â  Â  Â  return urlPrefix + subPath + "/" + newFilename;

Â  Â  }

}

  

@RestController

@RequestMapping("/api/files")

public class FileController {

Â  Â  @PostMapping("/upload")

Â  Â  public Result<String> upload(@RequestParam("file") MultipartFile file) {

Â  Â  Â  Â  String url = fileService.uploadFile(file, "employee");

Â  Â  Â  Â  return Result.success(url);

Â  Â  }

}

```

  

**æ–¹æ¡ˆBï¼šOSSå¯¹è±¡å­˜å‚¨ï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰**

```xml

<!-- é˜¿é‡Œäº‘OSS -->

<dependency>

Â  Â  <groupId>com.aliyun.oss</groupId>

Â  Â  <artifactId>aliyun-sdk-oss</artifactId>

Â  Â  <version>3.17.1</version>

</dependency>

  

<!-- æˆ– è…¾è®¯äº‘COS -->

<dependency>

Â  Â  <groupId>com.qcloud</groupId>

Â  Â  <artifactId>cos_api</artifactId>

Â  Â  <version>5.6.89</version>

</dependency>

```

  

**æ¨èï¼š** å¼€å‘é˜¶æ®µç”¨æœ¬åœ°å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒç”¨OSSï¼ˆé˜¿é‡Œäº‘/è…¾è®¯äº‘/ä¸ƒç‰›äº‘ï¼‰

  

---

  

#### 2. **AOPæ“ä½œæ—¥å¿—** ğŸ“

  

**åº”ç”¨åœºæ™¯ï¼š**

- è®°å½•æ‰€æœ‰å¢åˆ æ”¹æ“ä½œ

- è®°å½•è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆ

- å®¡è®¡è¿½è¸ª

  

**æŠ€æœ¯æ ˆï¼š**

```xml

<!-- Spring Boot Starter AOPï¼ˆé€šå¸¸å·²åŒ…å«ï¼‰ -->

<dependency>

Â  Â  <groupId>org.springframework.boot</groupId>

Â  Â  <artifactId>spring-boot-starter-aop</artifactId>

</dependency>

```

  

**å®ç°ä»£ç ç¤ºä¾‹ï¼š**

  

**1. å®šä¹‰æ—¥å¿—æ³¨è§£ï¼š**

```java

@Target(ElementType.METHOD)

@Retention(RetentionPolicy.RUNTIME)

@Documented

public @interface OperationLog {

Â  Â  String value() default ""; Â  Â  Â  Â  Â  // æ“ä½œæè¿°

Â  Â  String module() default ""; Â  Â  Â  Â  Â  // æ“ä½œæ¨¡å—

Â  Â  OperationType type() default OperationType.OTHER; Â // æ“ä½œç±»å‹

}

  

enum OperationType {

Â  Â  CREATE, UPDATE, DELETE, QUERY, OTHER

}

```

  

**2. AOPåˆ‡é¢å®ç°ï¼š**

```java

@Aspect

@Component

@Slf4j

public class OperationLogAspect {

Â  Â  @Autowired

Â  Â  private OperationLogService logService;

Â  Â  @Around("@annotation(operationLog)")

Â  Â  public Object around(ProceedingJoinPoint joinPoint, OperationLog operationLog) throws Throwable {

Â  Â  Â  Â  // 1. è·å–æ–¹æ³•ä¿¡æ¯

Â  Â  Â  Â  MethodSignature signature = (MethodSignature) joinPoint.getSignature();

Â  Â  Â  Â  String methodName = signature.getMethod().getName();

Â  Â  Â  Â  Object[] args = joinPoint.getArgs();

Â  Â  Â  Â  // 2. è·å–å½“å‰ç”¨æˆ·

Â  Â  Â  Â  Long userId = SecurityUtil.getCurrentUserId();

Â  Â  Â  Â  String username = SecurityUtil.getCurrentUsername();

Â  Â  Â  Â  // 3. æ‰§è¡Œå‰è®°å½•

Â  Â  Â  Â  long startTime = System.currentTimeMillis();

Â  Â  Â  Â  String requestParams = JSON.toJSONString(args);

Â  Â  Â  Â  Object result = null;

Â  Â  Â  Â  String errorMsg = null;

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  // 4. æ‰§è¡Œç›®æ ‡æ–¹æ³•

Â  Â  Â  Â  Â  Â  result = joinPoint.proceed();

Â  Â  Â  Â  Â  Â  // 5. æ‰§è¡Œåè®°å½•æˆåŠŸæ—¥å¿—

Â  Â  Â  Â  Â  Â  long endTime = System.currentTimeMillis();

Â  Â  Â  Â  Â  Â  saveLog(operationLog, methodName, requestParams,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â JSON.toJSONString(result), userId, username,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â endTime - startTime, true, null);

Â  Â  Â  Â  Â  Â  return result;

Â  Â  Â  Â  } catch (Exception e) {

Â  Â  Â  Â  Â  Â  // 6. å¼‚å¸¸æ—¶è®°å½•å¤±è´¥æ—¥å¿—

Â  Â  Â  Â  Â  Â  errorMsg = e.getMessage();

Â  Â  Â  Â  Â  Â  long endTime = System.currentTimeMillis();

Â  Â  Â  Â  Â  Â  saveLog(operationLog, methodName, requestParams,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â null, userId, username,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â endTime - startTime, false, errorMsg);

Â  Â  Â  Â  Â  Â  throw e;

Â  Â  Â  Â  }

Â  Â  }

Â  Â  private void saveLog(OperationLog annotation, String methodName,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  String requestParams, String responseData,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Long userId, String username,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  long duration, boolean success, String errorMsg) {

Â  Â  Â  Â  OperationLogEntity log = new OperationLogEntity();

Â  Â  Â  Â  log.setModule(annotation.module());

Â  Â  Â  Â  log.setOperation(annotation.value());

Â  Â  Â  Â  log.setType(annotation.type().name());

Â  Â  Â  Â  log.setMethod(methodName);

Â  Â  Â  Â  log.setRequestParams(requestParams);

Â  Â  Â  Â  log.setResponseData(responseData);

Â  Â  Â  Â  log.setUserId(userId);

Â  Â  Â  Â  log.setUsername(username);

Â  Â  Â  Â  log.setDuration(duration);

Â  Â  Â  Â  log.setSuccess(success);

Â  Â  Â  Â  log.setErrorMsg(errorMsg);

Â  Â  Â  Â  log.setCreateTime(LocalDateTime.now());

Â  Â  Â  Â  // å¼‚æ­¥ä¿å­˜æ—¥å¿—ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰

Â  Â  Â  Â  CompletableFuture.runAsync(() -> {

Â  Â  Â  Â  Â  Â  logService.save(log);

Â  Â  Â  Â  });

Â  Â  }

}

```

  

**3. ä½¿ç”¨ç¤ºä¾‹ï¼š**

```java

@OperationLog(value = "åˆ›å»ºå‘˜å·¥", module = "å‘˜å·¥ç®¡ç†", type = OperationType.CREATE)

@PostMapping

public Result<EmployeeResponse> create(@Valid @RequestBody EmployeeCreateRequest request) {

Â  Â  // ...

}

  

@OperationLog(value = "åˆ é™¤å‘˜å·¥", module = "å‘˜å·¥ç®¡ç†", type = OperationType.DELETE)

@DeleteMapping("/{id}")

public Result<Void> delete(@PathVariable Long id) {

Â  Â  // ...

}

```

  

**4. æ—¥å¿—å®ä½“ç±»ï¼š**

```java

@Entity

@Table(name = "operation_log")

@Data

public class OperationLogEntity {

Â  Â  @Id

Â  Â  @GeneratedValue(strategy = GenerationType.IDENTITY)

Â  Â  private Long id;

Â  Â  private String module; Â  Â  Â  Â // æ¨¡å—

Â  Â  private String operation; Â  Â  // æ“ä½œ

Â  Â  private String type; Â  Â  Â  Â  Â // ç±»å‹

Â  Â  private String method; Â  Â  Â  Â // æ–¹æ³•å

Â  Â  private String requestParams; // è¯·æ±‚å‚æ•°

Â  Â  private String responseData; Â // å“åº”æ•°æ®

Â  Â  private Long userId; Â  Â  Â  Â  Â // ç”¨æˆ·ID

Â  Â  private String usernam