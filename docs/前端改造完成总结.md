# å‰ç«¯æ”¹é€ å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„æ”¹é€ 

### æ­¥éª¤1ï¼šæ·»åŠ ç™»å‡ºAPIæ–¹æ³• âœ…

**æ–‡ä»¶ï¼š** `frontend/src/api/auth.ts`

**æ”¹åŠ¨ï¼š**
- æ·»åŠ äº† `logout()` æ–¹æ³•ï¼Œè°ƒç”¨åç«¯ `/api/auth/logout` æ¥å£
- åç«¯ä¼šè‡ªåŠ¨å¤„ç†ï¼šATåŠ å…¥é»‘åå•ã€åˆ é™¤RTã€ä½¿Cookieè¿‡æœŸ

```typescript
export const logout = (): Promise<void> => {
  return request.post('/auth/logout')
}
```

---

### æ­¥éª¤2ï¼šæ”¹é€ Layout.tsxçš„ç™»å‡ºåŠŸèƒ½ âœ…

**æ–‡ä»¶ï¼š** `frontend/src/components/Layout.tsx`

**æ”¹åŠ¨ï¼š**
1. å¯¼å…¥ `logout` API å’Œ `message` ç»„ä»¶
2. æ”¹é€  `handleLogout` å‡½æ•°ï¼š
   - è°ƒç”¨åç«¯ç™»å‡ºæ¥å£
   - æ¸…é™¤å‰ç«¯çŠ¶æ€ï¼ˆauthStoreï¼‰
   - æ˜¾ç¤ºæˆåŠŸæç¤º
   - è·³è½¬åˆ°ç™»å½•é¡µ
   - é”™è¯¯å¤„ç†ï¼šå³ä½¿åç«¯å¤±è´¥ä¹Ÿæ¸…é™¤å‰ç«¯çŠ¶æ€

**å…³é”®ä»£ç ï¼š**
```typescript
const handleLogout = async () => {
  try {
    // 1. è°ƒç”¨åç«¯ç™»å‡ºæ¥å£ï¼Œæ¸…é™¤RTå’Œé»‘åå•AT
    await logout()
    
    // 2. æ¸…é™¤å‰ç«¯çŠ¶æ€ï¼ˆlocalStorageä¸­çš„ATå’Œç”¨æˆ·ä¿¡æ¯ï¼‰
    clearAuth()
    
    // 3. æç¤ºå¹¶è·³è½¬åˆ°ç™»å½•é¡µ
    message.success('å·²é€€å‡ºç™»å½•')
    navigate('/login')
  } catch (error: any) {
    // å³ä½¿åç«¯å¤±è´¥ï¼Œä¹Ÿæ¸…é™¤å‰ç«¯çŠ¶æ€
    clearAuth()
    message.warning('é€€å‡ºç™»å½•æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå·²æ¸…é™¤æœ¬åœ°æ•°æ®')
    navigate('/login')
  }
}
```

---

### æ­¥éª¤3ï¼šæ”¹è¿›åˆ·æ–°Tokenæ—¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯ âœ…

**æ–‡ä»¶ï¼š** `frontend/src/utils/request.ts`

**æ”¹åŠ¨ï¼š**
1. å¯¼å…¥ `useAuthStore`
2. æ”¹è¿› `refreshToken` å‡½æ•°ï¼š
   - åˆ·æ–°æˆåŠŸåï¼Œä¸ä»…æ›´æ–°localStorageä¸­çš„AT
   - åŒæ—¶æ›´æ–°authStoreä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆusernameã€roleã€departmentã€employeeIdï¼‰
   - ç¡®ä¿åˆ·æ–°Tokenåï¼Œç”¨æˆ·ä¿¡æ¯ä¿æŒæœ€æ–°

**å…³é”®ä»£ç ï¼š**
```typescript
const refreshToken = async (): Promise<string | null> => {
  try {
    const response = await axios.post('/api/auth/refresh', {}, {
      withCredentials: true,
    })
    
    const res = response.data as ApiResult<any>
    if (res.code === 200 && res.data?.token) {
      const authData = res.data
      
      // æ›´æ–°localStorageä¸­çš„AT
      localStorage.setItem('token', authData.token)
      
      // âœ… å…³é”®ï¼šå¦‚æœåç«¯è¿”å›äº†ç”¨æˆ·ä¿¡æ¯ï¼Œæ›´æ–°authStore
      if (authData.username) {
        useAuthStore.getState().setAuth(
          authData.token,
          authData.username,
          authData.role,
          authData.department,
          authData.employeeId
        )
      }
      
      return authData.token
    }
    return null
  } catch (error) {
    console.error('åˆ·æ–°Tokenå¤±è´¥:', error)
    return null
  }
}
```

**åŒæ—¶æ”¹è¿›çš„åœ°æ–¹ï¼š**
- åˆ·æ–°å¤±è´¥æ—¶ï¼Œä¹Ÿæ¸…é™¤authStoreçŠ¶æ€
- ç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§

---

### æ­¥éª¤4ï¼šä¼˜åŒ–è·¯ç”±å®ˆå« âœ…

**æ–‡ä»¶ï¼š** `frontend/src/App.tsx`

**æ”¹åŠ¨ï¼š**
- ä¼˜åŒ– `RequireAuth` ç»„ä»¶ï¼šä¸ä»…æ£€æŸ¥ `isAuthenticated`ï¼Œè¿˜æ£€æŸ¥ `token` æ˜¯å¦å­˜åœ¨
- ç¡®ä¿è·¯ç”±å®ˆå«æ›´åŠ ä¸¥æ ¼

**å…³é”®ä»£ç ï¼š**
```typescript
export const RequireAuth: React.FC<{ children: JSX.Element }> = ({ children }) => {
  const { isAuthenticated, token } = useAuthStore()
  
  // å¦‚æœæœªç™»å½•æˆ–æ²¡æœ‰tokenï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
  if (!isAuthenticated || !token) {
    return <Navigate to="/login" replace />
  }
  
  return children
}
```

---

## ğŸ“‹ æ”¹é€ æ¸…å•éªŒè¯

- [x] **æ­¥éª¤1ï¼šç™»å½•é¡µé¢ä¿å­˜ç”¨æˆ·ä¿¡æ¯** - âœ… å·²å®Œæˆï¼ˆä¹‹å‰å·²å®ç°ï¼‰
- [x] **æ­¥éª¤2ï¼šæ·»åŠ ç™»å‡ºåŠŸèƒ½** - âœ… å·²å®Œæˆ
- [x] **æ­¥éª¤3ï¼šåˆ·æ–°æ—¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯** - âœ… å·²å®Œæˆ
- [x] **æ­¥éª¤4ï¼šè·¯ç”±å®ˆå«ä¼˜åŒ–** - âœ… å·²å®Œæˆ

---

## ğŸ¯ æ”¹é€ åçš„å®Œæ•´æµç¨‹

### 1. ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç 
    â†“
è°ƒç”¨ login() API
    â†“
åç«¯è¿”å› AT + RT (Cookieè‡ªåŠ¨è®¾ç½®)
    â†“
å‰ç«¯è°ƒç”¨ setAuth() ä¿å­˜ATå’Œç”¨æˆ·ä¿¡æ¯åˆ°authStore
    â†“
è·³è½¬åˆ°é¦–é¡µ
```

### 2. APIè¯·æ±‚æµç¨‹

```
ç”¨æˆ·æ“ä½œè§¦å‘APIè¯·æ±‚
    â†“
è¯·æ±‚æ‹¦æˆªå™¨ï¼šæ·»åŠ  Authorization: Bearer AT
    â†“
åç«¯éªŒè¯AT
    â†“
å¦‚æœATæœ‰æ•ˆ â†’ è¿”å›æ•°æ® âœ…
å¦‚æœATè¿‡æœŸ â†’ è¿”å›401
    â†“
å“åº”æ‹¦æˆªå™¨æ£€æµ‹åˆ°401
    â†“
è‡ªåŠ¨è°ƒç”¨åˆ·æ–°æ¥å£ï¼ˆRTä»Cookieè‡ªåŠ¨å‘é€ï¼‰
    â†“
åç«¯éªŒè¯RTï¼Œç”Ÿæˆæ–°AT+æ–°RTï¼ˆTokenæ—‹è½¬ï¼‰
    â†“
å‰ç«¯æ›´æ–°ATå’Œç”¨æˆ·ä¿¡æ¯
    â†“
è‡ªåŠ¨é‡è¯•åŸè¯·æ±‚ âœ…
```

### 3. ç™»å‡ºæµç¨‹

```
ç”¨æˆ·ç‚¹å‡»é€€å‡ºç™»å½•
    â†“
è°ƒç”¨ logout() API
    â†“
åç«¯å¤„ç†ï¼š
  - å°†ATåŠ å…¥é»‘åå•
  - åˆ é™¤Redisä¸­çš„RT
  - ä½¿Cookieè¿‡æœŸ
    â†“
å‰ç«¯æ¸…é™¤authStoreçŠ¶æ€
    â†“
è·³è½¬åˆ°ç™»å½•é¡µ
```

### 4. Tokenåˆ·æ–°æµç¨‹ï¼ˆæ— æ„Ÿï¼‰

```
ATè¿‡æœŸ â†’ 401é”™è¯¯
    â†“
è‡ªåŠ¨è°ƒç”¨åˆ·æ–°æ¥å£
    â†“
åç«¯éªŒè¯RTï¼Œç”Ÿæˆæ–°AT+æ–°RT
    â†“
å‰ç«¯æ›´æ–°ï¼š
  - localStorageä¸­çš„AT
  - authStoreä¸­çš„ATå’Œç”¨æˆ·ä¿¡æ¯
    â†“
è‡ªåŠ¨é‡è¯•åŸè¯·æ±‚
    â†“
ç”¨æˆ·æ— æ„ŸçŸ¥ âœ…
```

---

## ğŸ” å…³é”®æ”¹è¿›ç‚¹

### 1. ç™»å‡ºåŠŸèƒ½å®Œå–„

**ä¹‹å‰ï¼š**
```typescript
const handleLogout = () => {
  clearAuth()  // åªæ¸…é™¤å‰ç«¯çŠ¶æ€
  navigate('/login')
}
```

**ç°åœ¨ï¼š**
```typescript
const handleLogout = async () => {
  await logout()  // å…ˆè°ƒç”¨åç«¯ï¼Œæ¸…é™¤RTå’Œé»‘åå•AT
  clearAuth()     // å†æ¸…é™¤å‰ç«¯çŠ¶æ€
  navigate('/login')
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… åç«¯RTè¢«æ­£ç¡®åˆ é™¤
- âœ… ATè¢«åŠ å…¥é»‘åå•ï¼Œç«‹å³å¤±æ•ˆ
- âœ… Cookieè¿‡æœŸ
- âœ… å®‰å…¨æ€§æ›´é«˜

### 2. åˆ·æ–°æ—¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**ä¹‹å‰ï¼š**
```typescript
// åªæ›´æ–°AT
localStorage.setItem('token', res.data.token)
```

**ç°åœ¨ï¼š**
```typescript
// åŒæ—¶æ›´æ–°ATå’Œç”¨æˆ·ä¿¡æ¯
localStorage.setItem('token', authData.token)
useAuthStore.getState().setAuth(
  authData.token,
  authData.username,
  authData.role,
  authData.department,
  authData.employeeId
)
```

**ä¼˜åŠ¿ï¼š**
- âœ… ç”¨æˆ·ä¿¡æ¯ä¿æŒæœ€æ–°
- âœ… è§’è‰²ã€éƒ¨é—¨ç­‰ä¿¡æ¯ä¸ä¼šä¸¢å¤±
- âœ… çŠ¶æ€ä¸€è‡´æ€§æ›´å¥½

### 3. è·¯ç”±å®ˆå«å¢å¼º

**ä¹‹å‰ï¼š**
```typescript
// åªæ£€æŸ¥isAuthenticated
if (!isAuthenticated) {
  return <Navigate to="/login" replace />
}
```

**ç°åœ¨ï¼š**
```typescript
// åŒæ—¶æ£€æŸ¥isAuthenticatedå’Œtoken
if (!isAuthenticated || !token) {
  return <Navigate to="/login" replace />
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ›´ä¸¥æ ¼çš„éªŒè¯
- âœ… é˜²æ­¢çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µ
- âœ… å®‰å…¨æ€§æ›´é«˜

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. ç™»å½•æµ‹è¯•
- [ ] ç™»å½•æˆåŠŸåï¼Œæ£€æŸ¥authStoreæ˜¯å¦æ­£ç¡®ä¿å­˜ç”¨æˆ·ä¿¡æ¯
- [ ] æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰token
- [ ] æ£€æŸ¥Cookieä¸­æ˜¯å¦æœ‰rtï¼ˆHttpOnlyï¼‰

### 2. APIè¯·æ±‚æµ‹è¯•
- [ ] æ­£å¸¸è¯·æ±‚æ˜¯å¦æºå¸¦Authorization header
- [ ] Cookieæ˜¯å¦è‡ªåŠ¨å‘é€

### 3. æ— æ„Ÿåˆ·æ–°æµ‹è¯•
- [ ] ATè¿‡æœŸåï¼Œæ˜¯å¦è‡ªåŠ¨åˆ·æ–°
- [ ] åˆ·æ–°åï¼ŒauthStoreä¸­çš„ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ›´æ–°
- [ ] ç”¨æˆ·æ˜¯å¦æ— æ„ŸçŸ¥

### 4. ç™»å‡ºæµ‹è¯•
- [ ] ç‚¹å‡»ç™»å‡ºï¼Œæ˜¯å¦è°ƒç”¨åç«¯æ¥å£
- [ ] å‰ç«¯çŠ¶æ€æ˜¯å¦æ¸…é™¤
- [ ] ç™»å‡ºåï¼Œæ—§çš„ATæ˜¯å¦å¤±æ•ˆï¼ˆå°è¯•ä½¿ç”¨æ—§ATè¯·æ±‚APIï¼Œåº”è¯¥å¤±è´¥ï¼‰

### 5. è·¯ç”±å®ˆå«æµ‹è¯•
- [ ] æœªç™»å½•æ—¶è®¿é—®å—ä¿æŠ¤è·¯ç”±ï¼Œæ˜¯å¦è·³è½¬åˆ°ç™»å½•é¡µ
- [ ] ç™»å½•åè®¿é—®å—ä¿æŠ¤è·¯ç”±ï¼Œæ˜¯å¦æ­£å¸¸

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. Cookieè®¾ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

å¦‚æœå¼€å‘ç¯å¢ƒä½¿ç”¨HTTPï¼Œåç«¯Cookieçš„`secure`è®¾ç½®ä¸º`true`ä¼šå¯¼è‡´Cookieæ— æ³•å‘é€ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- å¼€å‘ç¯å¢ƒï¼š`secure(false)`
- ç”Ÿäº§ç¯å¢ƒï¼š`secure(true)`

### 2. CORSé…ç½®

ç¡®ä¿åç«¯CORSé…ç½®æ­£ç¡®ï¼š
```java
config.setAllowCredentials(true);
config.setAllowedOrigins(List.of("http://localhost:3000"));  // å‰ç«¯åœ°å€
```

### 3. åˆ·æ–°é¢‘ç‡

å½“å‰å®ç°æ— åˆ·æ–°é¢‘ç‡é™åˆ¶ï¼Œå¦‚æœæ‹…å¿ƒæ»¥ç”¨ï¼Œå¯ä»¥åœ¨åç«¯æ·»åŠ é™åˆ¶ã€‚

### 4. é”™è¯¯å¤„ç†

æ‰€æœ‰é”™è¯¯éƒ½å·²å¦¥å–„å¤„ç†ï¼š
- åˆ·æ–°å¤±è´¥ â†’ æ¸…é™¤çŠ¶æ€ï¼Œè·³è½¬ç™»å½•
- ç™»å‡ºå¤±è´¥ â†’ æ¸…é™¤å‰ç«¯çŠ¶æ€ï¼Œä»ç„¶è·³è½¬ç™»å½•

---

## âœ… æ€»ç»“

æ‰€æœ‰æ”¹é€ å·²å®Œæˆï¼ç°åœ¨å‰ç«¯å®Œå…¨æ”¯æŒåŒTokenæœºåˆ¶ï¼š

1. âœ… **ç™»å½•**ï¼šä¿å­˜ATå’Œç”¨æˆ·ä¿¡æ¯
2. âœ… **APIè¯·æ±‚**ï¼šè‡ªåŠ¨æºå¸¦AT
3. âœ… **æ— æ„Ÿåˆ·æ–°**ï¼šATè¿‡æœŸè‡ªåŠ¨åˆ·æ–°ï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
4. âœ… **ç™»å‡º**ï¼šè°ƒç”¨åç«¯æ¥å£ï¼Œæ¸…é™¤RTå’Œé»‘åå•AT
5. âœ… **è·¯ç”±å®ˆå«**ï¼šä¸¥æ ¼éªŒè¯ç™»å½•çŠ¶æ€

**åŒTokenæœºåˆ¶ç°åœ¨å·²å®Œå…¨å®ç°å¹¶å¯ç”¨ï¼** ğŸ‰

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2024å¹´
