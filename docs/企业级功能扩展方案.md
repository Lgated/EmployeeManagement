# å‘˜å·¥ç®¡ç†ç³»ç»Ÿ - ä¼ä¸šçº§åŠŸèƒ½æ‰©å±•æ–¹æ¡ˆ

> æœ¬æ–‡æ¡£è¯¦ç»†è®¾è®¡äº†ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ï¼šAOP æ“ä½œæ—¥å¿—ã€æƒé™ç®¡ç†ç³»ç»Ÿã€Excel æ•°æ®å¯¼å…¥å¯¼å‡º
> 
> ä½œè€…ï¼šAI Assistant  
> æ—¥æœŸï¼š2025-12-31

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€AOP æ“ä½œæ—¥å¿—ç³»ç»Ÿ](#ä¸€aop-æ“ä½œæ—¥å¿—ç³»ç»Ÿ)
- [äºŒã€ä¸‰çº§æƒé™ç®¡ç†ç³»ç»Ÿ](#äºŒä¸‰çº§æƒé™ç®¡ç†ç³»ç»Ÿ)
- [ä¸‰ã€Excel æ•°æ®å¯¼å…¥å¯¼å‡º](#ä¸‰excel-æ•°æ®å¯¼å…¥å¯¼å‡º)
- [å››ã€é›†æˆæµ‹è¯•æ–¹æ¡ˆ](#å››é›†æˆæµ‹è¯•æ–¹æ¡ˆ)

---

## ä¸€ã€AOP æ“ä½œæ—¥å¿—ç³»ç»Ÿ

### 1.1 åŠŸèƒ½æ¦‚è¿°

é€šè¿‡ AOP åˆ‡é¢æŠ€æœ¯ï¼Œè‡ªåŠ¨è®°å½•ç³»ç»Ÿä¸­æ‰€æœ‰é‡è¦æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰ï¼ŒåŒ…æ‹¬æ“ä½œäººã€æ“ä½œæ—¶é—´ã€æ“ä½œç±»å‹ã€æ“ä½œè¯¦æƒ…ã€IP åœ°å€ç­‰ä¿¡æ¯ã€‚

### 1.2 æ•°æ®åº“è®¾è®¡

```sql
-- æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE operation_log (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,                    -- æ“ä½œäººID
    username VARCHAR(50) NOT NULL,               -- æ“ä½œäººç”¨æˆ·å
    operation_type VARCHAR(20) NOT NULL,         -- æ“ä½œç±»å‹ï¼šCREATE/UPDATE/DELETE/QUERY
    module VARCHAR(50) NOT NULL,                 -- æ“ä½œæ¨¡å—ï¼šEMPLOYEE/USER/SYSTEM
    description VARCHAR(500),                    -- æ“ä½œæè¿°
    method VARCHAR(200),                         -- æ–¹æ³•å
    params TEXT,                                 -- è¯·æ±‚å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰
    result TEXT,                                 -- è¿”å›ç»“æœï¼ˆJSONæ ¼å¼ï¼‰
    ip_address VARCHAR(50),                      -- IPåœ°å€
    location VARCHAR(100),                       -- æ“ä½œåœ°ç‚¹ï¼ˆå¯é€‰ï¼‰
    browser VARCHAR(100),                        -- æµè§ˆå™¨ä¿¡æ¯
    os VARCHAR(100),                             -- æ“ä½œç³»ç»Ÿ
    execution_time BIGINT,                       -- æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    status VARCHAR(20) DEFAULT 'SUCCESS',        -- æ‰§è¡ŒçŠ¶æ€ï¼šSUCCESS/FAILURE
    error_message TEXT,                          -- é”™è¯¯ä¿¡æ¯
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES user_account(id)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_operation_log_user_id ON operation_log(user_id);
CREATE INDEX idx_operation_log_created_at ON operation_log(created_at);
CREATE INDEX idx_operation_log_module ON operation_log(module);
CREATE INDEX idx_operation_log_type ON operation_log(operation_type);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE operation_log IS 'ç³»ç»Ÿæ“ä½œæ—¥å¿—è¡¨';
COMMENT ON COLUMN operation_log.execution_time IS 'æ–¹æ³•æ‰§è¡Œè€—æ—¶ï¼Œå•ä½æ¯«ç§’';
```

### 1.3 åç«¯å®ç°

#### 1.3.1 æ·»åŠ ä¾èµ–ï¼ˆpom.xmlï¼‰

```xml
<!-- AOPæ”¯æŒï¼ˆSpring Boot Starterå·²åŒ…å«AspectJï¼‰ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>

<!-- å¯é€‰ï¼šIPåœ°å€è§£æ -->
<dependency>
    <groupId>org.lionsoul</groupId>
    <artifactId>ip2region</artifactId>
    <version>2.7.0</version>
</dependency>

<!-- ç”¨æˆ·ä»£ç†è§£æ -->
<dependency>
    <groupId>eu.bitwalker</groupId>
    <artifactId>UserAgentUtils</artifactId>
    <version>1.21</version>
</dependency>
```

#### 1.3.2 è‡ªå®šä¹‰æ³¨è§£

```java
package com.example.empmgmt.common.annotation;

import com.example.empmgmt.common.enums.OperationType;

import java.lang.annotation.*;

/**
 * æ“ä½œæ—¥å¿—æ³¨è§£
 * ä½¿ç”¨ç¤ºä¾‹ï¼š@OperationLog(module = "å‘˜å·¥ç®¡ç†", type = OperationType.CREATE, description = "åˆ›å»ºå‘˜å·¥")
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface OperationLog {

    /**
     * æ¨¡å—åç§°
     */
    String module() default "";

    /**
     * æ“ä½œç±»å‹
     */
    OperationType type() default OperationType.OTHER;

    /**
     * æ“ä½œæè¿°
     */
    String description() default "";

    /**
     * æ˜¯å¦ä¿å­˜è¯·æ±‚å‚æ•°
     */
    boolean saveParams() default true;

    /**
     * æ˜¯å¦ä¿å­˜è¿”å›ç»“æœ
     */
    boolean saveResult() default false;
}
```

#### 1.3.3 æ“ä½œç±»å‹æšä¸¾

```java
package com.example.empmgmt.common.annotation;

/**
 * æ“ä½œç±»å‹æšä¸¾
 */
public enum OperationType {
    CREATE("æ–°å¢"),
    UPDATE("ä¿®æ”¹"),
    DELETE("åˆ é™¤"),
    QUERY("æŸ¥è¯¢"),
    EXPORT("å¯¼å‡º"),
    IMPORT("å¯¼å…¥"),
    LOGIN("ç™»å½•"),
    LOGOUT("ç™»å‡º"),
    OTHER("å…¶ä»–");

    private final String description;

    OperationType(String description) {
        this.description = description;
    }

    public String getDescription() {
        return description;
    }
}
```

#### 1.3.4 æ“ä½œæ—¥å¿—å®ä½“ç±»

```java
package com.example.empmgmt.domain;

import jakarta.persistence.*;
import lombok.Data;
import java.time.LocalDateTime;

@Entity
@Table(name = "operation_log")
@Data
public class OperationLog {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "user_id", nullable = false)
    private Long userId;
    
    @Column(name = "username", nullable = false, length = 50)
    private String username;
    
    @Column(name = "operation_type", nullable = false, length = 20)
    private String operationType;
    
    @Column(name = "module", nullable = false, length = 50)
    private String module;
    
    @Column(name = "description", length = 500)
    private String description;
    
    @Column(name = "method", length = 200)
    private String method;
    
    @Column(name = "params", columnDefinition = "TEXT")
    private String params;
    
    @Column(name = "result", columnDefinition = "TEXT")
    private String result;
    
    @Column(name = "ip_address", length = 50)
    private String ipAddress;
    
    @Column(name = "location", length = 100)
    private String location;
    
    @Column(name = "browser", length = 100)
    private String browser;
    
    @Column(name = "os", length = 100)
    private String os;
    
    @Column(name = "execution_time")
    private Long executionTime;
    
    @Column(name = "status", length = 20)
    private String status = "SUCCESS";
    
    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt = LocalDateTime.now();
}
```

#### 1.3.5 Repository æ¥å£

```java
package com.example.empmgmt.repository;

import com.example.empmgmt.domain.OperationLog;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;

public interface OperationLogRepository extends JpaRepository<OperationLog, Long> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDåˆ†é¡µæŸ¥è¯¢
     */
    Page<OperationLog> findByUserId(Long userId, Pageable pageable);
    
    /**
     * æ ¹æ®æ¨¡å—åˆ†é¡µæŸ¥è¯¢
     */
    Page<OperationLog> findByModule(String module, Pageable pageable);
    
    /**
     * æ ¹æ®æ“ä½œç±»å‹åˆ†é¡µæŸ¥è¯¢
     */
    Page<OperationLog> findByOperationType(String operationType, Pageable pageable);
}
```

#### 1.3.6 AOP åˆ‡é¢å®ç°ï¼ˆæ ¸å¿ƒï¼‰

```java
package com.example.empmgmt.common.aspect;

import com.example.empmgmt.domain.OperationLog;
import com.example.empmgmt.repository.OperationLogRepository;
import com.example.empmgmt.common.util.SecurityUtil;
import com.fasterxml.jackson.databind.ObjectMapper;
import eu.bitwalker.useragentutils.UserAgent;
import jakarta.servlet.http.HttpServletRequest;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import java.lang.reflect.Method;
import java.time.LocalDateTime;

/**
 * æ“ä½œæ—¥å¿—åˆ‡é¢
 * æ‹¦æˆªæ‰€æœ‰å¸¦æœ‰ @OperationLog æ³¨è§£çš„æ–¹æ³•
 */
@Aspect
@Component
@Slf4j
public class OperationLogAspect {

    private final OperationLogRepository operationLogRepository;
    private final ObjectMapper objectMapper;

    public OperationLogAspect(OperationLogRepository operationLogRepository,
                              ObjectMapper objectMapper) {
        this.operationLogRepository = operationLogRepository;
        this.objectMapper = objectMapper;
    }

    /**
     * ç¯ç»•é€šçŸ¥ï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰åè®°å½•æ—¥å¿—
     */
    @Around("@annotation(com.example.empmgmt.common.annotation.OperationLog)")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();

        // è·å–æ³¨è§£ä¿¡æ¯
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();
        OperationLog annotation = method.getAnnotation(OperationLog.class);

        // åˆ›å»ºæ—¥å¿—å¯¹è±¡
        OperationLog log = new OperationLog();

        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        try {
            Long userId = SecurityUtil.getCurrentUserId();
            String username = SecurityUtil.getCurrentUsername();
            log.setUserId(userId);
            log.setUsername(username);
        } catch (Exception e) {
            log.setUserId(0L);
            log.setUsername("anonymous");
        }

        // è®¾ç½®æ“ä½œä¿¡æ¯
        log.setModule(annotation.module());
        log.setOperationType(annotation.type().name());
        log.setDescription(annotation.description());
        log.setMethod(method.getDeclaringClass().getName() + "." + method.getName());

        // è·å–è¯·æ±‚ä¿¡æ¯
        HttpServletRequest request = getHttpServletRequest();
        if (request != null) {
            log.setIpAddress(getIpAddress(request));

            // è§£æ User-Agent
            String userAgentStr = request.getHeader("User-Agent");
            UserAgent userAgent = UserAgent.parseUserAgentString(userAgentStr);
            log.setBrowser(userAgent.getBrowser().getName());
            log.setOs(userAgent.getOperatingSystem().getName());
        }

        // ä¿å­˜è¯·æ±‚å‚æ•°
        if (annotation.saveParams()) {
            try {
                Object[] args = joinPoint.getArgs();
                log.setParams(objectMapper.writeValueAsString(args));
            } catch (Exception e) {
                log.setParams("å‚æ•°åºåˆ—åŒ–å¤±è´¥: " + e.getMessage());
            }
        }

        Object result = null;
        try {
            // æ‰§è¡Œç›®æ ‡æ–¹æ³•
            result = joinPoint.proceed();
            log.setStatus("SUCCESS");

            // ä¿å­˜è¿”å›ç»“æœ
            if (annotation.saveResult() && result != null) {
                try {
                    log.setResult(objectMapper.writeValueAsString(result));
                } catch (Exception e) {
                    log.setResult("ç»“æœåºåˆ—åŒ–å¤±è´¥: " + e.getMessage());
                }
            }

        } catch (Exception e) {
            log.setStatus("FAILURE");
            log.setErrorMessage(e.getMessage());
            throw e;
        } finally {
            // è®¡ç®—æ‰§è¡Œè€—æ—¶
            long endTime = System.currentTimeMillis();
            log.setExecutionTime(endTime - startTime);
            log.setCreatedAt(LocalDateTime.now());

            // å¼‚æ­¥ä¿å­˜æ—¥å¿—ï¼ˆé¿å…å½±å“ä¸šåŠ¡æ€§èƒ½ï¼‰
            saveLogAsync(log);
        }

        return result;
    }

    /**
     * å¼‚æ­¥ä¿å­˜æ—¥å¿—
     */
    private void saveLogAsync(OperationLog log) {
        try {
            operationLogRepository.save(log);
        } catch (Exception e) {
            log.error("ä¿å­˜æ“ä½œæ—¥å¿—å¤±è´¥", e);
        }
    }

    /**
     * è·å– HttpServletRequest
     */
    private HttpServletRequest getHttpServletRequest() {
        ServletRequestAttributes attributes =
                (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        return attributes != null ? attributes.getRequest() : null;
    }

    /**
     * è·å–çœŸå®IPåœ°å€
     */
    private String getIpAddress(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}
```

#### 1.3.7 ä½¿ç”¨ç¤ºä¾‹

åœ¨ `EmployeeController.java` ä¸­æ·»åŠ æ³¨è§£ï¼š

```java
@PostMapping
@OperationLog(
    module = "å‘˜å·¥ç®¡ç†", 
    type = OperationType.CREATE, 
    description = "åˆ›å»ºå‘˜å·¥",
    saveParams = true
)
public Result<EmployeeResponse> create(
        @Valid @RequestBody EmployeeCreateRequest request
){
    EmployeeResponse response = employeeService.create(request);
    return Result.success(response);
}

@PutMapping("/{id}")
@OperationLog(
    module = "å‘˜å·¥ç®¡ç†", 
    type = OperationType.UPDATE, 
    description = "æ›´æ–°å‘˜å·¥ä¿¡æ¯",
    saveParams = true
)
public Result<EmployeeResponse> update(
        @PathVariable Long id,
        @Valid @RequestBody EmployeeUpdateRequest request
){
    EmployeeResponse response = employeeService.update(id, request);
    return Result.success(response);
}

@DeleteMapping("/{id}")
@OperationLog(
    module = "å‘˜å·¥ç®¡ç†", 
    type = OperationType.DELETE, 
    description = "åˆ é™¤å‘˜å·¥"
)
public Result<Void> delete(@PathVariable Long id){
    employeeService.delete(id);
    return Result.success(null);
}
```

#### 1.3.8 æ—¥å¿—æŸ¥è¯¢ Controller

```java
package com.example.empmgmt.controller;

import com.example.empmgmt.domain.OperationLog;
import com.example.empmgmt.dto.response.PageResponse;
import com.example.empmgmt.dto.response.Result;
import com.example.empmgmt.repository.OperationLogRepository;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/logs")
public class OperationLogController {
    
    private final OperationLogRepository logRepository;
    
    public OperationLogController(OperationLogRepository logRepository) {
        this.logRepository = logRepository;
    }
    
    /**
     * åˆ†é¡µæŸ¥è¯¢æ“ä½œæ—¥å¿—
     */
    @GetMapping
    public Result<PageResponse<OperationLog>> list(
            @RequestParam(required = false) String module,
            @RequestParam(required = false) String operationType,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size
    ) {
        Pageable pageable = PageRequest.of(
            page - 1, 
            size, 
            Sort.by(Sort.Direction.DESC, "createdAt")
        );
        
        Page<OperationLog> logPage;
        if (module != null && !module.isBlank()) {
            logPage = logRepository.findByModule(module, pageable);
        } else if (operationType != null && !operationType.isBlank()) {
            logPage = logRepository.findByOperationType(operationType, pageable);
        } else {
            logPage = logRepository.findAll(pageable);
        }
        
        return Result.success(PageResponse.of(logPage));
    }
}
```

### 1.4 å‰ç«¯å®ç°

#### 1.4.1 ç±»å‹å®šä¹‰

```typescript
// frontend/src/types/log.ts
export interface OperationLog {
  id: number
  userId: number
  username: string
  operationType: string
  module: string
  description: string
  method: string
  params?: string
  result?: string
  ipAddress: string
  location?: string
  browser: string
  os: string
  executionTime: number
  status: string
  errorMessage?: string
  createdAt: string
}
```

#### 1.4.2 API å®šä¹‰

```typescript
// frontend/src/api/log.ts
import request from '../utils/request'
import type { OperationLog } from '../types/log'

export const getOperationLogs = (
  module?: string,
  operationType?: string,
  page: number = 1,
  size: number = 10
): Promise<PageResponse<OperationLog>> => {
  const params: any = { page, size }
  if (module) params.module = module
  if (operationType) params.operationType = operationType
  
  return request.get('/logs', { params })
}
```

#### 1.4.3 æ—¥å¿—åˆ—è¡¨é¡µé¢

```tsx
// frontend/src/pages/OperationLogs.tsx
import React, { useState, useEffect } from 'react'
import { Table, Card, Select, Space, Tag } from 'antd'
import { getOperationLogs } from '../api/log'
import type { OperationLog } from '../types/log'

const { Option } = Select

const OperationLogs: React.FC = () => {
  const [logs, setLogs] = useState<OperationLog[]>([])
  const [loading, setLoading] = useState(false)
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0,
  })
  const [filters, setFilters] = useState({
    module: '',
    operationType: '',
  })

  useEffect(() => {
    loadLogs()
  }, [pagination.current, filters])

  const loadLogs = async () => {
    setLoading(true)
    try {
      const res = await getOperationLogs(
        filters.module,
        filters.operationType,
        pagination.current,
        pagination.pageSize
      )
      setLogs(res.content)
      setPagination({
        ...pagination,
        total: res.totalElements,
      })
    } catch (error) {
      console.error('åŠ è½½æ—¥å¿—å¤±è´¥', error)
    } finally {
      setLoading(false)
    }
  }

  const columns = [
    {
      title: 'ID',
      dataIndex: 'id',
      key: 'id',
      width: 80,
    },
    {
      title: 'æ“ä½œäºº',
      dataIndex: 'username',
      key: 'username',
    },
    {
      title: 'æ¨¡å—',
      dataIndex: 'module',
      key: 'module',
    },
    {
      title: 'æ“ä½œç±»å‹',
      dataIndex: 'operationType',
      key: 'operationType',
      render: (type: string) => {
        const colorMap: any = {
          CREATE: 'green',
          UPDATE: 'blue',
          DELETE: 'red',
          QUERY: 'default',
        }
        return <Tag color={colorMap[type] || 'default'}>{type}</Tag>
      },
    },
    {
      title: 'æè¿°',
      dataIndex: 'description',
      key: 'description',
    },
    {
      title: 'IPåœ°å€',
      dataIndex: 'ipAddress',
      key: 'ipAddress',
    },
    {
      title: 'è€—æ—¶',
      dataIndex: 'executionTime',
      key: 'executionTime',
      render: (time: number) => `${time}ms`,
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => (
        <Tag color={status === 'SUCCESS' ? 'success' : 'error'}>
          {status}
        </Tag>
      ),
    },
    {
      title: 'æ“ä½œæ—¶é—´',
      dataIndex: 'createdAt',
      key: 'createdAt',
    },
  ]

  return (
    <Card
      title="æ“ä½œæ—¥å¿—"
      extra={
        <Space>
          <Select
            placeholder="é€‰æ‹©æ¨¡å—"
            style={{ width: 120 }}
            allowClear
            onChange={(value) => setFilters({ ...filters, module: value || '' })}
          >
            <Option value="å‘˜å·¥ç®¡ç†">å‘˜å·¥ç®¡ç†</Option>
            <Option value="ç”¨æˆ·ç®¡ç†">ç”¨æˆ·ç®¡ç†</Option>
          </Select>
          <Select
            placeholder="æ“ä½œç±»å‹"
            style={{ width: 120 }}
            allowClear
            onChange={(value) => setFilters({ ...filters, operationType: value || '' })}
          >
            <Option value="CREATE">æ–°å¢</Option>
            <Option value="UPDATE">ä¿®æ”¹</Option>
            <Option value="DELETE">åˆ é™¤</Option>
          </Select>
        </Space>
      }
    >
      <Table
        columns={columns}
        dataSource={logs}
        rowKey="id"
        loading={loading}
        pagination={{
          ...pagination,
          onChange: (page) => setPagination({ ...pagination, current: page }),
        }}
      />
    </Card>
  )
}

export default OperationLogs
```

---

## äºŒã€ä¸‰çº§æƒé™ç®¡ç†ç³»ç»Ÿ

### 2.1 æƒé™è®¾è®¡æ€è·¯

#### æƒé™ç­‰çº§ï¼š
é™ç­‰çº§ï¼š
1. **è¶…çº§ç®¡ç†å‘˜ï¼ˆSUPER_ADMINï¼‰**
   - æ‹¥æœ‰æ‰€æœ‰æƒé™
   - å¯ä»¥ç®¡ç†ç”¨æˆ·ã€åˆ†é…è§’è‰²
   - å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—

2. **éƒ¨é—¨ç»ç†ï¼ˆMANAGERï¼‰**
   - åªèƒ½ç®¡ç†æœ¬éƒ¨é—¨å‘˜å·¥
   - å¯ä»¥æŸ¥çœ‹æœ¬éƒ¨é—¨ç»Ÿè®¡æ•°æ®
   - å¯ä»¥å¯¼å‡ºæœ¬éƒ¨é—¨å‘˜å·¥æ•°æ®

3. **æ™®é€šå‘˜å·¥ï¼ˆEMPLOYEEï¼‰**
   - åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
   - å¯ä»¥ä¿®æ”¹éƒ¨åˆ†ä¸ªäººä¿¡æ¯ï¼ˆä¸åŒ…æ‹¬è–ªèµ„ï¼‰
   - ä¸èƒ½åˆ é™¤æ•°æ®

### 2.2 æ•°æ®åº“è®¾è®¡

```sql
-- 1. ç”¨æˆ·è¡¨å¢åŠ è§’è‰²å­—æ®µ
ALTER TABLE user_account ADD COLUMN role VARCHAR(20) DEFAULT 'EMPLOYEE';
ALTER TABLE user_account ADD COLUMN department VARCHAR(50);
COMMENT ON COLUMN user_account.role IS 'ç”¨æˆ·è§’è‰²ï¼šSUPER_ADMIN/MANAGER/EMPLOYEE';

-- æ›´æ–°ç°æœ‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜ï¼ˆç¤ºä¾‹ï¼‰
UPDATE user_account SET role = 'SUPER_ADMIN' WHERE username = 'admin';

-- 2. åˆ›å»ºè§’è‰²æƒé™æ˜ å°„è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºæ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼‰
CREATE TABLE role_permission (
    id BIGSERIAL PRIMARY KEY,
    role VARCHAR(20) NOT NULL,
    permission VARCHAR(100) NOT NULL,
    description VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(role, permission)
);

-- æ’å…¥é»˜è®¤æƒé™
INSERT INTO role_permission (role, permission, description) VALUES
-- è¶…çº§ç®¡ç†å‘˜æƒé™
('SUPER_ADMIN', 'employee:create', 'åˆ›å»ºå‘˜å·¥'),
('SUPER_ADMIN', 'employee:update', 'æ›´æ–°å‘˜å·¥'),
('SUPER_ADMIN', 'employee:delete', 'åˆ é™¤å‘˜å·¥'),
('SUPER_ADMIN', 'employee:view:all', 'æŸ¥çœ‹æ‰€æœ‰å‘˜å·¥'),
('SUPER_ADMIN', 'employee:export', 'å¯¼å‡ºå‘˜å·¥æ•°æ®'),
('SUPER_ADMIN', 'employee:import', 'å¯¼å…¥å‘˜å·¥æ•°æ®'),
('SUPER_ADMIN', 'log:view', 'æŸ¥çœ‹æ“ä½œæ—¥å¿—'),
('SUPER_ADMIN', 'user:manage', 'ç®¡ç†ç”¨æˆ·'),

-- éƒ¨é—¨ç»ç†æƒé™
('MANAGER', 'employee:create', 'åˆ›å»ºå‘˜å·¥'),
('MANAGER', 'employee:update', 'æ›´æ–°å‘˜å·¥'),
('MANAGER', 'employee:view:department', 'æŸ¥çœ‹æœ¬éƒ¨é—¨å‘˜å·¥'),
('MANAGER', 'employee:export:department', 'å¯¼å‡ºæœ¬éƒ¨é—¨æ•°æ®'),

-- æ™®é€šå‘˜å·¥æƒé™
('EMPLOYEE', 'employee:view:self', 'æŸ¥çœ‹è‡ªå·±ä¿¡æ¯'),
('EMPLOYEE', 'employee:update:self', 'æ›´æ–°è‡ªå·±ä¿¡æ¯ï¼ˆé™åˆ¶å­—æ®µï¼‰');
```

### 2.3 åç«¯å®ç°

#### 2.3.1 è§’è‰²æšä¸¾

```java
package com.example.empmgmt.enums;

/**
 * ç”¨æˆ·è§’è‰²æšä¸¾
 */
public enum UserRole {
    SUPER_ADMIN("è¶…çº§ç®¡ç†å‘˜", 1),
    MANAGER("éƒ¨é—¨ç»ç†", 2),
    EMPLOYEE("æ™®é€šå‘˜å·¥", 3);
    
    private final String description;
    private final int level;
    
    UserRole(String description, int level) {
        this.description = description;
        this.level = level;
    }
    
    public String getDescription() {
        return description;
    }
    
    public int getLevel() {
        return level;
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æƒé™
     */
    public boolean hasPermission(UserRole required) {
        return this.level <= required.level;
    }
}
```

#### 2.3.2 æƒé™æ³¨è§£

```java
package com.example.empmgmt.common.annotation;

import com.example.empmgmt.enums.UserRole;

import java.lang.annotation.*;

/**
 * æƒé™æ ¡éªŒæ³¨è§£
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RequireRole {

    /**
     * éœ€è¦çš„è§’è‰²ï¼ˆæ»¡è¶³å…¶ä¸­ä¹‹ä¸€å³å¯ï¼‰
     */
    UserRole[] value();

    /**
     * é”™è¯¯æç¤ºä¿¡æ¯
     */
    String message() default "æƒé™ä¸è¶³";
}
```

#### 2.3.3 æƒé™æ ¡éªŒåˆ‡é¢

```java
package com.example.empmgmt.common.aspect;

import com.example.empmgmt.common.annotation.RequireRole;
import com.example.empmgmt.enums.UserRole;
import com.example.empmgmt.exception.BusinessException;
import com.example.empmgmt.common.util.SecurityUtil;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.stereotype.Component;

import java.lang.reflect.Method;
import java.util.Arrays;

/**
 * æƒé™æ ¡éªŒåˆ‡é¢
 */
@Aspect
@Component
@Slf4j
public class PermissionAspect {

    @Around("@annotation(com.example.empmgmt.common.annotation.RequireRole)")
    public Object checkPermission(ProceedingJoinPoint joinPoint) throws Throwable {
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();
        RequireRole annotation = method.getAnnotation(RequireRole.class);

        // è·å–å½“å‰ç”¨æˆ·è§’è‰²
        String currentRoleStr = SecurityUtil.getCurrentUserRole();
        UserRole currentRole = UserRole.valueOf(currentRoleStr);

        // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™
        UserRole[] requiredRoles = annotation.value();
        boolean hasPermission = Arrays.stream(requiredRoles)
                .anyMatch(role -> currentRole.hasPermission(role));

        if (!hasPermission) {
            log.warn("æƒé™ä¸è¶³: ç”¨æˆ·è§’è‰²={}, éœ€è¦è§’è‰²={}", currentRole, Arrays.toString(requiredRoles));
            throw new BusinessException(annotation.message());
        }

        return joinPoint.proceed();
    }
}
```

#### 2.3.4 SecurityUtil æ‰©å±•

```java
package com.example.empmgmt.common.util;

import com.example.empmgmt.security.UserAuthentication;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;

public class SecurityUtil {

    public static Long getCurrentUserId() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication instanceof UserAuthentication) {
            return ((UserAuthentication) authentication).getUserId();
        }
        return null;
    }

    public static String getCurrentUsername() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication != null) {
            return authentication.getName();
        }
        return null;
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·è§’è‰²
     */
    public static String getCurrentUserRole() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication instanceof UserAuthentication) {
            return ((UserAuthentication) authentication).getRole();
        }
        return "EMPLOYEE"; // é»˜è®¤è§’è‰²
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·éƒ¨é—¨
     */
    public static String getCurrentUserDepartment() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication instanceof UserAuthentication) {
            return ((UserAuthentication) authentication).getDepartment();
        }
        return null;
    }
}
```

#### 2.3.5 UserAuthentication æ‰©å±•

```java
package com.example.empmgmt.security;

import lombok.Getter;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;

import java.util.Collection;
import java.util.Collections;

@Getter
public class UserAuthentication implements Authentication {
    
    private final Long userId;
    private final String username;
    private final String role;        // æ–°å¢
    private final String department;  // æ–°å¢
    private boolean authenticated = true;
    
    public UserAuthentication(Long userId, String username, String role, String department) {
        this.userId = userId;
        this.username = username;
        this.role = role;
        this.department = department;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return Collections.emptyList();
    }
    
    @Override
    public Object getCredentials() {
        return null;
    }
    
    @Override
    public Object getDetails() {
        return null;
    }
    
    @Override
    public Object getPrincipal() {
        return username;
    }
    
    @Override
    public boolean isAuthenticated() {
        return authenticated;
    }
    
    @Override
    public void setAuthenticated(boolean isAuthenticated) {
        this.authenticated = isAuthenticated;
    }
    
    @Override
    public String getName() {
        return username;
    }
}
```

#### 2.3.6 ä½¿ç”¨ç¤ºä¾‹

```java
// åœ¨ EmployeeController ä¸­æ·»åŠ æƒé™æ§åˆ¶

@GetMapping
@RequireRole({UserRole.SUPER_ADMIN, UserRole.MANAGER})
public Result<PageResponse<EmployeeResponse>> list(
        @RequestParam(required = false) String name,
        @RequestParam(required = false) String department,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size
) {
    // å¦‚æœæ˜¯éƒ¨é—¨ç»ç†ï¼Œåªèƒ½æŸ¥çœ‹æœ¬éƒ¨é—¨
    String currentRole = SecurityUtil.getCurrentUserRole();
    if ("MANAGER".equals(currentRole)) {
        department = SecurityUtil.getCurrentUserDepartment();
    }
    
    PageResponse<EmployeeResponse> pageResult = 
        employeeService.pageQuery(name, department, page, size);
    return Result.success(pageResult);
}

@DeleteMapping("/{id}")
@RequireRole(UserRole.SUPER_ADMIN)
@OperationLog(module = "å‘˜å·¥ç®¡ç†", type = OperationType.DELETE, description = "åˆ é™¤å‘˜å·¥")
public Result<Void> delete(@PathVariable Long id){
    employeeService.delete(id);
    return Result.success(null);
}
```

### 2.4 å‰ç«¯å®ç°

#### 2.4.1 æƒé™ç®¡ç† Hook

```typescript
// frontend/src/hooks/usePermission.ts
import { useEffect, useState } from 'react'

export enum UserRole {
  SUPER_ADMIN = 'SUPER_ADMIN',
  MANAGER = 'MANAGER',
  EMPLOYEE = 'EMPLOYEE',
}

export const usePermission = () => {
  const [role, setRole] = useState<UserRole>(UserRole.EMPLOYEE)

  useEffect(() => {
    // ä» localStorage æˆ– API è·å–ç”¨æˆ·è§’è‰²
    const userRole = localStorage.getItem('userRole') as UserRole
    if (userRole) {
      setRole(userRole)
    }
  }, [])

  const hasPermission = (requiredRoles: UserRole[]): boolean => {
    return requiredRoles.includes(role)
  }

  const isSuperAdmin = () => role === UserRole.SUPER_ADMIN
  const isManager = () => role === UserRole.MANAGER
  const isEmployee = () => role === UserRole.EMPLOYEE

  return {
    role,
    hasPermission,
    isSuperAdmin,
    isManager,
    isEmployee,
  }
}
```

#### 2.4.2 æƒé™æ§åˆ¶ç»„ä»¶

```tsx
// frontend/src/components/PermissionGuard.tsx
import React from 'react'
import { usePermission, UserRole } from '../hooks/usePermission'

interface PermissionGuardProps {
  roles: UserRole[]
  children: React.ReactNode
  fallback?: React.ReactNode
}

const PermissionGuard: React.FC<PermissionGuardProps> = ({ 
  roles, 
  children, 
  fallback = null 
}) => {
  const { hasPermission } = usePermission()

  if (!hasPermission(roles)) {
    return <>{fallback}</>
  }

  return <>{children}</>
}

export default PermissionGuard
```

#### 2.4.3 ä½¿ç”¨ç¤ºä¾‹

```tsx
// åœ¨å‘˜å·¥åˆ—è¡¨ä¸­æ ¹æ®æƒé™æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
import PermissionGuard from '../components/PermissionGuard'
import { UserRole } from '../hooks/usePermission'

// åªæœ‰è¶…çº§ç®¡ç†å‘˜èƒ½çœ‹åˆ°åˆ é™¤æŒ‰é’®
<PermissionGuard roles={[UserRole.SUPER_ADMIN]}>
  <Button 
    danger 
    onClick={() => handleDelete(record.id)}
  >
    åˆ é™¤
  </Button>
</PermissionGuard>

// ç®¡ç†å‘˜å’Œç»ç†éƒ½èƒ½ç¼–è¾‘
<PermissionGuard roles={[UserRole.SUPER_ADMIN, UserRole.MANAGER]}>
  <Button onClick={() => navigate(`/employees/edit/${record.id}`)}>
    ç¼–è¾‘
  </Button>
</PermissionGuard>
```

---

## ä¸‰ã€Excel æ•°æ®å¯¼å…¥å¯¼å‡º

### 3.1 åŠŸèƒ½åœºæ™¯è®¾è®¡

#### åœºæ™¯ 1ï¼šæ‰¹é‡å¯¼å…¥æ–°å‘˜å·¥
- **ä½¿ç”¨åœºæ™¯**ï¼šå…¬å¸æ ¡å›­æ‹›è˜ï¼ŒHR æœ‰ 100 ä¸ªæ–°å‘˜å·¥çš„ Excel è¡¨æ ¼éœ€è¦æ‰¹é‡å¯¼å…¥
- **åŠŸèƒ½è¦ç‚¹**ï¼š
  - ä¸‹è½½æ ‡å‡†æ¨¡æ¿
  - æ•°æ®æ ¡éªŒï¼ˆå¿…å¡«é¡¹ã€æ ¼å¼æ£€æŸ¥ï¼‰
  - é”™è¯¯æç¤ºï¼ˆç¬¬å‡ è¡Œæ•°æ®æœ‰é—®é¢˜ï¼‰
  - å¯¼å…¥æˆåŠŸåæ˜¾ç¤ºç»Ÿè®¡ï¼ˆæˆåŠŸ X æ¡ï¼Œå¤±è´¥ Y æ¡ï¼‰

#### åœºæ™¯ 2ï¼šå¯¼å‡ºå‘˜å·¥æ•°æ®
- **ä½¿ç”¨åœºæ™¯**ï¼šæœˆåº•äººäº‹éœ€è¦å¯¼å‡ºæ‰€æœ‰å‘˜å·¥æ•°æ®æŠ¥è¡¨
- **åŠŸèƒ½è¦ç‚¹**ï¼š
  - æ”¯æŒç­›é€‰å¯¼å‡ºï¼ˆæŒ‰éƒ¨é—¨ã€æ—¥æœŸèŒƒå›´ï¼‰
  - åŒ…å«å¤´åƒé“¾æ¥
  - æ ¼å¼åŒ–å±•ç¤ºï¼ˆæ—¥æœŸã€é‡‘é¢ï¼‰

### 3.2 åç«¯å®ç°

#### 3.2.1 æ·»åŠ ä¾èµ–

```xml
<!-- EasyExcel -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>easyexcel</artifactId>
    <version>3.3.2</version>
</dependency>
```

#### 3.2.2 Excel DTO

```java
package com.example.empmgmt.dto.excel;

import com.alibaba.excel.annotation.ExcelProperty;
import com.alibaba.excel.annotation.write.style.ColumnWidth;
import com.alibaba.excel.annotation.write.style.ContentRowHeight;
import com.alibaba.excel.annotation.write.style.HeadRowHeight;
import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDate;

/**
 * å‘˜å·¥Excelå¯¼å…¥å¯¼å‡ºDTO
 */
@Data
@ContentRowHeight(20)
@HeadRowHeight(25)
public class EmployeeExcelDTO {
    
    @ExcelProperty(value = "å§“å", index = 0)
    @ColumnWidth(15)
    private String name;
    
    @ExcelProperty(value = "æ€§åˆ«", index = 1)
    @ColumnWidth(10)
    private String gender;
    
    @ExcelProperty(value = "å¹´é¾„", index = 2)
    @ColumnWidth(10)
    private Integer age;
    
    @ExcelProperty(value = "éƒ¨é—¨", index = 3)
    @ColumnWidth(15)
    private String department;
    
    @ExcelProperty(value = "èŒä½", index = 4)
    @ColumnWidth(15)
    private String position;
    
    @ExcelProperty(value = "å…¥èŒæ—¥æœŸ", index = 5)
    @ColumnWidth(15)
    private String hireDate; // æ ¼å¼ï¼š2024-01-01
    
    @ExcelProperty(value = "è–ªèµ„", index = 6)
    @ColumnWidth(15)
    private BigDecimal salary;
    
    @ExcelProperty(value = "å¤´åƒURL", index = 7)
    @ColumnWidth(50)
    private String avatar;
}
```

#### 3.2.3 Excel ç›‘å¬å™¨ï¼ˆç”¨äºå¯¼å…¥ï¼‰

```java
package com.example.empmgmt.listener;

import com.alibaba.excel.context.AnalysisContext;
import com.alibaba.excel.event.AnalysisEventListener;
import com.example.empmgmt.dto.excel.EmployeeExcelDTO;
import com.example.empmgmt.dto.request.EmployeeCreateRequest;
import com.example.empmgmt.service.EmployeeService;
import lombok.extern.slf4j.Slf4j;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

/**
 * Excel æ•°æ®è¯»å–ç›‘å¬å™¨
 */
@Slf4j
public class EmployeeExcelListener extends AnalysisEventListener<EmployeeExcelDTO> {
    
    private final EmployeeService employeeService;
    private final List<String> errorMessages = new ArrayList<>();
    private int successCount = 0;
    private int errorCount = 0;
    private int currentRow = 1; // ä»ç¬¬1è¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
    
    public EmployeeExcelListener(EmployeeService employeeService) {
        this.employeeService = employeeService;
    }
    
    /**
     * æ¯è¯»å–ä¸€è¡Œæ•°æ®å°±ä¼šè°ƒç”¨æ­¤æ–¹æ³•
     */
    @Override
    public void invoke(EmployeeExcelDTO data, AnalysisContext context) {
        currentRow++;
        try {
            // æ•°æ®æ ¡éªŒ
            validateData(data, currentRow);
            
            // è½¬æ¢ä¸ºåˆ›å»ºè¯·æ±‚
            EmployeeCreateRequest request = convertToRequest(data);
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            employeeService.create(request);
            successCount++;
            
        } catch (Exception e) {
            errorCount++;
            String errorMsg = String.format("ç¬¬%dè¡Œï¼š%s", currentRow, e.getMessage());
            errorMessages.add(errorMsg);
            log.error(errorMsg, e);
        }
    }
    
    /**
     * æ‰€æœ‰æ•°æ®è§£æå®Œæˆåè°ƒç”¨
     */
    @Override
    public void doAfterAllAnalysed(AnalysisContext context) {
        log.info("Excelæ•°æ®å¯¼å…¥å®Œæˆã€‚æˆåŠŸï¼š{}ï¼Œå¤±è´¥ï¼š{}", successCount, errorCount);
    }
    
    /**
     * æ•°æ®æ ¡éªŒ
     */
    private void validateData(EmployeeExcelDTO data, int row) {
        if (data.getName() == null || data.getName().isBlank()) {
            throw new IllegalArgumentException("å§“åä¸èƒ½ä¸ºç©º");
        }
        if (data.getDepartment() == null || data.getDepartment().isBlank()) {
            throw new IllegalArgumentException("éƒ¨é—¨ä¸èƒ½ä¸ºç©º");
        }
        if (data.getHireDate() == null || data.getHireDate().isBlank()) {
            throw new IllegalArgumentException("å…¥èŒæ—¥æœŸä¸èƒ½ä¸ºç©º");
        }
        if (data.getSalary() == null || data.getSalary().compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("è–ªèµ„å¿…é¡»å¤§äº0");
        }
    }
    
    /**
     * è½¬æ¢ä¸ºåˆ›å»ºè¯·æ±‚
     */
    private EmployeeCreateRequest convertToRequest(EmployeeExcelDTO data) {
        return new EmployeeCreateRequest(
            data.getName(),
            data.getGender(),
            data.getAge(),
            data.getDepartment(),
            data.getPosition(),
            LocalDate.parse(data.getHireDate()),
            data.getSalary(),
            data.getAvatar()
        );
    }
    
    public List<String> getErrorMessages() {
        return errorMessages;
    }
    
    public int getSuccessCount() {
        return successCount;
    }
    
    public int getErrorCount() {
        return errorCount;
    }
}
```

#### 3.2.4 Excel å¯¼å…¥å¯¼å‡º Service

```java
package com.example.empmgmt.service;

import com.alibaba.excel.EasyExcel;
import com.example.empmgmt.domain.Employee;
import com.example.empmgmt.dto.excel.EmployeeExcelDTO;
import com.example.empmgmt.listener.EmployeeExcelListener;
import com.example.empmgmt.repository.EmployeeRepository;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@Slf4j
public class ExcelService {
    
    private final EmployeeService employeeService;
    private final EmployeeRepository employeeRepository;
    
    public ExcelService(EmployeeService employeeService, 
                       EmployeeRepository employeeRepository) {
        this.employeeService = employeeService;
        this.employeeRepository = employeeRepository;
    }
    
    /**
     * å¯¼å…¥Excel
     */
    public Map<String, Object> importExcel(MultipartFile file) throws IOException {
        EmployeeExcelListener listener = new EmployeeExcelListener(employeeService);
        
        EasyExcel.read(file.getInputStream(), EmployeeExcelDTO.class, listener)
                .sheet()
                .doRead();
        
        Map<String, Object> result = new HashMap<>();
        result.put("successCount", listener.getSuccessCount());
        result.put("errorCount", listener.getErrorCount());
        result.put("errorMessages", listener.getErrorMessages());
        
        return result;
    }
    
    /**
     * å¯¼å‡ºExcel
     */
    public void exportExcel(HttpServletResponse response, 
                           String department) throws IOException {
        // è®¾ç½®å“åº”å¤´
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setCharacterEncoding("utf-8");
        String fileName = URLEncoder.encode("å‘˜å·¥æ•°æ®", StandardCharsets.UTF_8)
                .replaceAll("\\+", "%20");
        response.setHeader("Content-disposition", 
            "attachment;filename*=utf-8''" + fileName + ".xlsx");
        
        // æŸ¥è¯¢æ•°æ®
        List<Employee> employees;
        if (department != null && !department.isBlank()) {
            employees = employeeRepository.findByDepartmentAndDeletedFalse(department);
        } else {
            employees = employeeRepository.findAllByDeletedFalse();
        }
        
        // è½¬æ¢ä¸ºDTO
        List<EmployeeExcelDTO> excelData = employees.stream()
                .map(this::convertToExcelDTO)
                .collect(Collectors.toList());
        
        // å†™å…¥Excel
        EasyExcel.write(response.getOutputStream(), EmployeeExcelDTO.class)
                .sheet("å‘˜å·¥æ•°æ®")
                .doWrite(excelData);
    }
    
    /**
     * ä¸‹è½½å¯¼å…¥æ¨¡æ¿
     */
    public void downloadTemplate(HttpServletResponse response) throws IOException {
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setCharacterEncoding("utf-8");
        String fileName = URLEncoder.encode("å‘˜å·¥å¯¼å…¥æ¨¡æ¿", StandardCharsets.UTF_8)
                .replaceAll("\\+", "%20");
        response.setHeader("Content-disposition", 
            "attachment;filename*=utf-8''" + fileName + ".xlsx");
        
        // åˆ›å»ºç¤ºä¾‹æ•°æ®
        List<EmployeeExcelDTO> templateData = List.of(
            createSampleData("å¼ ä¸‰", "M", 28, "æŠ€æœ¯éƒ¨", "Javaå·¥ç¨‹å¸ˆ", "2024-01-15", "12000"),
            createSampleData("æå››", "F", 25, "äº§å“éƒ¨", "äº§å“ç»ç†", "2024-02-01", "15000")
        );
        
        EasyExcel.write(response.getOutputStream(), EmployeeExcelDTO.class)
                .sheet("å‘˜å·¥æ•°æ®æ¨¡æ¿")
                .doWrite(templateData);
    }
    
    private EmployeeExcelDTO convertToExcelDTO(Employee employee) {
        EmployeeExcelDTO dto = new EmployeeExcelDTO();
        dto.setName(employee.getName());
        dto.setGender(employee.getGender());
        dto.setAge(employee.getAge());
        dto.setDepartment(employee.getDepartment());
        dto.setPosition(employee.getPosition());
        dto.setHireDate(employee.getHireDate().toString());
        dto.setSalary(employee.getSalary());
        dto.setAvatar(employee.getAvatar());
        return dto;
    }
    
    private EmployeeExcelDTO createSampleData(String name, String gender, int age,
                                              String dept, String position, 
                                              String hireDate, String salary) {
        EmployeeExcelDTO dto = new EmployeeExcelDTO();
        dto.setName(name);
        dto.setGender(gender);
        dto.setAge(age);
        dto.setDepartment(dept);
        dto.setPosition(position);
        dto.setHireDate(hireDate);
        dto.setSalary(new java.math.BigDecimal(salary));
        return dto;
    }
}
```

#### 3.2.5 Excel Controller

```java
package com.example.empmgmt.controller;

import com.example.empmgmt.common.enums.OperationType;
import com.example.empmgmt.common.annotation.RequireRole;
import com.example.empmgmt.dto.response.Result;
import com.example.empmgmt.enums.UserRole;
import com.example.empmgmt.service.ExcelService;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.Map;

@RestController
@RequestMapping("/api/excel")
public class ExcelController {

    private final ExcelService excelService;

    public ExcelController(ExcelService excelService) {
        this.excelService = excelService;
    }

    /**
     * å¯¼å…¥Excel
     */
    @PostMapping("/import")
    @RequireRole({UserRole.SUPER_ADMIN, UserRole.MANAGER})
    @OperationLog(
            module = "å‘˜å·¥ç®¡ç†",
            type = OperationType.IMPORT,
            description = "æ‰¹é‡å¯¼å…¥å‘˜å·¥",
            saveParams = false
    )
    public Result<Map<String, Object>> importExcel(
            @RequestParam("file") MultipartFile file
    ) throws IOException {
        Map<String, Object> result = excelService.importExcel(file);
        return Result.success(result);
    }

    /**
     * å¯¼å‡ºExcel
     */
    @GetMapping("/export")
    @RequireRole({UserRole.SUPER_ADMIN, UserRole.MANAGER})
    @OperationLog(
            module = "å‘˜å·¥ç®¡ç†",
            type = OperationType.EXPORT,
            description = "å¯¼å‡ºå‘˜å·¥æ•°æ®"
    )
    public void exportExcel(
            HttpServletResponse response,
            @RequestParam(required = false) String department
    ) throws IOException {
        excelService.exportExcel(response, department);
    }

    /**
     * ä¸‹è½½å¯¼å…¥æ¨¡æ¿
     */
    @GetMapping("/template")
    public void downloadTemplate(HttpServletResponse response) throws IOException {
        excelService.downloadTemplate(response);
    }
}
```

### 3.3 å‰ç«¯å®ç°

#### 3.3.1 API å®šä¹‰

```typescript
// frontend/src/api/excel.ts
import request from '../utils/request'

/**
 * å¯¼å…¥Excel
 */
export const importExcel = (file: File): Promise<any> => {
  const formData = new FormData()
  formData.append('file', file)
  return request.post('/excel/import', formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  })
}

/**
 * å¯¼å‡ºExcel
 */
export const exportExcel = (department?: string) => {
  const params = department ? `?department=${department}` : ''
  window.open(`http://localhost:8080/api/excel/export${params}`, '_blank')
}

/**
 * ä¸‹è½½æ¨¡æ¿
 */
export const downloadTemplate = () => {
  window.open('http://localhost:8080/api/excel/template', '_blank')
}
```

#### 3.3.2 Excel å¯¼å…¥ç»„ä»¶

```tsx
// frontend/src/components/ExcelImport.tsx
import React, { useState } from 'react'
import { Upload, Button, message, Modal, List } from 'antd'
import { UploadOutlined, DownloadOutlined } from '@ant-design/icons'
import { importExcel, downloadTemplate } from '../api/excel'

interface ImportResult {
  successCount: number
  errorCount: number
  errorMessages: string[]
}

const ExcelImport: React.FC<{ onSuccess: () => void }> = ({ onSuccess }) => {
  const [loading, setLoading] = useState(false)
  const [resultVisible, setResultVisible] = useState(false)
  const [importResult, setImportResult] = useState<ImportResult | null>(null)

  const handleImport = async (file: File) => {
    setLoading(true)
    try {
      const result = await importExcel(file)
      setImportResult(result)
      setResultVisible(true)
      
      if (result.errorCount === 0) {
        message.success(`æˆåŠŸå¯¼å…¥ ${result.successCount} æ¡æ•°æ®`)
        onSuccess()
      } else {
        message.warning(
          `å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${result.successCount} æ¡ï¼Œå¤±è´¥ ${result.errorCount} æ¡`
        )
      }
    } catch (error: any) {
      message.error('å¯¼å…¥å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'))
    } finally {
      setLoading(false)
    }
    return false // é˜»æ­¢è‡ªåŠ¨ä¸Šä¼ 
  }

  return (
    <>
      <div style={{ marginBottom: 16 }}>
        <Button 
          icon={<DownloadOutlined />} 
          onClick={downloadTemplate}
          style={{ marginRight: 8 }}
        >
          ä¸‹è½½æ¨¡æ¿
        </Button>
        <Upload
          accept=".xlsx,.xls"
          beforeUpload={handleImport}
          showUploadList={false}
        >
          <Button 
            type="primary" 
            icon={<UploadOutlined />} 
            loading={loading}
          >
            å¯¼å…¥Excel
          </Button>
        </Upload>
      </div>

      <Modal
        title="å¯¼å…¥ç»“æœ"
        open={resultVisible}
        onOk={() => setResultVisible(false)}
        onCancel={() => setResultVisible(false)}
        width={600}
      >
        {importResult && (
          <div>
            <p>
              æˆåŠŸå¯¼å…¥ï¼š<strong style={{ color: 'green' }}>
                {importResult.successCount}
              </strong> æ¡
            </p>
            <p>
              å¯¼å…¥å¤±è´¥ï¼š<strong style={{ color: 'red' }}>
                {importResult.errorCount}
              </strong> æ¡
            </p>
            {importResult.errorMessages.length > 0 && (
              <>
                <p>é”™è¯¯è¯¦æƒ…ï¼š</p>
                <List
                  size="small"
                  bordered
                  dataSource={importResult.errorMessages}
                  renderItem={(item) => (
                    <List.Item style={{ color: 'red' }}>{item}</List.Item>
                  )}
                  style={{ maxHeight: 300, overflow: 'auto' }}
                />
              </>
            )}
          </div>
        )}
      </Modal>
    </>
  )
}

export default ExcelImport
```

#### 3.3.3 åœ¨å‘˜å·¥åˆ—è¡¨ä¸­é›†æˆ

```tsx
// frontend/src/pages/EmployeeList.tsx
import ExcelImport from '../components/ExcelImport'
import { exportExcel } from '../api/excel'
import { DownloadOutlined } from '@ant-design/icons'

// åœ¨ Card çš„ extra ä¸­æ·»åŠ 
<Card
  title="å‘˜å·¥åˆ—è¡¨"
  extra={
    <Space>
      <ExcelImport onSuccess={loadEmployees} />
      <Button 
        icon={<DownloadOutlined />} 
        onClick={() => exportExcel()}
      >
        å¯¼å‡ºExcel
      </Button>
      <Button type="primary" onClick={() => navigate('/employees/new')}>
        æ–°å¢å‘˜å·¥
      </Button>
    </Space>
  }
>
  {/* è¡¨æ ¼å†…å®¹ */}
</Card>
```

---

## å››ã€é›†æˆæµ‹è¯•æ–¹æ¡ˆ

### 4.1 æµ‹è¯•æµç¨‹

#### æµ‹è¯• 1ï¼šAOP æ“ä½œæ—¥å¿—
1. åˆ›å»ºä¸€ä¸ªå‘˜å·¥
2. è®¿é—® `http://localhost:3000/logs` æŸ¥çœ‹æ—¥å¿—
3. éªŒè¯æ—¥å¿—æ˜¯å¦åŒ…å«ï¼šæ“ä½œäººã€æ“ä½œç±»å‹ã€IPã€è€—æ—¶

#### æµ‹è¯• 2ï¼šæƒé™ç®¡ç†
1. åˆ›å»ºä¸‰ä¸ªæµ‹è¯•è´¦å·ï¼š
   - `admin`ï¼ˆSUPER_ADMINï¼‰
   - `manager`ï¼ˆMANAGERï¼Œéƒ¨é—¨ï¼šæŠ€æœ¯éƒ¨ï¼‰
   - `employee`ï¼ˆEMPLOYEEï¼‰

2. ç”¨ `manager` ç™»å½•ï¼Œå°è¯•ï¼š
   - âœ… æŸ¥çœ‹æŠ€æœ¯éƒ¨å‘˜å·¥ï¼ˆåº”è¯¥æˆåŠŸï¼‰
   - âŒ åˆ é™¤å‘˜å·¥ï¼ˆåº”è¯¥å¤±è´¥ï¼Œæç¤ºæƒé™ä¸è¶³ï¼‰

3. ç”¨ `employee` ç™»å½•ï¼Œå°è¯•ï¼š
   - âŒ æŸ¥çœ‹æ‰€æœ‰å‘˜å·¥ï¼ˆåº”è¯¥å¤±è´¥ï¼‰

#### æµ‹è¯• 3ï¼šExcel å¯¼å…¥å¯¼å‡º
1. ä¸‹è½½æ¨¡æ¿
2. å¡«å†™ 5 æ¡å‘˜å·¥æ•°æ®ï¼ˆå…¶ä¸­ 1 æ¡æ•…æ„å¡«é”™ï¼‰
3. å¯¼å…¥ï¼ŒæŸ¥çœ‹ç»“æœæç¤º
4. å¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼ŒéªŒè¯æ ¼å¼

### 4.2 SQL æµ‹è¯•æ•°æ®

```sql
-- åˆ›å»ºæµ‹è¯•ç”¨æˆ·
INSERT INTO user_account (username, password, email, role, department) VALUES
('admin', '$2a$10$...', 'admin@example.com', 'SUPER_ADMIN', NULL),
('manager', '$2a$10$...', 'manager@example.com', 'MANAGER', 'æŠ€æœ¯éƒ¨'),
('employee', '$2a$10$...', 'employee@example.com', 'EMPLOYEE', 'æŠ€æœ¯éƒ¨');
```

---

## äº”ã€å®ç°æ­¥éª¤æ€»ç»“

### Step 1ï¼šæ•°æ®åº“å‡†å¤‡ï¼ˆ10åˆ†é’Ÿï¼‰
```bash
# è¿æ¥æ•°æ®åº“
psql -U postgres -d empmgmt

# æ‰§è¡Œæœ¬æ–‡æ¡£ä¸­çš„æ‰€æœ‰ SQL è¯­å¥
```

### Step 2ï¼šåç«¯å®ç°ï¼ˆ60åˆ†é’Ÿï¼‰
1. æ·»åŠ  Maven ä¾èµ–
2. åˆ›å»ºæ³¨è§£ã€æšä¸¾ã€å®ä½“ç±»
3. å®ç° AOP åˆ‡é¢
4. åˆ›å»º Controller
5. æµ‹è¯•æ¥å£ï¼ˆPostmanï¼‰

### Step 3ï¼šå‰ç«¯å®ç°ï¼ˆ40åˆ†é’Ÿï¼‰
1. åˆ›å»ºç±»å‹å®šä¹‰
2. å®ç° API è°ƒç”¨
3. åˆ›å»ºç»„ä»¶
4. é›†æˆåˆ°ç°æœ‰é¡µé¢
5. æµ‹è¯•åŠŸèƒ½

### Step 4ï¼šè”è°ƒæµ‹è¯•ï¼ˆ20åˆ†é’Ÿï¼‰
1. æµ‹è¯•æ—¥å¿—è®°å½•
2. æµ‹è¯•æƒé™æ§åˆ¶
3. æµ‹è¯• Excel å¯¼å…¥å¯¼å‡º
4. ä¿®å¤ Bug

---

## å…­ã€æ³¨æ„äº‹é¡¹

### 6.1 æ€§èƒ½ä¼˜åŒ–
- æ“ä½œæ—¥å¿—å¼‚æ­¥ä¿å­˜ï¼ˆä½¿ç”¨ `@Async` æˆ–æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- Excel å¯¼å‡ºå¤§æ•°æ®é‡æ—¶åˆ†é¡µå¤„ç†
- æ—¥å¿—è¡¨å®šæœŸå½’æ¡£ï¼ˆè¶…è¿‡ 3 ä¸ªæœˆçš„æ•°æ®ç§»åˆ°å†å²è¡¨ï¼‰

### 6.2 å®‰å…¨å»ºè®®
- æ•æ„Ÿå­—æ®µä¸è®°å½•åˆ°æ—¥å¿—ï¼ˆå¦‚å¯†ç ï¼‰
- Excel å¯¼å…¥é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆ<5MBï¼‰
- æƒé™æ ¡éªŒå¤±è´¥æ—¶è®°å½•å®¡è®¡æ—¥å¿—

### 6.3 æ‰©å±•å»ºè®®
- æ“ä½œæ—¥å¿—å¯è§†åŒ–ï¼ˆECharts ç»Ÿè®¡å›¾è¡¨ï¼‰
- æƒé™ç®¡ç†æ”¯æŒåŠ¨æ€é…ç½®ï¼ˆä¸éœ€è¦æ”¹ä»£ç ï¼‰
- Excel æ”¯æŒæ›´å¤šæ ¼å¼ï¼ˆCSVã€ODSï¼‰

---

## ä¸ƒã€å¸¸è§é—®é¢˜ FAQ

### Q1: AOP æ—¥å¿—æ²¡æœ‰è®°å½•ï¼Ÿ
**A:** æ£€æŸ¥æ–¹æ³•æ˜¯å¦æ·»åŠ äº† `@OperationLog` æ³¨è§£ï¼Œç¡®ä¿ AOP åˆ‡é¢è¢« Spring æ‰«æåˆ°ã€‚

### Q2: æƒé™æ ¡éªŒä¸ç”Ÿæ•ˆï¼Ÿ
**A:** ç¡®è®¤ JWT Token ä¸­åŒ…å«äº† `role` å­—æ®µï¼Œä¸” `SecurityUtil` èƒ½æ­£ç¡®è·å–ã€‚

### Q3: Excel å¯¼å…¥ä¸­æ–‡ä¹±ç ï¼Ÿ
**A:** è®¾ç½® `response.setCharacterEncoding("utf-8")`ï¼Œä½¿ç”¨ UTF-8 ç¼–ç ã€‚

### Q4: æ—¥å¿—è¡¨æ•°æ®é‡å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ
**A:** 
- åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œæ¯æœˆå½’æ¡£æ—§æ•°æ®
- ä½¿ç”¨åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆä»½åˆ†åŒºï¼‰
- åªä¿ç•™æœ€è¿‘ 6 ä¸ªæœˆæ•°æ®

---

## å…«ã€å‚è€ƒèµ„æ–™

- [Spring AOP å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/core/aop.html)
- [EasyExcel æ–‡æ¡£](https://easyexcel.opensource.alibaba.com/)
- [Spring Security æƒé™æ§åˆ¶](https://spring.io/guides/topicals/spring-security-architecture)

---

**æ–‡æ¡£ç»“æŸ**

ç¥ä½ å®ç°é¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿éšæ—¶æé—®ã€‚ğŸ‰
