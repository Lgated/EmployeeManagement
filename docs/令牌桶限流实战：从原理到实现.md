# ğŸš€ ä»¤ç‰Œæ¡¶é™æµå®æˆ˜ï¼šä»åŸç†åˆ°å®ç°

> æœ¬æ–‡åŸºäº Spring Boot + Redis + Lua å®ç°ä»¤ç‰Œæ¡¶é™æµï¼Œä¿æŠ¤ä½ çš„ç™»å½•æ¥å£å…å—æš´åŠ›ç ´è§£æ”»å‡»ã€‚

---

## ğŸ¯ é˜…è¯»æŒ‡å—

â­ **æ¸©é¦¨æç¤ºï¼š**

- **æ–°æ‰‹æ¨è**ï¼šä»å¤´åˆ°å°¾æŒ‰é¡ºåºé˜…è¯»ï¼Œç†è§£æ¯ä¸ªæ¦‚å¿µå’Œæ­¥éª¤
- **è€æ‰‹é€Ÿé€š**ï¼šç›´æ¥è·³åˆ°ã€Œå¿«é€Ÿä¸Šæ‰‹ã€ç« èŠ‚ï¼Œ5åˆ†é’Ÿæå®šæ¥å…¥
- **å®æˆ˜æ´¾**ï¼šé‡ç‚¹å…³æ³¨ã€Œå®é™…åº”ç”¨åœºæ™¯ã€å’Œã€Œä»£ç å®ç°ã€éƒ¨åˆ†

---

## ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ä»¤ç‰Œæ¡¶é™æµï¼Ÿ

### åœºæ™¯ä¸€ï¼šç™»å½•æ¥å£è¢«æš´åŠ›ç ´è§£

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªå‘˜å·¥ç®¡ç†ç³»ç»Ÿã€‚æŸå¤©å‡Œæ™¨ï¼Œä½ æ”¶åˆ°å‘Šè­¦ï¼š

```
ç™»å½•æ¥å£è¢«ç–¯ç‹‚è°ƒç”¨ï¼š127.0.0.1 åœ¨ 1 åˆ†é’Ÿå†…å°è¯•äº† 1000 æ¬¡ç™»å½•
```

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š**

- æ²¡æœ‰é™æµä¿æŠ¤ï¼Œæ”»å‡»è€…å¯ä»¥æ— é™æ¬¡å°è¯•å¯†ç 
- æ•°æ®åº“è¢«é¢‘ç¹æŸ¥è¯¢ï¼Œå½±å“æ­£å¸¸ç”¨æˆ·
- æœåŠ¡å™¨èµ„æºè¢«æ¶æ„æ¶ˆè€—

**æœ‰äº†ä»¤ç‰Œæ¡¶é™æµåï¼š**

```java
// åœ¨ç™»å½•æ¥å£ä¸­ï¼Œåªéœ€è¦ä¸€è¡Œä»£ç 
boolean allowed = rateLimitService.tryAcquire("rate:login:ip:", ip, 30, 0.5);
if (!allowed) {
    throw new BusinessException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
}
// è‡ªåŠ¨é™åˆ¶ï¼šæ¯åˆ†é’Ÿæœ€å¤š 30 æ¬¡å°è¯•ï¼Œè¶…å‡ºåˆ™æ‹’ç»
```

### åœºæ™¯äºŒï¼šAPI æ¥å£è¢«æ¶æ„åˆ·é‡

ä½ çš„ç³»ç»Ÿæä¾›äº†æ•°æ®å¯¼å‡ºæ¥å£ï¼Œæ¯æ¬¡å¯¼å‡ºéƒ½ä¼šæ¶ˆè€—å¤§é‡ CPU å’Œå†…å­˜ï¼š

- **æ²¡æœ‰é™æµ**ï¼šæ¶æ„ç”¨æˆ·ç–¯ç‹‚è°ƒç”¨å¯¼å‡ºæ¥å£ï¼ŒæœåŠ¡å™¨ç›´æ¥å®•æœº
- **æœ‰äº†é™æµ**ï¼šæ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤šè°ƒç”¨ 5 æ¬¡ï¼Œè¶…å‡ºåˆ™æ’é˜Ÿç­‰å¾…

### åœºæ™¯ä¸‰ï¼šç§’æ€æ´»åŠ¨ä¿æŠ¤

åŒåä¸€ç§’æ€æ´»åŠ¨ï¼Œå•†å“åº“å­˜åªæœ‰ 100 ä»¶ï¼š

- **æ²¡æœ‰é™æµ**ï¼šç¬é—´æ¶Œå…¥ 10 ä¸‡è¯·æ±‚ï¼Œæ•°æ®åº“ç›´æ¥å´©æºƒ
- **æœ‰äº†é™æµ**ï¼šæ¯ç§’åªå¤„ç† 100 ä¸ªè¯·æ±‚ï¼Œå…¶ä»–è¯·æ±‚æ’é˜Ÿï¼Œç³»ç»Ÿç¨³å®šè¿è¡Œ

---

## ğŸ¤” ä»¤ç‰Œæ¡¶é™æµæ˜¯ä»€ä¹ˆï¼Ÿ

### å®˜æ–¹å®šä¹‰

ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰æ˜¯ä¸€ç§**æµé‡æ•´å½¢**å’Œ**é€Ÿç‡é™åˆ¶**çš„ç®—æ³•ï¼Œé€šè¿‡ç»´æŠ¤ä¸€ä¸ªå›ºå®šå®¹é‡çš„ä»¤ç‰Œæ¡¶ï¼ŒæŒ‰ç…§å›ºå®šé€Ÿç‡å‘æ¡¶ä¸­æ·»åŠ ä»¤ç‰Œï¼Œè¯·æ±‚éœ€è¦æ¶ˆè€—ä»¤ç‰Œæ‰èƒ½é€šè¿‡ã€‚

### ç®€å•ç†è§£ï¼šæ°´æ¡¶æ¥æ°´

æƒ³è±¡ä¸€ä¸ªæ°´æ¡¶ï¼š

1. **æ¡¶å®¹é‡ï¼ˆcapacityï¼‰**ï¼šæ°´æ¡¶æœ€å¤šèƒ½è£…å¤šå°‘æ°´ï¼ˆä»¤ç‰Œï¼‰
   - ä¾‹å¦‚ï¼š30 ä¸ªä»¤ç‰Œ

2. **å¡«å……é€Ÿç‡ï¼ˆrateï¼‰**ï¼šæ¯ç§’å¾€æ¡¶é‡ŒåŠ å¤šå°‘æ°´ï¼ˆä»¤ç‰Œï¼‰
   - ä¾‹å¦‚ï¼šæ¯ç§’ 0.5 ä¸ªä»¤ç‰Œ = æ¯åˆ†é’Ÿ 30 ä¸ªä»¤ç‰Œ

3. **è¯·æ±‚å¤„ç†**ï¼šæ¯æ¬¡è¯·æ±‚ä»æ¡¶é‡Œå– 1 ä¸ªä»¤ç‰Œ
   - æœ‰ä»¤ç‰Œ â†’ å…è®¸è¯·æ±‚é€šè¿‡ âœ…
   - æ²¡ä»¤ç‰Œ â†’ æ‹’ç»è¯·æ±‚ âŒ

### æ ¸å¿ƒä¼˜åŠ¿

ç›¸æ¯”å…¶ä»–é™æµç®—æ³•ï¼ˆå¦‚å›ºå®šçª—å£ã€æ»‘åŠ¨çª—å£ï¼‰ï¼Œä»¤ç‰Œæ¡¶çš„ä¼˜åŠ¿ï¼š

âœ… **å…è®¸çªå‘æµé‡**ï¼šæ¡¶é‡Œæœ‰ä»¤ç‰Œæ—¶ï¼Œå¯ä»¥ç¬é—´å¤„ç†å¤šä¸ªè¯·æ±‚  
âœ… **å¹³æ»‘é™æµ**ï¼šä»¤ç‰ŒåŒ€é€Ÿè¡¥å……ï¼Œä¸ä¼šçªç„¶æ”¾è¡Œå¤§é‡è¯·æ±‚  
âœ… **çµæ´»é…ç½®**ï¼šå¯ä»¥è°ƒæ•´å®¹é‡å’Œé€Ÿç‡ï¼Œé€‚åº”ä¸åŒåœºæ™¯  
âœ… **åˆ†å¸ƒå¼å‹å¥½**ï¼šåŸºäº Redisï¼Œæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²  

---

## ğŸ¯ ä»€ä¹ˆåœºæ™¯ä½¿ç”¨ï¼Ÿ

### 1. ç™»å½•/æ³¨å†Œæ¥å£

**ç›®æ ‡**ï¼šé˜²æ­¢æš´åŠ›ç ´è§£ã€æ¶æ„æ³¨å†Œ

```java
// æŒ‰ IP é™æµï¼šæ¯åˆ†é’Ÿæœ€å¤š 30 æ¬¡ç™»å½•å°è¯•
rateLimitService.tryAcquire("rate:login:ip:", ip, 30, 0.5);
```

### 2. çŸ­ä¿¡/é‚®ä»¶å‘é€æ¥å£

**ç›®æ ‡**ï¼šé˜²æ­¢æ¶æ„åˆ·çŸ­ä¿¡ï¼ŒèŠ‚çœæˆæœ¬

```java
// æŒ‰ç”¨æˆ· ID é™æµï¼šæ¯å°æ—¶æœ€å¤š 5 æ¡çŸ­ä¿¡
rateLimitService.tryAcquire("rate:sms:user:", userId, 5, 5.0/3600);
```

### 3. æ•°æ®å¯¼å‡ºæ¥å£

**ç›®æ ‡**ï¼šé˜²æ­¢å¤§é‡å¯¼å‡ºè¯·æ±‚å¯¼è‡´æœåŠ¡å™¨å´©æºƒ

```java
// æŒ‰ç”¨æˆ·é™æµï¼šæ¯åˆ†é’Ÿæœ€å¤š 3 æ¬¡å¯¼å‡º
rateLimitService.tryAcquire("rate:export:user:", userId, 3, 3.0/60);
```

### 4. ç¬¬ä¸‰æ–¹ API è°ƒç”¨

**ç›®æ ‡**ï¼šé¿å…è¶…å‡ºç¬¬ä¸‰æ–¹ API çš„è°ƒç”¨é™åˆ¶

```java
// å…¨å±€é™æµï¼šæ¯ç§’æœ€å¤š 10 æ¬¡è°ƒç”¨
rateLimitService.tryAcquire("rate:third-party:", "global", 10, 10.0);
```

---

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹ï¼š5åˆ†é’Ÿæ¥å…¥ä»¤ç‰Œæ¡¶é™æµ

### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–

é¡¹ç›®å·²ç»ä½¿ç”¨äº† Spring Boot å’Œ Redisï¼Œæ— éœ€é¢å¤–ä¾èµ–ï¼š

```xml
<!-- å·²æœ‰çš„ä¾èµ– -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

### ç¬¬äºŒæ­¥ï¼šç¼–å†™ Lua è„šæœ¬

åˆ›å»ºæ–‡ä»¶ï¼š`src/main/resources/lua/token_bucket.lua`

```lua
-- ä»¤ç‰Œæ¡¶é™æµ Lua è„šæœ¬
-- KEYS[1] = ä»¤ç‰Œæ•° keyï¼Œä¾‹å¦‚ rate:login:ip:127.0.0.1:tokens
-- KEYS[2] = ä¸Šæ¬¡åˆ·æ–°æ—¶é—´ keyï¼Œä¾‹å¦‚ rate:login:ip:127.0.0.1:ts
-- ARGV[1] = å®¹é‡ capacity
-- ARGV[2] = æ¯ç§’å¡«å……é€Ÿç‡ rate
-- ARGV[3] = å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰

local tokens_key = KEYS[1]
local ts_key = KEYS[2]

local capacity = tonumber(ARGV[1])
local rate = tonumber(ARGV[2])
local now = tonumber(ARGV[3])

-- å½“å‰ token æ•°ä¸ä¸Šæ¬¡åˆ·æ–°æ—¶é—´
local tokens = tonumber(redis.call("GET", tokens_key))
if tokens == nil then
  tokens = capacity  -- ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè§†ä¸ºæ¡¶å·²æ»¡
end

local last_ts = tonumber(redis.call("GET", ts_key))
if last_ts == nil then
  last_ts = now      -- ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œåˆå§‹åŒ–æ—¶é—´
end

-- è®¡ç®—ç»è¿‡çš„æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œè¡¥å……ä»¤ç‰Œ
local delta = math.max(0, now - last_ts)
local refill = (delta / 1000.0) * rate
tokens = math.min(capacity, tokens + refill)

-- åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä»¤ç‰Œ
local allowed = 0
if tokens >= 1 then
  tokens = tokens - 1
  allowed = 1
end

-- å†™å› Redis
redis.call("SET", tokens_key, tokens)
redis.call("SET", ts_key, now)

return allowed
```

**ä¸ºä»€ä¹ˆç”¨ Lua è„šæœ¬ï¼Ÿ**

- âœ… **åŸå­æ€§**ï¼šRedis æ‰§è¡Œ Lua è„šæœ¬æ˜¯åŸå­çš„ï¼Œä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜
- âœ… **æ€§èƒ½**ï¼šè„šæœ¬åœ¨ Redis æœåŠ¡å™¨ç«¯æ‰§è¡Œï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
- âœ… **ç®€å•**ï¼šé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

### ç¬¬ä¸‰æ­¥ï¼šå°è£… RateLimitService

åˆ›å»ºæ–‡ä»¶ï¼š`src/main/java/com/example/empmgmt/service/Impl/RateLimitService.java`

```java
package com.example.empmgmt.service.Impl;

import org.springframework.core.io.ClassPathResource;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.core.script.DefaultRedisScript;
import org.springframework.stereotype.Service;

import java.util.Arrays;

/**
 * åŸºäº Redis + Lua çš„ä»¤ç‰Œæ¡¶é™æµæœåŠ¡
 */
@Service
public class RateLimitService {

    private final StringRedisTemplate redisTemplate;
    private final DefaultRedisScript<Long> tokenBucketScript;

    public RateLimitService(StringRedisTemplate redisTemplate){
        this.redisTemplate = redisTemplate;
        this.tokenBucketScript = new DefaultRedisScript<>();
        // åŠ è½½ Lua è„šæœ¬
        this.tokenBucketScript.setLocation(new ClassPathResource("lua/token_bucket.lua"));
        this.tokenBucketScript.setResultType(Long.class);
    }
    
    /**
     * å°è¯•è·å–ä¸€ä¸ªä»¤ç‰Œ
     *
     * @param keyPrefix é™æµ key å‰ç¼€ï¼Œä¾‹å¦‚ "rate:login:ip:"
     * @param id        æ ‡è¯†ï¼Œä¾‹å¦‚ IP æˆ– userId
     * @param capacity  æ¡¶å®¹é‡ -- ç¬é—´å¹¶å‘
     * @param rate      æ¯ç§’å¡«å……é€Ÿç‡ï¼ˆå¯ä»¥æ˜¯å°æ•°ï¼‰
     * @return true = å…è®¸ï¼›false = é™æµ
     */
    public boolean tryAcquire(String keyPrefix, String id, int capacity, double rate) {
        String tokensKey = keyPrefix + id + ":tokens";
        String tsKey = keyPrefix + id + ":ts";

        long now = System.currentTimeMillis();

        // æ‰§è¡Œ Lua è„šæœ¬
        Long result = redisTemplate.execute(
                tokenBucketScript,
                Arrays.asList(tokensKey, tsKey),
                String.valueOf(capacity),
                String.valueOf(rate),
                String.valueOf(now)
        );
        return result != null && result == 1L;
    }
}
```

**æ ¸å¿ƒæ–¹æ³•è¯´æ˜ï¼š**

- `tryAcquire()`ï¼šå°è¯•è·å–ä¸€ä¸ªä»¤ç‰Œ
  - `keyPrefix`ï¼šé™æµ key çš„å‰ç¼€ï¼Œç”¨äºåŒºåˆ†ä¸åŒåœºæ™¯
  - `id`ï¼šé™æµçš„æ ‡è¯†ï¼ˆIPã€ç”¨æˆ·IDç­‰ï¼‰
  - `capacity`ï¼šæ¡¶å®¹é‡ï¼Œå…è®¸çš„ç¬é—´å¹¶å‘æ•°
  - `rate`ï¼šæ¯ç§’å¡«å……é€Ÿç‡ï¼Œæ§åˆ¶å¹³å‡é€Ÿç‡

### ç¬¬å››æ­¥ï¼šåœ¨ç™»å½•æ¥å£ä¸­æ¥å…¥é™æµ

åœ¨ `AuthController` çš„ç™»å½•æ–¹æ³•ä¸­æ·»åŠ é™æµé€»è¾‘ï¼š

```java
@PostMapping("/login")
public Result<AuthResponse> login(@Valid @RequestBody LoginRequest request, 
                                  HttpServletResponse resp, 
                                  HttpServletRequest req) {

    // 1. æœªç™»å½•å‰æŒ‰ IP é™æµ
    String ip = getClientIpAddress(req);

    // å®¹é‡ 30ï¼Œæ¯ç§’ 0.5 ä¸ªä»¤ç‰Œ => æ¯åˆ†é’Ÿçº¦è¡¥å…… 30 ä¸ª
    boolean allowed = rateLimitService.tryAcquire(
            "rate:login:ip:",
            ip,
            30,
            0.5
    );
    
    if (!allowed) {
        throw new BusinessException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
    }

    // 2. é™æµé€šè¿‡ï¼Œç»§ç»­ç™»å½•æµç¨‹
    User user = userService.loginAndGetUser(request);
    // ... åç»­ç™»å½•é€»è¾‘
}
```

**å‚æ•°è°ƒä¼˜å»ºè®®ï¼š**

- **å¼€å‘ç¯å¢ƒ**ï¼š`capacity = 2, rate = 0.5`ï¼ˆæ–¹ä¾¿æµ‹è¯•é™æµæ•ˆæœï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š`capacity = 30, rate = 0.5`ï¼ˆæ¯åˆ†é’Ÿæœ€å¤š 30 æ¬¡å°è¯•ï¼‰
- **ä¸¥æ ¼åœºæ™¯**ï¼š`capacity = 10, rate = 0.2`ï¼ˆæ¯åˆ†é’Ÿæœ€å¤š 12 æ¬¡å°è¯•ï¼‰

---

## ğŸ“š å®ç°åŸç†è¯¦è§£

### ä»¤ç‰Œæ¡¶ç®—æ³•æµç¨‹

1. **åˆå§‹åŒ–**ï¼šç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œæ¡¶é‡Œè£…æ»¡ä»¤ç‰Œï¼ˆcapacity ä¸ªï¼‰

2. **è¡¥å……ä»¤ç‰Œ**ï¼šè®¡ç®—è·ç¦»ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´å·®ï¼ŒæŒ‰é€Ÿç‡è¡¥å……ä»¤ç‰Œ
   ```
   è¡¥å……æ•°é‡ = (å½“å‰æ—¶é—´ - ä¸Šæ¬¡æ—¶é—´) / 1000 * é€Ÿç‡
   ä»¤ç‰Œæ•° = min(å®¹é‡, å½“å‰ä»¤ç‰Œæ•° + è¡¥å……æ•°é‡)
   ```

3. **æ¶ˆè€—ä»¤ç‰Œ**ï¼šè¯·æ±‚åˆ°è¾¾æ—¶ï¼Œä»æ¡¶ä¸­å– 1 ä¸ªä»¤ç‰Œ
   - æœ‰ä»¤ç‰Œ â†’ å…è®¸é€šè¿‡ï¼Œä»¤ç‰Œæ•°å‡ 1
   - æ²¡ä»¤ç‰Œ â†’ æ‹’ç»è¯·æ±‚ï¼Œä»¤ç‰Œæ•°ä¸å˜

4. **æ›´æ–°çŠ¶æ€**ï¼šå°†å½“å‰ä»¤ç‰Œæ•°å’Œæ—¶é—´æˆ³å†™å› Redis

### Lua è„šæœ¬æ‰§è¡Œæµç¨‹

```lua
-- 1. è¯»å–å½“å‰ä»¤ç‰Œæ•°å’Œæ—¶é—´æˆ³
tokens = redis.call("GET", tokens_key)  -- å¦‚æœæ²¡æœ‰ï¼Œåˆå§‹åŒ–ä¸º capacity
last_ts = redis.call("GET", ts_key)     -- å¦‚æœæ²¡æœ‰ï¼Œåˆå§‹åŒ–ä¸ºå½“å‰æ—¶é—´

-- 2. è®¡ç®—æ—¶é—´å·®ï¼Œè¡¥å……ä»¤ç‰Œ
delta = now - last_ts                   -- æ¯«ç§’å·®
refill = (delta / 1000.0) * rate        -- è¡¥å……çš„ä»¤ç‰Œæ•°
tokens = min(capacity, tokens + refill) -- ä¸è¶…è¿‡å®¹é‡

-- 3. åˆ¤æ–­æ˜¯å¦æœ‰ä»¤ç‰Œ
if tokens >= 1 then
    tokens = tokens - 1                  -- æ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œ
    allowed = 1                          -- å…è®¸é€šè¿‡
else
    allowed = 0                          -- æ‹’ç»è¯·æ±‚
end

-- 4. å†™å› Redis
redis.call("SET", tokens_key, tokens)
redis.call("SET", ts_key, now)

return allowed                           -- è¿”å›ç»“æœ
```

### Redis Key è®¾è®¡

```
rate:login:ip:127.0.0.1:tokens  â†’ å­˜å‚¨å½“å‰ä»¤ç‰Œæ•°
rate:login:ip:127.0.0.1:ts      â†’ å­˜å‚¨ä¸Šæ¬¡åˆ·æ–°æ—¶é—´æˆ³
```

**è®¾è®¡åŸåˆ™ï¼š**

- âœ… ä½¿ç”¨å‰ç¼€åŒºåˆ†ä¸åŒåœºæ™¯ï¼š`rate:login:ip:`ã€`rate:sms:user:`
- âœ… ä½¿ç”¨æ ‡è¯†åŒºåˆ†ä¸åŒç”¨æˆ·ï¼šIPã€ç”¨æˆ·IDç­‰
- âœ… ä½¿ç”¨åç¼€åŒºåˆ†æ•°æ®ç±»å‹ï¼š`:tokens`ã€`:ts`

---

## ğŸ¨ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ä¸€ï¼šç™»å½•æ¥å£é™æµï¼ˆæŒ‰ IPï¼‰

**éœ€æ±‚**ï¼šé˜²æ­¢æš´åŠ›ç ´è§£ï¼Œæ¯åˆ†é’Ÿæœ€å¤š 30 æ¬¡ç™»å½•å°è¯•

```java
@PostMapping("/login")
public Result<AuthResponse> login(@RequestBody LoginRequest request, 
                                  HttpServletRequest req) {
    String ip = getClientIpAddress(req);
    
    // å®¹é‡ 30ï¼Œæ¯ç§’ 0.5 ä¸ªä»¤ç‰Œ = æ¯åˆ†é’Ÿ 30 ä¸ªä»¤ç‰Œ
    boolean allowed = rateLimitService.tryAcquire(
            "rate:login:ip:",
            ip,
            30,
            0.5
    );
    
    if (!allowed) {
        throw new BusinessException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
    }
    
    // ç»§ç»­ç™»å½•é€»è¾‘...
}
```

### åœºæ™¯äºŒï¼šçŸ­ä¿¡å‘é€é™æµï¼ˆæŒ‰ç”¨æˆ·ï¼‰

**éœ€æ±‚**ï¼šé˜²æ­¢æ¶æ„åˆ·çŸ­ä¿¡ï¼Œæ¯å°æ—¶æœ€å¤š 5 æ¡

```java
@PostMapping("/send-sms")
public Result<Void> sendSms(@RequestParam String phone, 
                            @RequestParam Long userId) {
    // å®¹é‡ 5ï¼Œæ¯ç§’ 5/3600 ä¸ªä»¤ç‰Œ = æ¯å°æ—¶ 5 ä¸ªä»¤ç‰Œ
    boolean allowed = rateLimitService.tryAcquire(
            "rate:sms:user:",
            String.valueOf(userId),
            5,
            5.0 / 3600
    );
    
    if (!allowed) {
        throw new BusinessException("å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
    }
    
    // å‘é€çŸ­ä¿¡é€»è¾‘...
}
```

### åœºæ™¯ä¸‰ï¼šæ•°æ®å¯¼å‡ºé™æµï¼ˆæŒ‰ç”¨æˆ·ï¼‰

**éœ€æ±‚**ï¼šé˜²æ­¢å¤§é‡å¯¼å‡ºè¯·æ±‚ï¼Œæ¯åˆ†é’Ÿæœ€å¤š 3 æ¬¡

```java
@GetMapping("/export")
public void exportData(@RequestParam Long userId, 
                       HttpServletResponse response) {
    // å®¹é‡ 3ï¼Œæ¯ç§’ 3/60 ä¸ªä»¤ç‰Œ = æ¯åˆ†é’Ÿ 3 ä¸ªä»¤ç‰Œ
    boolean allowed = rateLimitService.tryAcquire(
            "rate:export:user:",
            String.valueOf(userId),
            3,
            3.0 / 60
    );
    
    if (!allowed) {
        throw new BusinessException("å¯¼å‡ºè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
    }
    
    // å¯¼å‡ºæ•°æ®é€»è¾‘...
}
```

---

## ğŸ”§ å‚æ•°è°ƒä¼˜æŒ‡å—

### å¦‚ä½•é€‰æ‹©åˆé€‚çš„å‚æ•°ï¼Ÿ

**1. å®¹é‡ï¼ˆcapacityï¼‰**

- **ä½œç”¨**ï¼šå…è®¸çš„ç¬é—´å¹¶å‘æ•°
- **ç¤ºä¾‹**ï¼š
  - ç™»å½•æ¥å£ï¼š`capacity = 30`ï¼ˆå…è®¸ç¬é—´ 30 ä¸ªè¯·æ±‚ï¼‰
  - çŸ­ä¿¡æ¥å£ï¼š`capacity = 5`ï¼ˆå…è®¸ç¬é—´ 5 ä¸ªè¯·æ±‚ï¼‰
  - å¯¼å‡ºæ¥å£ï¼š`capacity = 3`ï¼ˆå…è®¸ç¬é—´ 3 ä¸ªè¯·æ±‚ï¼‰

**2. é€Ÿç‡ï¼ˆrateï¼‰**

- **ä½œç”¨**ï¼šæ¯ç§’è¡¥å……çš„ä»¤ç‰Œæ•°ï¼Œæ§åˆ¶å¹³å‡é€Ÿç‡
- **è®¡ç®—å…¬å¼**ï¼š`rate = æ€»ä»¤ç‰Œæ•° / æ—¶é—´çª—å£ï¼ˆç§’ï¼‰`
- **ç¤ºä¾‹**ï¼š
  - æ¯åˆ†é’Ÿ 30 æ¬¡ï¼š`rate = 30 / 60 = 0.5`
  - æ¯å°æ—¶ 5 æ¬¡ï¼š`rate = 5 / 3600 â‰ˆ 0.0014`
  - æ¯ç§’ 10 æ¬¡ï¼š`rate = 10`

**3. å®é™…æ•ˆæœ**

å‡è®¾ `capacity = 30, rate = 0.5`ï¼š

- **ç¬é—´çªå‘**ï¼šå¯ä»¥ç¬é—´å¤„ç† 30 ä¸ªè¯·æ±‚ï¼ˆæ¡¶æ»¡æ—¶ï¼‰
- **æŒç»­è¯·æ±‚**ï¼šæ¯ç§’æœ€å¤š 0.5 ä¸ªè¯·æ±‚ = æ¯åˆ†é’Ÿ 30 ä¸ªè¯·æ±‚
- **è¯·æ±‚è¢«é™æµå**ï¼šéœ€è¦ç­‰å¾…ä»¤ç‰Œè¡¥å……ï¼Œå¤§çº¦ 2 ç§’åå¯ä»¥å†æ¬¡è¯·æ±‚

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•é™æµæ•ˆæœ

ä½¿ç”¨ Postman æˆ– curl å¿«é€Ÿè¿ç»­å‘é€ç™»å½•è¯·æ±‚ï¼š

```bash
# å¿«é€Ÿå‘é€ 10 ä¸ªç™»å½•è¯·æ±‚
for i in {1..10}; do
  curl -X POST http://localhost:8080/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username":"test","password":"test"}'
  echo ""
done
```

**é¢„æœŸç»“æœï¼š**

- å‰å‡ ä¸ªè¯·æ±‚ï¼šæ­£å¸¸è¿”å›ï¼ˆæœ‰ä»¤ç‰Œï¼‰
- åç»­è¯·æ±‚ï¼šè¿”å› `"è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"`ï¼ˆä»¤ç‰Œè€—å°½ï¼‰
- ç­‰å¾…å‡ ç§’åï¼šåˆå¯ä»¥æ­£å¸¸è¯·æ±‚ï¼ˆä»¤ç‰Œå·²è¡¥å……ï¼‰

### ç›‘æ§ Redis æ•°æ®

ä½¿ç”¨ Redis CLI æŸ¥çœ‹ä»¤ç‰Œæ¡¶çŠ¶æ€ï¼š

```bash
# è¿æ¥ Redis
redis-cli

# æŸ¥çœ‹ä»¤ç‰Œæ•°
GET rate:login:ip:127.0.0.1:tokens

# æŸ¥çœ‹æ—¶é—´æˆ³
GET rate:login:ip:127.0.0.1:ts
```

---

## ğŸ¯ æ€»ç»“

### ä»¤ç‰Œæ¡¶é™æµçš„ä¼˜åŠ¿

âœ… **å…è®¸çªå‘æµé‡**ï¼šæ¡¶æ»¡æ—¶å¯ä»¥ç¬é—´å¤„ç†å¤šä¸ªè¯·æ±‚  
âœ… **å¹³æ»‘é™æµ**ï¼šä»¤ç‰ŒåŒ€é€Ÿè¡¥å……ï¼Œä¸ä¼šçªç„¶æ”¾è¡Œ  
âœ… **åˆ†å¸ƒå¼å‹å¥½**ï¼šåŸºäº Redisï¼Œæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²  
âœ… **çµæ´»é…ç½®**ï¼šå¯ä»¥è°ƒæ•´å®¹é‡å’Œé€Ÿç‡ï¼Œé€‚åº”ä¸åŒåœºæ™¯  

### é€‚ç”¨åœºæ™¯

- âœ… ç™»å½•/æ³¨å†Œæ¥å£ï¼šé˜²æ­¢æš´åŠ›ç ´è§£
- âœ… çŸ­ä¿¡/é‚®ä»¶æ¥å£ï¼šé˜²æ­¢æ¶æ„åˆ·é‡
- âœ… æ•°æ®å¯¼å‡ºæ¥å£ï¼šé˜²æ­¢æœåŠ¡å™¨å´©æºƒ
- âœ… ç¬¬ä¸‰æ–¹ API è°ƒç”¨ï¼šé¿å…è¶…å‡ºé™åˆ¶
- âœ… ç§’æ€æ´»åŠ¨ï¼šä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§

### æ ¸å¿ƒä»£ç 

åªéœ€è¦ä¸‰æ­¥ï¼š

1. **ç¼–å†™ Lua è„šæœ¬**ï¼šå®ç°ä»¤ç‰Œæ¡¶é€»è¾‘
2. **å°è£… Service**ï¼šæä¾› `tryAcquire()` æ–¹æ³•
3. **æ¥å…¥æ¥å£**ï¼šåœ¨éœ€è¦é™æµçš„åœ°æ–¹è°ƒç”¨

---

## ğŸ“– å»¶ä¼¸é˜…è¯»

- [Redis Lua è„šæœ¬å®˜æ–¹æ–‡æ¡£](https://redis.io/docs/manual/programmability/eval-intro/)
- [Spring Data Redis å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-data/redis/docs/current/reference/html/)
- [ä»¤ç‰Œæ¡¶ç®—æ³• Wikipedia](https://en.wikipedia.org/wiki/Token_bucket)

---

**ğŸ‰ æ­å–œï¼** ä½ å·²ç»æŒæ¡äº†ä»¤ç‰Œæ¡¶é™æµçš„åŸç†å’Œå®ç°ï¼Œå¿«å»ä¿æŠ¤ä½ çš„æ¥å£å§ï¼



