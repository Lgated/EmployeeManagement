# 消息队列导出功能检查与修复方案

> 检查员工导出和用户导出的消息队列实现，提供修复方案和测试指南

---

## 一、代码检查结果

### 1.1 已完成的部分 ✅

1. **ExportTaskService** ✅
   - `createEmployeeExportTask()` - 已实现
   - `createUserExportTask()` - 已实现
   - `getTask()` - 已实现

2. **ExportTaskController** ✅
   - `getTask()` - 已实现
   - `download()` - **已修复**（直接读取文件，不用EasyExcel）

3. **Controller接口** ✅
   - `EmployeeController.createExportTask()` - 已实现
   - `UserController.createExportTask()` - 已实现

4. **消费者方法** ✅
   - `doEmployeeExport()` - 已实现
   - `doUserExport()` - 已实现

### 1.2 需要修复的问题 ❌

#### 问题1：ExportConsumer未处理USER_EXPORT类型

**位置**：`ExportConsumer.handleExportTask()`

**当前代码**：
```java
if ("EMPLOYEE_EXPORT".equals(exportTask.getTaskType())) {
    // 处理员工导出
    doEmployeeExport(exportTask, params);
} else {
    // 预留：其他类型导出
    log.warn("暂不支持的导出类型: {}", exportTask.getTaskType());
    exportTask.setStatus("FAILED");
    // ...
}
```

**问题**：只处理了`EMPLOYEE_EXPORT`，没有处理`USER_EXPORT`，导致用户导出任务会失败。

#### 问题2：doUserExport方法条件判断有bug

**位置**：`ExportConsumer.doUserExport()`

**当前代码**：
```java
if(params.getRole() !=null && params.getRole().isEmpty()){  // ❌ 错误！
    // ...
}
```

**问题**：条件判断错误，应该是`!= null && !params.getRole().isEmpty()`

#### 问题3：前端仍使用同步导出

**位置**：
- `frontend/src/pages/EmployeeList.tsx` - 使用`exportEmployees()`
- `frontend/src/pages/UserManagement.tsx` - 使用`exportUsers()`

**问题**：前端还在调用同步导出接口，需要改成异步导出。

---

## 二、后端修复方案

### 2.1 修复ExportConsumer.handleExportTask()

**文件**：`src/main/java/com/example/empmgmt/mq/consumer/ExportConsumer.java`

**修复代码**：

```java
@RabbitListener(queues = ExportMqConfig.EXPORT_QUEUE)
@Transactional
public void handleExportTask(ExportTaskMessage message){
    log.info("收到导出任务消息: {}", message);

    // 查询导出任务
    ExportTask exportTask = exportTaskRepository.findById(message.getTaskId()).orElseThrow(() ->
            new RuntimeException("导出任务不存在，taskId=" + message.getTaskId())
    );

    // 简单幂等：如果不是 PENDING，就不再处理
    if (!"PENDING".equals(exportTask.getStatus())) {
        log.info("导出任务状态不是PENDING，跳过。taskId={}, status={}", 
            exportTask.getId(), exportTask.getStatus());
        return;
    }

    try{
        // 更新任务状态为 PROCESSING
        exportTask.setStatus("PROCESSING");
        exportTask.setUpdatedAt(LocalDateTime.now());
        exportTaskRepository.save(exportTask);

        // 根据任务类型处理
        if ("EMPLOYEE_EXPORT".equals(exportTask.getTaskType())) {
            EmployeeExportParams params = objectMapper.readValue(
                    exportTask.getParams(),
                    EmployeeExportParams.class
            );
            // 执行员工导出
            doEmployeeExport(exportTask, params);
        } else if ("USER_EXPORT".equals(exportTask.getTaskType())) {  // ← 新增
            UserExportParams params = objectMapper.readValue(
                    exportTask.getParams(),
                    UserExportParams.class
            );
            // 执行用户导出
            doUserExport(exportTask, params);
        } else {
            // 不支持的导出类型
            log.warn("暂不支持的导出类型: {}", exportTask.getTaskType());
            exportTask.setStatus("FAILED");
            exportTask.setErrorMsg("不支持的导出类型: " + exportTask.getTaskType());
            exportTask.setUpdatedAt(LocalDateTime.now());
            exportTaskRepository.save(exportTask);
        }
    }catch (Exception e) {
        log.error("处理导出任务失败，taskId={}", exportTask.getId(), e);
        exportTask.setStatus("FAILED");
        exportTask.setErrorMsg(e.getMessage());
        exportTask.setUpdatedAt(LocalDateTime.now());
        exportTaskRepository.save(exportTask);
    }
}
```

### 2.2 修复doUserExport()条件判断

**文件**：`src/main/java/com/example/empmgmt/mq/consumer/ExportConsumer.java`

**修复代码**：

```java
private void doUserExport(ExportTask task, UserExportParams params) {
    // 1、查询数据
    List<User> users;
    // 修复：条件判断逻辑
    if (params.getRole() != null && !params.getRole().isEmpty()) {  // ← 修复
        if (params.getDepartment() != null && !params.getDepartment().isEmpty()) {
            users = userRepository.findByRoleAndDepartment(params.getRole(), params.getDepartment());
        } else {
            users = userRepository.findByRole(params.getRole());
        }
    } else {
        // 无过滤条件，查询所有用户
        users = userRepository.findAll();
    }

    // 2、转换为VO
    List<UserExportVO> voList = users.stream()
            .map(this::convertToUserVO)
            .toList();

    // 3. 生成文件（简单起见，写到本地磁盘）
    String fileName = "用户信息_" + LocalDateTime.now().format(FILE_NAME_FORMATTER) + ".xlsx";
    String dir = "D:/exports";
    File dirFile = new File(dir);
    if (!dirFile.exists()) {
        dirFile.mkdirs();
    }
    File file = new File(dirFile, fileName);
    
    // 使用 EasyExcel 写入文件
    EasyExcel.write(file, UserExportVO.class)
            .sheet("用户信息")
            .doWrite(voList);
    
    // 4. 更新任务状态为 SUCCESS
    task.setStatus("SUCCESS");
    task.setFilePath(file.getAbsolutePath());
    task.setUpdatedAt(LocalDateTime.now());
    exportTaskRepository.save(task);
    
    log.info("用户导出完成，taskId={}, file={}", task.getId(), file.getAbsolutePath());
}
```

---

## 三、前端修复方案

### 3.1 修改employee.ts API文件

**文件**：`frontend/src/api/employee.ts`

**新增异步导出API**：

```typescript
/**
 * 创建员工导出任务（异步）
 * @param department 部门筛选（可选）
 * @param position 职位筛选（可选）
 * @returns 任务ID
 */
export const createEmployeeExportTask = async (
  department?: string, 
  position?: string
): Promise<number> => {
  const params = new URLSearchParams()
  if (department) params.append('department', department)
  if (position) params.append('position', position)
  
  const response = await request.post<{ data: number }>(
    `/employ/export/async?${params.toString()}`
  )
  return response.data
}

/**
 * 查询导出任务状态
 * @param taskId 任务ID
 * @returns 任务信息
 */
export const getExportTask = async (taskId: number): Promise<{
  id: number
  taskType: string
  status: 'PENDING' | 'PROCESSING' | 'SUCCESS' | 'FAILED'
  filePath?: string
  errorMsg?: string
  createdAt: string
  updatedAt: string
}> => {
  return request.get(`/export-tasks/${taskId}`)
}

/**
 * 下载导出文件
 * @param taskId 任务ID
 */
export const downloadExportFile = async (taskId: number): Promise<void> => {
  const token = localStorage.getItem('token')
  
  const response = await axios.get(`/api/export-tasks/${taskId}/download`, {
    responseType: 'blob',
    withCredentials: true,
    headers: {
      Authorization: token ? `Bearer ${token}` : ''
    }
  })
  
  // 创建下载链接
  const blob = response.data instanceof Blob 
    ? response.data 
    : new Blob([response.data], { 
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
      })
  
  const url = window.URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  
  // 从响应头获取文件名
  const contentDisposition = response.headers['content-disposition']
  let fileName = '员工信息.xlsx'
  if (contentDisposition) {
    const fileNameMatch = contentDisposition.match(/filename\*=UTF-8''(.+)|filename="?([^"]+)"?/i)
    if (fileNameMatch) {
      fileName = fileNameMatch[1] 
        ? decodeURIComponent(fileNameMatch[1])
        : fileNameMatch[2] || fileName
    }
  }
  
  link.setAttribute('download', fileName)
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  window.URL.revokeObjectURL(url)
}
```

### 3.2 修改EmployeeList.tsx

**文件**：`frontend/src/pages/EmployeeList.tsx`

**修改导出函数**：

```typescript
import { 
  createEmployeeExportTask, 
  getExportTask, 
  downloadExportFile 
} from '../api/employee'

// 修改handleExport函数
const handleExport = async () => {
  try {
    const department = searchDepartment || undefined
    const position = undefined  // 职位筛选暂时不支持
    
    // 1. 创建导出任务
    message.loading('正在提交导出任务...', 0)
    const taskId = await createEmployeeExportTask(department, position)
    message.destroy()
    message.success('导出任务已提交，正在处理中...')
    
    // 2. 轮询查询任务状态
    const pollTask = async () => {
      try {
        const task = await getExportTask(taskId)
        
        if (task.status === 'SUCCESS') {
          // 任务完成，下载文件
          message.success('文件已生成，开始下载...')
          await downloadExportFile(taskId)
          message.success('下载成功')
        } else if (task.status === 'FAILED') {
          // 任务失败
          message.error('导出失败: ' + (task.errorMsg || '未知错误'))
        } else if (task.status === 'PROCESSING' || task.status === 'PENDING') {
          // 任务处理中，继续轮询
          setTimeout(pollTask, 2000)  // 2秒后再次查询
        }
      } catch (error: any) {
        message.error('查询任务状态失败: ' + (error.message || '未知错误'))
      }
    }
    
    // 开始轮询
    pollTask()
    
  } catch (err: any) {
    message.destroy()
    console.error('导出失败:', err)
    message.error('导出失败: ' + (err.message || '未知错误'))
  }
}
```

### 3.3 修改user.ts API文件

**文件**：`frontend/src/api/user.ts`

**新增异步导出API**（与employee.ts类似）：

```typescript
/**
 * 创建用户导出任务（异步）
 * @param role 角色筛选（可选）
 * @param department 部门筛选（可选）
 * @returns 任务ID
 */
export const createUserExportTask = async (
  role?: string, 
  department?: string
): Promise<number> => {
  const params = new URLSearchParams()
  if (role) params.append('role', role)
  if (department) params.append('department', department)
  
  const response = await request.post<{ data: number }>(
    `/users/export/async?${params.toString()}`
  )
  return response.data
}

/**
 * 下载导出文件（复用employee.ts中的函数，或单独实现）
 */
export const downloadExportFile = async (taskId: number): Promise<void> => {
  // 与employee.ts中的实现相同
  // ...
}
```

### 3.4 修改UserManagement.tsx

**文件**：`frontend/src/pages/UserManagement.tsx`

**修改导出函数**（与EmployeeList.tsx类似）：

```typescript
import { 
  createUserExportTask, 
  getExportTask, 
  downloadExportFile 
} from '../api/user'

// 修改handleExport函数
const handleExport = async () => {
  try {
    const role = filters.role || undefined
    const department = undefined  // UserManagement页面目前没有department筛选
    
    // 1. 创建导出任务
    message.loading('正在提交导出任务...', 0)
    const taskId = await createUserExportTask(role, department)
    message.destroy()
    message.success('导出任务已提交，正在处理中...')
    
    // 2. 轮询查询任务状态
    const pollTask = async () => {
      try {
        const task = await getExportTask(taskId)
        
        if (task.status === 'SUCCESS') {
          message.success('文件已生成，开始下载...')
          await downloadExportFile(taskId)
          message.success('下载成功')
        } else if (task.status === 'FAILED') {
          message.error('导出失败: ' + (task.errorMsg || '未知错误'))
        } else if (task.status === 'PROCESSING' || task.status === 'PENDING') {
          setTimeout(pollTask, 2000)
        }
      } catch (error: any) {
        message.error('查询任务状态失败: ' + (error.message || '未知错误'))
      }
    }
    
    pollTask()
    
  } catch (error: any) {
    message.destroy()
    console.error('导出失败:', error)
    message.error('导出失败: ' + (error.message || '未知错误'))
  }
}
```

---

## 四、后端自测方案

### 4.1 测试前准备

1. **启动RabbitMQ**
   ```bash
   # 使用Docker启动
   docker run -d --name rabbitmq \
     -p 5672:5672 -p 15672:15672 \
     rabbitmq:3-management
   ```

2. **检查配置**
   - 确认`application.yml`中RabbitMQ配置正确
   - 确认`D:/exports`目录存在或可创建

3. **准备测试数据**
   - 确保数据库中有员工数据
   - 确保数据库中有用户数据

### 4.2 测试步骤

#### 测试1：员工导出任务创建

**使用Postman或curl**：

```bash
POST http://localhost:8080/api/employ/export/async?department=技术部
Authorization: Bearer <your-token>
```

**预期结果**：
- 返回：`{ "code": 200, "data": 1, "message": "导出任务已提交" }`
- 数据库中`export_task`表新增一条记录，`status = 'PENDING'`
- RabbitMQ队列中有新消息

**验证SQL**：
```sql
SELECT * FROM export_task WHERE task_type = 'EMPLOYEE_EXPORT' ORDER BY id DESC LIMIT 1;
```

#### 测试2：查询任务状态

```bash
GET http://localhost:8080/api/export-tasks/1
Authorization: Bearer <your-token>
```

**预期结果**：
- 返回任务信息，包含`status`字段
- 几秒后，`status`从`PENDING`变为`PROCESSING`，再变为`SUCCESS`
- `filePath`字段有值，例如：`D:/exports/员工信息_20241201_120000.xlsx`

#### 测试3：检查文件是否生成

**手动检查**：
- 打开`D:/exports`目录
- 查看是否有新生成的Excel文件
- 打开文件，验证数据是否正确

#### 测试4：下载文件

```bash
GET http://localhost:8080/api/export-tasks/1/download
Authorization: Bearer <your-token>
```

**预期结果**：
- 浏览器自动下载Excel文件
- 文件内容与数据库数据一致

#### 测试5：用户导出任务

```bash
POST http://localhost:8080/api/users/export/async?role=MANAGER
Authorization: Bearer <your-token>
```

**预期结果**：
- 返回任务ID
- 任务状态正常流转
- 文件正常生成和下载

#### 测试6：错误场景测试

**测试6.1：任务不存在**
```bash
GET http://localhost:8080/api/export-tasks/99999
```

**预期**：返回404或错误信息

**测试6.2：任务未完成时下载**
```bash
GET http://localhost:8080/api/export-tasks/1/download
# 在任务状态为PENDING或PROCESSING时调用
```

**预期**：返回错误："任务未完成，无法下载"

**测试6.3：文件不存在时下载**
- 手动删除`D:/exports`中的文件
- 调用下载接口

**预期**：返回错误："文件不存在，请重新导出"

### 4.3 日志检查

**查看应用日志**，确认：

1. **生产者日志**：
   ```
   提交员工导出任务成功，taskId=1
   ```

2. **消费者日志**：
   ```
   收到导出任务消息: ExportTaskMessage{taskId=1, ...}
   员工导出完成，taskId=1, file=D:/exports/员工信息_xxx.xlsx
   ```

3. **错误日志**（如果有）：
   ```
   处理导出任务失败，taskId=1
   ```

### 4.4 RabbitMQ管理界面检查

**访问**：`http://localhost:15672`（guest/guest）

**检查项**：
1. **Queues** → `export.queue`
   - 查看消息数量（应该为0或很少）
   - 查看消费者数量（应该>0）

2. **Exchanges** → `export.exchange`
   - 查看消息发布数量

3. **Connections**
   - 确认有活跃连接

---

## 五、完整测试流程

### 5.1 端到端测试（E2E）

1. **启动服务**
   ```bash
   # 后端
   mvn spring-boot:run
   
   # 前端
   cd frontend
   npm run dev
   ```

2. **登录系统**
   - 使用管理员账号登录

3. **测试员工导出**
   - 进入员工列表页面
   - 点击"导出Excel"按钮
   - 观察提示信息："导出任务已提交，正在处理中..."
   - 等待几秒，观察是否自动下载文件
   - 验证文件内容

4. **测试用户导出**
   - 进入用户管理页面
   - 点击"导出Excel"按钮
   - 观察提示信息和下载过程
   - 验证文件内容

### 5.2 性能测试

**测试大量数据导出**：

1. **准备测试数据**
   - 在数据库中插入10000条员工记录

2. **执行导出**
   - 创建导出任务
   - 记录任务创建时间
   - 轮询查询任务状态
   - 记录任务完成时间

3. **验证**
   - 任务应该在合理时间内完成（< 1分钟）
   - 文件大小合理
   - 文件内容正确

---

## 六、常见问题排查

### 6.1 任务一直处于PENDING状态

**可能原因**：
- RabbitMQ未启动
- 消费者未启动
- 消息队列配置错误

**排查步骤**：
1. 检查RabbitMQ是否运行：`docker ps | grep rabbitmq`
2. 检查应用日志，看是否有消费者启动日志
3. 检查RabbitMQ管理界面，看队列中是否有消息

### 6.2 任务状态变为FAILED

**可能原因**：
- 数据库查询失败
- 文件写入失败（磁盘空间不足、权限问题）
- 参数解析失败

**排查步骤**：
1. 查看应用日志中的错误信息
2. 检查`export_task`表的`error_msg`字段
3. 检查`D:/exports`目录权限

### 6.3 下载文件失败

**可能原因**：
- 文件路径错误
- 文件已被删除
- 响应头设置错误

**排查步骤**：
1. 检查`export_task.file_path`字段
2. 手动访问文件路径，确认文件存在
3. 查看浏览器控制台错误信息

---

## 七、修复检查清单

### 后端修复 ✅

- [ ] 修复`ExportConsumer.handleExportTask()`，添加`USER_EXPORT`处理
- [ ] 修复`ExportConsumer.doUserExport()`条件判断
- [ ] 确认`ExportTaskController.download()`已正确实现

### 前端修复 ✅

- [ ] 在`employee.ts`中添加异步导出API
- [ ] 在`user.ts`中添加异步导出API
- [ ] 修改`EmployeeList.tsx`使用异步导出
- [ ] 修改`UserManagement.tsx`使用异步导出

### 测试 ✅

- [ ] 后端自测通过
- [ ] 前端功能测试通过
- [ ] 端到端测试通过

---

**文档完**

修复完成后，按照测试方案逐步验证功能。






