# åç«¯åŒTokenæœºåˆ¶è¯„ä¼°å’Œå‰ç«¯æ”¹é€ æŒ‡å—

## ä¸€ã€åç«¯åŒTokenæœºåˆ¶å®Œå–„åº¦è¯„ä¼°

### âœ… å·²å®Œå–„çš„éƒ¨åˆ†

#### 1. æ ¸å¿ƒåŠŸèƒ½å®Œæ•´
- âœ… **ç™»å½•æ¥å£** (`/api/auth/login`)
  - ç”ŸæˆATå’ŒRT
  - RTå­˜å…¥Redisï¼ˆkey: `auth:rt:userId:device`ï¼‰
  - RTé€šè¿‡HttpOnly Cookieè¿”å›
  - ATé€šè¿‡å“åº”ä½“è¿”å›
  - è®¾å¤‡æŒ‡çº¹ç”Ÿæˆï¼ˆUser-Agent + IPï¼‰

- âœ… **åˆ·æ–°æ¥å£** (`/api/auth/refresh`)
  - ä»Cookieæå–RT
  - ä»RediséªŒè¯RT
  - Tokenæ—‹è½¬ï¼ˆç”Ÿæˆæ–°AT+æ–°RTï¼Œåˆ é™¤æ—§RTï¼‰
  - æ›´æ–°Cookieä¸­çš„RT

- âœ… **ç™»å‡ºæ¥å£** (`/api/auth/logout`)
  - ATåŠ å…¥é»‘åå•ï¼ˆRedis: `auth:bl:jti`ï¼‰
  - åˆ é™¤RTï¼ˆRedisï¼‰
  - ä½¿Cookieè¿‡æœŸ

- âœ… **JWTè¿‡æ»¤å™¨** (`JwtAuthFilter`)
  - æå–å¹¶éªŒè¯AT
  - æ£€æŸ¥é»‘åå•
  - è®¾ç½®è®¤è¯ä¿¡æ¯

- âœ… **RedisæœåŠ¡** (`AuthTokenService`)
  - RTå­˜å‚¨å’ŒæŸ¥è¯¢
  - é»‘åå•ç®¡ç†

#### 2. å®‰å…¨é…ç½®
- âœ… CORSå·²é…ç½®`allowCredentials: true`
- âœ… Cookieè®¾ç½®ä¸ºHttpOnlyï¼ˆé˜²XSSï¼‰
- âœ… Tokenæ—‹è½¬æœºåˆ¶ï¼ˆé˜²æ­¢RTæ³„éœ²è¢«é•¿æœŸä½¿ç”¨ï¼‰

### âš ï¸ éœ€è¦æ³¨æ„çš„ç‚¹

#### 1. Cookie Secureè®¾ç½®
```java
// å½“å‰ä»£ç 
.secure(true)  // ä»…HTTPSä¼ è¾“
```
**é—®é¢˜**ï¼šå¼€å‘ç¯å¢ƒï¼ˆlocalhostï¼‰é€šå¸¸ä½¿ç”¨HTTPï¼Œsecure=trueä¼šå¯¼è‡´Cookieæ— æ³•å‘é€ã€‚

**å»ºè®®**ï¼šæ ¹æ®ç¯å¢ƒåŠ¨æ€è®¾ç½®
```java
@Value("${app.https.enabled:false}")
private boolean httpsEnabled;

.secure(httpsEnabled)  // å¼€å‘ç¯å¢ƒfalseï¼Œç”Ÿäº§ç¯å¢ƒtrue
```

#### 2. SameSiteè®¾ç½®
```java
// å½“å‰ä»£ç 
.sameSite("None")  // æ”¯æŒè·¨åŸŸ
```
**æ³¨æ„**ï¼šSameSite=Noneå¿…é¡»é…åˆSecure=trueä½¿ç”¨ï¼Œåœ¨å¼€å‘ç¯å¢ƒå¯èƒ½æœ‰é—®é¢˜ã€‚

**å»ºè®®**ï¼š
```java
.sameSite(httpsEnabled ? "None" : "Lax")
```

### ğŸ“‹ åç«¯å®Œå–„åº¦æ€»ç»“

**æ•´ä½“è¯„åˆ†ï¼š9/10** âœ…

**æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œåªéœ€å¾®è°ƒå¼€å‘/ç”Ÿäº§ç¯å¢ƒçš„é…ç½®å³å¯ã€‚**

---

## äºŒã€å‰ç«¯æ”¹é€ è¯¦ç»†æŒ‡å—

### å½“å‰å‰ç«¯çŠ¶æ€åˆ†æ

#### âœ… å·²å®Œæˆ
1. âœ… axiosæ‹¦æˆªå™¨å·²å®ç°æ— æ„Ÿåˆ·æ–°
2. âœ… withCredentialså·²é…ç½®
3. âœ… åˆ·æ–°æ¥å£APIæ–¹æ³•å·²å®šä¹‰

#### âŒ éœ€è¦æ”¹é€ 
1. âŒ ç™»å½•é¡µé¢æœªæ›´æ–°authStore
2. âŒ æœªè°ƒç”¨ç™»å‡ºæ¥å£
3. âŒ ç™»å½•æˆåŠŸæœªä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°authStore

---

## ä¸‰ã€å‰ç«¯æ”¹é€ æ­¥éª¤è¯¦è§£

### æ­¥éª¤1ï¼šæ£€æŸ¥å¹¶å®Œå–„ç™»å½•é¡µé¢

**æ–‡ä»¶ä½ç½®ï¼š** `frontend/src/pages/Login.tsx`

#### éœ€è¦æ£€æŸ¥çš„ç‚¹ï¼š

1. **ç™»å½•æˆåŠŸåï¼Œéœ€è¦è°ƒç”¨authStore.setAuth()**
2. **éœ€è¦ä¿å­˜å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯**

#### æ”¹é€ æ€è·¯ï¼š

```typescript
// 1. å¯¼å…¥authStore
import { useAuthStore } from '../stores/authStore'
import { login } from '../api/auth'
import { useNavigate } from 'react-router-dom'

// 2. åœ¨ç™»å½•å‡½æ•°ä¸­
const handleLogin = async (values: LoginRequest) => {
  try {
    // è°ƒç”¨ç™»å½•æ¥å£
    const authResponse = await login(values)
    
    // âœ… å…³é”®ï¼šæ›´æ–°authStoreï¼ˆä¿å­˜ATå’Œç”¨æˆ·ä¿¡æ¯ï¼‰
    useAuthStore.getState().setAuth(
      authResponse.token,           // AT
      authResponse.username,        // ç”¨æˆ·å
      authResponse.role,            // è§’è‰²
      authResponse.department,      // éƒ¨é—¨
      authResponse.employeeId       // å‘˜å·¥ID
    )
    
    // è·³è½¬åˆ°é¦–é¡µ
    navigate('/')
  } catch (error) {
    message.error('ç™»å½•å¤±è´¥')
  }
}
```

#### å®Œæ•´ç¤ºä¾‹ä»£ç ï¼ˆå‚è€ƒï¼‰ï¼š

```typescript
import { useState } from 'react'
import { Form, Input, Button, message } from 'antd'
import { UserOutlined, LockOutlined } from '@ant-design/icons'
import { useNavigate } from 'react-router-dom'
import { useAuthStore } from '../stores/authStore'
import { login, LoginRequest } from '../api/auth'

const Login = () => {
  const navigate = useNavigate()
  const setAuth = useAuthStore((state) => state.setAuth)
  const [loading, setLoading] = useState(false)

  const onFinish = async (values: LoginRequest) => {
    setLoading(true)
    try {
      // è°ƒç”¨ç™»å½•æ¥å£
      const authResponse = await login({
        username: values.username,
        password: values.password,
      })

      // âœ… å…³é”®æ­¥éª¤ï¼šæ›´æ–°authStoreï¼Œä¿å­˜ATå’Œç”¨æˆ·ä¿¡æ¯
      // æ³¨æ„ï¼šRTä¼šè‡ªåŠ¨ä¿å­˜åœ¨Cookieä¸­ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
      setAuth(
        authResponse.token,        // ATä¿å­˜åˆ°localStorage
        authResponse.username,     // ç”¨æˆ·å
        authResponse.role,         // è§’è‰²
        authResponse.department,   // éƒ¨é—¨
        authResponse.employeeId    // å‘˜å·¥ID
      )

      message.success('ç™»å½•æˆåŠŸ')
      navigate('/')  // è·³è½¬åˆ°é¦–é¡µ
    } catch (error: any) {
      message.error(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Form onFinish={onFinish}>
      <Form.Item name="username" rules={[{ required: true }]}>
        <Input prefix={<UserOutlined />} placeholder="ç”¨æˆ·å" />
      </Form.Item>
      <Form.Item name="password" rules={[{ required: true }]}>
        <Input.Password prefix={<LockOutlined />} placeholder="å¯†ç " />
      </Form.Item>
      <Form.Item>
        <Button type="primary" htmlType="submit" loading={loading} block>
          ç™»å½•
        </Button>
      </Form.Item>
    </Form>
  )
}

export default Login
```

**å…³é”®ç‚¹ï¼š**
- âœ… ç™»å½•æˆåŠŸåå¿…é¡»è°ƒç”¨`setAuth()`ä¿å­˜ATå’Œç”¨æˆ·ä¿¡æ¯
- âœ… RTä¼šè‡ªåŠ¨ä¿å­˜åœ¨Cookieä¸­ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
- âœ… localStorageåªä¿å­˜ATï¼Œä¸ä¿å­˜RTï¼ˆRTåœ¨Cookieä¸­ï¼‰

---

### æ­¥éª¤2ï¼šæ·»åŠ ç™»å‡ºåŠŸèƒ½

#### éœ€è¦æ·»åŠ ç™»å‡ºæ¥å£

**æ–‡ä»¶ä½ç½®ï¼š** `frontend/src/api/auth.ts`

#### æ·»åŠ ç™»å‡ºAPIæ–¹æ³•ï¼š

```typescript
/**
 * ç”¨æˆ·ç™»å‡º
 * è°ƒç”¨åç«¯ç™»å‡ºæ¥å£ï¼Œæ¸…é™¤RTå’ŒAT
 * @returns ç™»å‡ºå“åº”
 */
export const logout = (): Promise<void> => {
  return request.post('/auth/logout')
}
```

#### å®Œæ•´auth.tsç¤ºä¾‹ï¼š

```typescript
/**
 * è®¤è¯ç›¸å…³API
 */
import request from '../utils/request'
import { LoginRequest, RegisterRequest, AuthResponse } from '../types'

export const login = (data: LoginRequest): Promise<AuthResponse> => {
  return request.post('/auth/login', data)
}

export const register = (data: RegisterRequest): Promise<AuthResponse> => {
  return request.post('/auth/register', data)
}

/**
 * åˆ·æ–°Token
 * æ³¨æ„ï¼šRTä¼šè‡ªåŠ¨ä»Cookieä¸­å‘é€ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’
 * é€šå¸¸ç”±axiosæ‹¦æˆªå™¨è‡ªåŠ¨è°ƒç”¨ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
 */
export const refresh = (): Promise<AuthResponse> => {
  return request.post('/auth/refresh')
}

/**
 * ç”¨æˆ·ç™»å‡º
 * è°ƒç”¨åç«¯ç™»å‡ºæ¥å£ï¼Œåç«¯ä¼šï¼š
 * 1. å°†ATåŠ å…¥é»‘åå•
 * 2. åˆ é™¤Redisä¸­çš„RT
 * 3. ä½¿Cookieè¿‡æœŸ
 */
export const logout = (): Promise<void> => {
  return request.post('/auth/logout')
}
```

#### åœ¨Layoutç»„ä»¶æˆ–Headerç»„ä»¶ä¸­æ·»åŠ ç™»å‡ºæŒ‰é’®

**æ–‡ä»¶ä½ç½®ï¼š** `frontend/src/components/Layout.tsx` æˆ– `frontend/src/components/Header.tsx`

#### æ·»åŠ ç™»å‡ºå¤„ç†ï¼š

```typescript
import { useNavigate } from 'react-router-dom'
import { Button, message } from 'antd'
import { useAuthStore } from '../stores/authStore'
import { logout } from '../api/auth'

const Layout = () => {
  const navigate = useNavigate()
  const clearAuth = useAuthStore((state) => state.clearAuth)
  const username = useAuthStore((state) => state.username)

  const handleLogout = async () => {
    try {
      // 1. è°ƒç”¨åç«¯ç™»å‡ºæ¥å£
      await logout()
      // åç«¯ä¼šï¼š
      // - å°†ATåŠ å…¥é»‘åå•
      // - åˆ é™¤Redisä¸­çš„RT
      // - ä½¿Cookieè¿‡æœŸ

      // 2. æ¸…é™¤å‰ç«¯çŠ¶æ€
      clearAuth()  // æ¸…é™¤localStorageä¸­çš„ATå’Œç”¨æˆ·ä¿¡æ¯

      // 3. è·³è½¬åˆ°ç™»å½•é¡µ
      message.success('å·²é€€å‡ºç™»å½•')
      navigate('/login')
    } catch (error) {
      message.error('é€€å‡ºç™»å½•å¤±è´¥')
      // å³ä½¿åç«¯å¤±è´¥ï¼Œä¹Ÿæ¸…é™¤å‰ç«¯çŠ¶æ€
      clearAuth()
      navigate('/login')
    }
  }

  return (
    <div>
      <div>
        <span>æ¬¢è¿ï¼Œ{username}</span>
        <Button onClick={handleLogout}>é€€å‡ºç™»å½•</Button>
      </div>
      {/* å…¶ä»–å†…å®¹ */}
    </div>
  )
}
```

**å…³é”®ç‚¹ï¼š**
- âœ… ç™»å‡ºæ—¶è°ƒç”¨åç«¯æ¥å£ï¼ˆæ¸…é™¤RTå’Œé»‘åå•ATï¼‰
- âœ… æ¸…é™¤å‰ç«¯authStoreçŠ¶æ€
- âœ… è·³è½¬åˆ°ç™»å½•é¡µ

---

### æ­¥éª¤3ï¼šå®Œå–„authStoreï¼ˆå¦‚æœéœ€è¦ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `frontend/src/stores/authStore.ts`

#### å½“å‰authStoreåˆ†æï¼š

ä½ çš„authStoreå·²ç»æ¯”è¾ƒå®Œå–„ï¼Œä½†å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–¹æ³•æ–¹ä¾¿è·å–ç”¨æˆ·ä¿¡æ¯ã€‚

#### å¯é€‰ä¼˜åŒ–ï¼š

```typescript
interface AuthState {
  // ... ç°æœ‰å­—æ®µ ...

  // æ·»åŠ è·å–ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•
  getUserInfo: () => {
    username: string | null
    role: string | null
    department: string | null
    employeeId: number | null
  }
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      // ... ç°æœ‰çŠ¶æ€ ...

      // è·å–ç”¨æˆ·ä¿¡æ¯
      getUserInfo: () => {
        const state = get()
        return {
          username: state.username,
          role: state.role,
          department: state.department,
          employeeId: state.employeeId,
        }
      },
    }),
    {
      name: 'auth-storage',
    }
  )
)
```

---

### æ­¥éª¤4ï¼šæ£€æŸ¥è·¯ç”±å®ˆå«ï¼ˆå¦‚æœéœ€è¦ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** é€šå¸¸æ˜¯ `frontend/src/App.tsx` æˆ–è·¯ç”±é…ç½®æ–‡ä»¶

#### éœ€è¦æ·»åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼š

```typescript
import { Navigate } from 'react-router-dom'
import { useAuthStore } from './stores/authStore'

// è·¯ç”±å®ˆå«ç»„ä»¶
const ProtectedRoute = ({ children }: { children: React.ReactNode }) => {
  const isAuthenticated = useAuthStore((state) => state.isAuthenticated)
  const token = useAuthStore((state) => state.token)

  // å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
  if (!isAuthenticated || !token) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}

// åœ¨è·¯ç”±ä¸­ä½¿ç”¨
<Routes>
  <Route path="/login" element={<Login />} />
  <Route
    path="/employees"
    element={
      <ProtectedRoute>
        <EmployeeList />
      </ProtectedRoute>
    }
  />
  {/* å…¶ä»–è·¯ç”± */}
</Routes>
```

---

### æ­¥éª¤5ï¼šå¤„ç†åˆ·æ–°Tokenæ—¶çš„ç”¨æˆ·ä¿¡æ¯æ›´æ–°

#### å½“å‰é—®é¢˜ï¼š

åˆ·æ–°Tokenæ—¶ï¼Œåç«¯ä¼šè¿”å›æ–°çš„ATï¼Œä½†å¯èƒ½æ²¡æœ‰è¿”å›ç”¨æˆ·ä¿¡æ¯ã€‚

#### è§£å†³æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ1ï¼šåˆ·æ–°æ—¶ä¹Ÿæ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¨èï¼‰**

ä¿®æ”¹`frontend/src/utils/request.ts`ä¸­çš„`refreshToken`å‡½æ•°ï¼š

```typescript
const refreshToken = async (): Promise<string | null> => {
  try {
    const response = await axios.post('/api/auth/refresh', {}, {
      withCredentials: true,
    })
    
    const res = response.data as ApiResult<any>
    if (res.code === 200 && res.data?.token) {
      const authData = res.data
      
      // æ›´æ–°localStorageä¸­çš„AT
      localStorage.setItem('token', authData.token)
      
      // âœ… å¦‚æœåç«¯è¿”å›äº†ç”¨æˆ·ä¿¡æ¯ï¼Œæ›´æ–°authStore
      if (authData.username) {
        useAuthStore.getState().setAuth(
          authData.token,
          authData.username,
          authData.role,
          authData.department,
          authData.employeeId
        )
      }
      
      return authData.token
    }
    return null
  } catch (error) {
    console.error('åˆ·æ–°Tokenå¤±è´¥:', error)
    return null
  }
}
```

**æ–¹æ¡ˆ2ï¼šåç«¯ç¡®ä¿åˆ·æ–°æ¥å£è¿”å›ç”¨æˆ·ä¿¡æ¯**

æ£€æŸ¥åç«¯`AuthController.refresh()`æ–¹æ³•ï¼Œç¡®ä¿è¿”å›å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ï¼š

```java
// å½“å‰ä»£ç å·²ç»è¿”å›äº†ç”¨æˆ·ä¿¡æ¯
AuthResponse ar = AuthResponse.of(newAt, jwtUtil.getAccessTtlMs(), 
    user.getUsername(),
    user.getRole(), 
    user.getDepartment(), 
    user.getEmployeeId());
```

æ‰€ä»¥åç«¯å·²ç»å®Œå–„ï¼Œå‰ç«¯åªéœ€æŒ‰ç…§æ–¹æ¡ˆ1æ›´æ–°å³å¯ã€‚

---

## å››ã€å‰ç«¯æ”¹é€ æ£€æŸ¥æ¸…å•

### âœ… å¿…é¡»å®Œæˆçš„æ”¹é€ 

- [ ] **æ­¥éª¤1ï¼šç™»å½•é¡µé¢**
  - [ ] ç™»å½•æˆåŠŸåè°ƒç”¨`authStore.setAuth()`ä¿å­˜ATå’Œç”¨æˆ·ä¿¡æ¯
  - [ ] ç¡®è®¤RTä¸éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼ˆè‡ªåŠ¨ä¿å­˜åœ¨Cookieä¸­ï¼‰

- [ ] **æ­¥éª¤2ï¼šç™»å‡ºåŠŸèƒ½**
  - [ ] æ·»åŠ `logout` APIæ–¹æ³•
  - [ ] åœ¨Layout/Headerä¸­æ·»åŠ ç™»å‡ºæŒ‰é’®
  - [ ] ç™»å‡ºæ—¶è°ƒç”¨åç«¯æ¥å£å¹¶æ¸…é™¤å‰ç«¯çŠ¶æ€

- [ ] **æ­¥éª¤3ï¼šåˆ·æ–°Tokenæ—¶çš„ç”¨æˆ·ä¿¡æ¯æ›´æ–°**
  - [ ] ä¿®æ”¹`refreshToken`å‡½æ•°ï¼Œæ›´æ–°authStoreä¸­çš„ç”¨æˆ·ä¿¡æ¯

### ğŸ” å¯é€‰ä¼˜åŒ–

- [ ] **è·¯ç”±å®ˆå«**
  - [ ] æ·»åŠ ProtectedRouteç»„ä»¶
  - [ ] æœªç™»å½•ç”¨æˆ·è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

- [ ] **é”™è¯¯å¤„ç†**
  - [ ] ç½‘ç»œé”™è¯¯æç¤º
  - [ ] Tokenåˆ·æ–°å¤±è´¥çš„å‹å¥½æç¤º

- [ ] **ç”¨æˆ·ä½“éªŒ**
  - [ ] ç™»å½•åŠ è½½çŠ¶æ€
  - [ ] ç™»å‡ºç¡®è®¤å¯¹è¯æ¡†

---

## äº”ã€æµ‹è¯•è¦ç‚¹

### 1. ç™»å½•æµ‹è¯•

```typescript
// æµ‹è¯•æ­¥éª¤ï¼š
1. è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œç‚¹å‡»ç™»å½•
2. æ£€æŸ¥Networké¢æ¿ï¼š
   - POST /api/auth/login è¿”å›200
   - Response Headersä¸­æœ‰ Set-Cookie: rt=...
   - Response Bodyä¸­æœ‰ token (AT)
3. æ£€æŸ¥Applicationé¢æ¿ï¼š
   - Local Storageä¸­æœ‰ token
   - Cookiesä¸­æœ‰ rt (HttpOnly)
4. æ£€æŸ¥authStoreï¼š
   - isAuthenticated = true
   - token = ATå­—ç¬¦ä¸²
   - usernameã€roleç­‰ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜
```

### 2. APIè¯·æ±‚æµ‹è¯•

```typescript
// æµ‹è¯•æ­¥éª¤ï¼š
1. ç™»å½•æˆåŠŸåï¼Œè®¿é—®éœ€è¦è®¤è¯çš„æ¥å£ï¼ˆå¦‚ /api/employeesï¼‰
2. æ£€æŸ¥Networké¢æ¿ï¼š
   - Request Headersä¸­æœ‰ Authorization: Bearer AT
   - Cookiesè‡ªåŠ¨å‘é€ rt
3. æ¥å£è¿”å›200ï¼Œæ•°æ®æ­£å¸¸
```

### 3. æ— æ„Ÿåˆ·æ–°æµ‹è¯•

```typescript
// æµ‹è¯•æ­¥éª¤ï¼š
1. ç™»å½•åï¼Œç­‰å¾…30åˆ†é’Ÿï¼ˆæˆ–æ‰‹åŠ¨ä¿®æ”¹ATè¿‡æœŸï¼‰
2. å‘èµ·ä¸€ä¸ªAPIè¯·æ±‚
3. æ£€æŸ¥Networké¢æ¿ï¼š
   - ç¬¬ä¸€ä¸ªè¯·æ±‚è¿”å›401
   - è‡ªåŠ¨å‘èµ· POST /api/auth/refresh
   - åˆ·æ–°æˆåŠŸåï¼Œè‡ªåŠ¨é‡è¯•åŸè¯·æ±‚
   - æœ€ç»ˆè¿”å›200
4. ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œæ“ä½œç»§ç»­æ­£å¸¸
```

### 4. ç™»å‡ºæµ‹è¯•

```typescript
// æµ‹è¯•æ­¥éª¤ï¼š
1. ç™»å½•åï¼Œç‚¹å‡»ç™»å‡ºæŒ‰é’®
2. æ£€æŸ¥Networké¢æ¿ï¼š
   - POST /api/auth/logout è¿”å›200
3. æ£€æŸ¥Applicationé¢æ¿ï¼š
   - Local Storageä¸­çš„tokenå·²æ¸…é™¤
   - Cookiesä¸­çš„rtå·²è¿‡æœŸï¼ˆæˆ–åˆ é™¤ï¼‰
4. æ£€æŸ¥authStoreï¼š
   - isAuthenticated = false
   - token = null
5. å°è¯•è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£ï¼š
   - åº”è¯¥è¢«è·¯ç”±å®ˆå«æ‹¦æˆªï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
```

### 5. å¤šè®¾å¤‡æµ‹è¯•

```typescript
// æµ‹è¯•æ­¥éª¤ï¼š
1. åœ¨ç”µè„‘Aç™»å½•
2. åœ¨ç”µè„‘Bï¼ˆæˆ–æ‰‹æœºï¼‰ç™»å½•
3. ä¸¤ä¸ªè®¾å¤‡åº”è¯¥éƒ½èƒ½æ­£å¸¸ä½¿ç”¨
4. åœ¨è®¾å¤‡Aç™»å‡ºï¼š
   - è®¾å¤‡Aæ— æ³•è®¿é—®
   - è®¾å¤‡Bä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨
```

---

## å…­ã€å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šCookieæ— æ³•å‘é€

**ç—‡çŠ¶**ï¼šåˆ·æ–°æ¥å£è¿”å›401ï¼Œæç¤º"ç¼ºå°‘åˆ·æ–°ä»¤ç‰Œ"

**å¯èƒ½åŸå› ï¼š**
1. `withCredentials`æœªè®¾ç½®
2. CORSé…ç½®é”™è¯¯
3. Cookie Secureè®¾ç½®å¯¼è‡´ï¼ˆå¼€å‘ç¯å¢ƒHTTPï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// 1. ç¡®ä¿axiosé…ç½®ä¸­æœ‰
withCredentials: true

// 2. æ£€æŸ¥åç«¯CORSé…ç½®
config.setAllowCredentials(true);

// 3. å¼€å‘ç¯å¢ƒCookie Secureè®¾ç½®ä¸ºfalse
.secure(httpsEnabled)  // å¼€å‘ç¯å¢ƒfalse
```

### é—®é¢˜2ï¼šåˆ·æ–°æ¥å£è¢«æ‹¦æˆª

**ç—‡çŠ¶**ï¼šåˆ·æ–°æ¥å£è¿”å›401ï¼Œè¿›å…¥æ— é™å¾ªç¯

**æ£€æŸ¥ç‚¹ï¼š**
- åˆ·æ–°æ¥å£åº”è¯¥å…è®¸æœªè®¤è¯è®¿é—®
- æ£€æŸ¥SecurityConfigï¼Œç¡®ä¿`/api/auth/**`æ˜¯permitAll

### é—®é¢˜3ï¼šç”¨æˆ·ä¿¡æ¯ä¸¢å¤±

**ç—‡çŠ¶**ï¼šåˆ·æ–°Tokenåï¼Œç”¨æˆ·ä¿¡æ¯ï¼ˆroleã€departmentï¼‰ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿åˆ·æ–°æ¥å£è¿”å›å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
- åˆ·æ–°æˆåŠŸåæ›´æ–°authStore

### é—®é¢˜4ï¼šå¹¶å‘è¯·æ±‚å¯¼è‡´å¤šæ¬¡åˆ·æ–°

**ç—‡çŠ¶**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶è¿”å›401ï¼Œå¯¼è‡´å¤šæ¬¡è°ƒç”¨åˆ·æ–°æ¥å£

**å·²è§£å†³**ï¼šå½“å‰ä»£ç å·²å®ç°é˜Ÿåˆ—æœºåˆ¶ï¼Œä¸ä¼šé‡å¤åˆ·æ–°ã€‚

---

## ä¸ƒã€æ€»ç»“

### åç«¯çŠ¶æ€ï¼šâœ… å®Œå–„ï¼ˆ9/10ï¼‰

**æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œåªéœ€æ³¨æ„å¼€å‘/ç”Ÿäº§ç¯å¢ƒçš„Cookieé…ç½®å·®å¼‚ã€‚**

### å‰ç«¯æ”¹é€ ï¼šğŸ“‹ éœ€è¦å®Œæˆ3ä¸ªæ­¥éª¤

1. **ç™»å½•é¡µé¢**ï¼šä¿å­˜ATå’Œç”¨æˆ·ä¿¡æ¯åˆ°authStore
2. **ç™»å‡ºåŠŸèƒ½**ï¼šæ·»åŠ ç™»å‡ºAPIè°ƒç”¨
3. **åˆ·æ–°ä¼˜åŒ–**ï¼šåˆ·æ–°æ—¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯

### å…³é”®ç‚¹

1. âœ… RTè‡ªåŠ¨ä¿å­˜åœ¨Cookieä¸­ï¼Œå‰ç«¯æ— éœ€æ‰‹åŠ¨å¤„ç†
2. âœ… ATä¿å­˜åœ¨localStorageï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†
3. âœ… æ— æ„Ÿåˆ·æ–°å·²å®ç°ï¼Œæ— éœ€é¢å¤–ä»£ç 
4. âœ… ç™»å‡ºæ—¶å¿…é¡»è°ƒç”¨åç«¯æ¥å£ï¼Œæ¸…é™¤RTå’Œé»‘åå•AT

**æŒ‰ç…§ä¸Šè¿°æ­¥éª¤å®Œæˆæ”¹é€ åï¼ŒåŒTokenæœºåˆ¶å³å¯å®Œå…¨æ­£å¸¸å·¥ä½œï¼** ğŸ‰

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2024å¹´
