# ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®Œæ•´å®ç°æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
3. [åç«¯å®ç°](#åç«¯å®ç°)
4. [å‰ç«¯å®ç°](#å‰ç«¯å®ç°)
5. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)
6. [æµ‹è¯•æ–¹æ¡ˆ](#æµ‹è¯•æ–¹æ¡ˆ)

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½æ¸…å•

UserController éœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

| åŠŸèƒ½ | HTTPæ–¹æ³• | è·¯å¾„ | æƒé™è¦æ±‚ | è¯´æ˜ |
|------|---------|------|---------|------|
| è·å–ç”¨æˆ·åˆ—è¡¨ | GET | `/api/users` | SUPER_ADMIN | åˆ†é¡µæŸ¥è¯¢ï¼Œæ”¯æŒç­›é€‰ |
| è·å–å•ä¸ªç”¨æˆ· | GET | `/api/users/{id}` | SUPER_ADMIN | æ ¹æ®IDæŸ¥è¯¢ |
| åˆ›å»ºç”¨æˆ· | POST | `/api/users` | SUPER_ADMIN | åˆ›å»ºæ–°ç”¨æˆ·è´¦å· |
| æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | PUT | `/api/users/{id}` | SUPER_ADMIN | æ›´æ–°ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ |
| ç¦ç”¨/å¯ç”¨ç”¨æˆ· | PUT | `/api/users/{id}/status` | SUPER_ADMIN | æ³¨é”€æˆ–å¯ç”¨ç”¨æˆ· |
| åˆ†é…è§’è‰² | PUT | `/api/users/{id}/role` | SUPER_ADMIN | ä¿®æ”¹ç”¨æˆ·è§’è‰² |
| åˆ é™¤ç”¨æˆ· | DELETE | `/api/users/{id}` | SUPER_ADMIN | è½¯åˆ é™¤æˆ–ç¡¬åˆ é™¤ |
| é‡ç½®å¯†ç  | PUT | `/api/users/{id}/password` | SUPER_ADMIN | ç®¡ç†å‘˜é‡ç½®ç”¨æˆ·å¯†ç  |

### 1.2 ä¸šåŠ¡è§„åˆ™

1. **ç”¨æˆ·åå”¯ä¸€æ€§**ï¼šç³»ç»Ÿä¸­ç”¨æˆ·åå¿…é¡»å”¯ä¸€
2. **è§’è‰²é™åˆ¶**ï¼šåªèƒ½åˆ†é… SUPER_ADMINã€MANAGERã€EMPLOYEE ä¸‰ç§è§’è‰²
3. **éƒ¨é—¨å…³è”**ï¼šMANAGER è§’è‰²å¿…é¡»æŒ‡å®šéƒ¨é—¨ï¼ŒEMPLOYEE è§’è‰²å¯é€‰å…³è”å‘˜å·¥ID
4. **çŠ¶æ€ç®¡ç†**ï¼šç¦ç”¨çš„ç”¨æˆ·æ— æ³•ç™»å½•ç³»ç»Ÿ
5. **å®‰å…¨æ€§**ï¼šå¯†ç å¿…é¡»åŠ å¯†å­˜å‚¨ï¼Œé»˜è®¤å¯†ç ä¸º "123456"

---

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 è¡¨ç»“æ„è¯´æ˜

`user_account` è¡¨å·²å­˜åœ¨ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```sql
-- ç”¨æˆ·è´¦å·è¡¨
CREATE TABLE user_account (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    role VARCHAR(50) DEFAULT 'EMPLOYEE',      -- è§’è‰²ï¼šSUPER_ADMIN/MANAGER/EMPLOYEE
    department VARCHAR(100),                   -- éƒ¨é—¨ï¼ˆMANAGERä½¿ç”¨ï¼‰
    employee_id BIGINT,                        -- å…³è”å‘˜å·¥IDï¼ˆEMPLOYEEä½¿ç”¨ï¼‰
    enabled BOOLEAN DEFAULT TRUE,              -- æ˜¯å¦å¯ç”¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    CONSTRAINT fk_employee FOREIGN KEY (employee_id) REFERENCES employee(id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_role ON user_account(role);
CREATE INDEX idx_user_enabled ON user_account(enabled);
CREATE INDEX idx_user_department ON user_account(department);
```

### 2.2 åˆå§‹åŒ–æ•°æ®

```sql
-- åˆ›å»ºè¶…çº§ç®¡ç†å‘˜è´¦å·ï¼ˆå¯†ç ï¼šadmin123ï¼‰
INSERT INTO user_account (username, password, role, email, enabled)
VALUES ('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lZN7.9Ng.XUH8BNSS', 
        'SUPER_ADMIN', 'admin@example.com', true);

-- åˆ›å»ºæµ‹è¯•éƒ¨é—¨ç»ç†ï¼ˆå¯†ç ï¼š123456ï¼‰
INSERT INTO user_account (username, password, role, department, email, enabled)
VALUES ('manager_tech', '$2a$10$5Z9p8fBqXvGWEn5ZqkayVO62PzKcl5RJZWkFdVf3WJJj.iuH8aVjK',
        'MANAGER', 'æŠ€æœ¯éƒ¨', 'manager_tech@example.com', true);

-- åˆ›å»ºæµ‹è¯•å‘˜å·¥ï¼ˆå¯†ç ï¼š123456ï¼‰
INSERT INTO user_account (username, password, role, employee_id, email, enabled)
VALUES ('employee1', '$2a$10$5Z9p8fBqXvGWEn5ZqkayVO62PzKcl5RJZWkFdVf3WJJj.iuH8aVjK',
        'EMPLOYEE', 1, 'employee1@example.com', true);
```

---

## 3. åç«¯å®ç°

### 3.1 DTO å®šä¹‰

#### 3.1.1 `UserResponse.java` - ç”¨æˆ·å“åº” DTO

```java
package com.example.empmgmt.dto.response;

import lombok.Data;
import java.time.LocalDateTime;

/**
 * ç”¨æˆ·å“åº”DTO
 */
@Data
public class UserResponse {
    private Long id;
    private String username;
    private String email;
    private String role;           // SUPER_ADMIN/MANAGER/EMPLOYEE
    private String department;     // éƒ¨é—¨
    private Long employeeId;       // å…³è”çš„å‘˜å·¥ID
    private Boolean enabled;       // æ˜¯å¦å¯ç”¨
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    /**
     * ä»Userå®ä½“è½¬æ¢ä¸ºUserResponse
     */
    public static UserResponse fromEntity(com.example.empmgmt.domain.User user) {
        UserResponse response = new UserResponse();
        response.setId(user.getId());
        response.setUsername(user.getUsername());
        response.setEmail(user.getEmail());
        response.setRole(user.getRole());
        response.setDepartment(user.getDepartment());
        response.setEmployeeId(user.getEmployeeId());
        response.setEnabled(user.getEnabled());
        response.setCreatedAt(user.getCreatedAt());
        response.setUpdatedAt(user.getUpdatedAt());
        return response;
    }
}
```

#### 3.1.2 `UserCreateRequest.java` - åˆ›å»ºç”¨æˆ·è¯·æ±‚ DTO

```java
package com.example.empmgmt.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import lombok.Data;

/**
 * åˆ›å»ºç”¨æˆ·è¯·æ±‚DTO
 */
@Data
public class UserCreateRequest {
    
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^[a-zA-Z0-9_]{3,20}$", 
             message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œé•¿åº¦3-20")
    private String username;

    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;

    @NotBlank(message = "è§’è‰²ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^(SUPER_ADMIN|MANAGER|EMPLOYEE)$", 
             message = "è§’è‰²åªèƒ½æ˜¯ SUPER_ADMIN/MANAGER/EMPLOYEE")
    private String role;

    private String department;    // MANAGERè§’è‰²å¿…å¡«

    private Long employeeId;      // EMPLOYEEè§’è‰²å¯é€‰

    // é»˜è®¤å¯†ç ä¸º 123456
}
```

#### 3.1.3 `UserUpdateRequest.java` - æ›´æ–°ç”¨æˆ·è¯·æ±‚ DTO

```java
package com.example.empmgmt.dto.request;

import jakarta.validation.constraints.Email;
import lombok.Data;

/**
 * æ›´æ–°ç”¨æˆ·è¯·æ±‚DTO
 */
@Data
public class UserUpdateRequest {
    
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;

    private String department;    // æ›´æ–°éƒ¨é—¨ä¿¡æ¯

    private Long employeeId;      // æ›´æ–°å…³è”å‘˜å·¥ID
}
```

#### 3.1.4 `AssignRoleRequest.java` - åˆ†é…è§’è‰²è¯·æ±‚ DTO

```java
package com.example.empmgmt.dto.request;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import lombok.Data;

/**
 * åˆ†é…è§’è‰²è¯·æ±‚DTO
 */
@Data
public class AssignRoleRequest {
    
    @NotBlank(message = "è§’è‰²ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^(SUPER_ADMIN|MANAGER|EMPLOYEE)$", 
             message = "è§’è‰²åªèƒ½æ˜¯ SUPER_ADMIN/MANAGER/EMPLOYEE")
    private String role;

    private String department;    // MANAGERè§’è‰²å¿…å¡«

    private Long employeeId;      // EMPLOYEEè§’è‰²å¯é€‰
}
```

#### 3.1.5 `ResetPasswordRequest.java` - é‡ç½®å¯†ç è¯·æ±‚ DTO

```java
package com.example.empmgmt.dto.request;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Data;

/**
 * é‡ç½®å¯†ç è¯·æ±‚DTO
 */
@Data
public class ResetPasswordRequest {
    
    @NotBlank(message = "æ–°å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 6, max = 20, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä¹‹é—´")
    private String newPassword;
}
```

### 3.2 Service å±‚

#### 3.2.1 `UserService.java` - æœåŠ¡æ¥å£ï¼ˆæ‰©å±•ï¼‰

```java
package com.example.empmgmt.service;

import com.example.empmgmt.dto.request.LoginRequest;
import com.example.empmgmt.dto.request.RegisterRequest;
import com.example.empmgmt.dto.request.UserCreateRequest;
import com.example.empmgmt.dto.request.UserUpdateRequest;
import com.example.empmgmt.dto.response.AuthResponse;
import com.example.empmgmt.dto.response.PageResponse;
import com.example.empmgmt.dto.response.UserResponse;

public interface UserService {

    // ========== åŸæœ‰æ–¹æ³• ==========
    
    /**
     * æ³¨å†Œ
     */
    AuthResponse register(RegisterRequest request);

    /**
     * ç™»å½•
     */
    AuthResponse login(LoginRequest request);

    // ========== æ–°å¢æ–¹æ³• ==========
    
    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    PageResponse<UserResponse> pageQuery(String username, String role, 
                                         Boolean enabled, int page, int size);

    /**
     * æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·
     */
    UserResponse findById(Long id);

    /**
     * åˆ›å»ºç”¨æˆ·
     */
    UserResponse create(UserCreateRequest request);

    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     */
    UserResponse update(Long id, UserUpdateRequest request);

    /**
     * å¯ç”¨/ç¦ç”¨ç”¨æˆ·
     */
    void updateStatus(Long id, Boolean enabled);

    /**
     * åˆ†é…è§’è‰²
     */
    UserResponse assignRole(Long id, String role, String department, Long employeeId);

    /**
     * åˆ é™¤ç”¨æˆ·
     */
    void delete(Long id);

    /**
     * é‡ç½®å¯†ç 
     */
    void resetPassword(Long id, String newPassword);
}
```

#### 3.2.2 `UserServiceImpl.java` - æœåŠ¡å®ç°ï¼ˆå®Œæ•´ç‰ˆï¼‰

```java
package com.example.empmgmt.service.Impl;

import com.example.empmgmt.common.Exception.BusinessException;
import com.example.empmgmt.domain.User;
import com.example.empmgmt.dto.request.*;
import com.example.empmgmt.dto.response.AuthResponse;
import com.example.empmgmt.dto.response.PageResponse;
import com.example.empmgmt.dto.response.UserResponse;
import com.example.empmgmt.repository.UserRepository;
import com.example.empmgmt.service.UserService;
import com.example.empmgmt.common.util.JwtUtil;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import jakarta.persistence.criteria.Predicate;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@Slf4j
public class UserServiceImpl implements UserService {

    private final UserRepository userRepository;
    private final JwtUtil jwtUtil;
    private final PasswordEncoder passwordEncoder;

    // é»˜è®¤å¯†ç 
    private static final String DEFAULT_PASSWORD = "123456";

    public UserServiceImpl(UserRepository userRepository,
                           JwtUtil jwtUtil,
                           PasswordEncoder passwordEncoder) {
        this.userRepository = userRepository;
        this.jwtUtil = jwtUtil;
        this.passwordEncoder = passwordEncoder;
    }

    // ========== åŸæœ‰æ–¹æ³• ==========
    
    @Override
    public AuthResponse register(RegisterRequest request) {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if (userRepository.findByUsername(request.username()).isPresent()) {
            throw new IllegalArgumentException("ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // åˆ›å»ºæ–°ç”¨æˆ·
        User user = new User();
        user.setUsername(request.username());
        user.setPassword(passwordEncoder.encode(request.password()));
        user.setEmail(request.email());
        user.setRole("EMPLOYEE");  // æ³¨å†Œé»˜è®¤ä¸ºå‘˜å·¥
        user.setEnabled(true);
        userRepository.save(user);

        // ç”Ÿæˆtoken
        String token = jwtUtil.generateToken(user.getUsername(), user.getId());
        return AuthResponse.of(token, jwtUtil.getExpirationTime());
    }

    @Override
    @Transactional(readOnly = true)
    public AuthResponse login(LoginRequest request) {
        // æŸ¥æ‰¾ç”¨æˆ·
        User user = userRepository.findByUsername(request.username())
                .orElseThrow(() -> new IllegalArgumentException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));

        // æ ¡éªŒå¯†ç 
        if (!passwordEncoder.matches(request.password(), user.getPassword())) {
            throw new IllegalArgumentException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ç”¨
        if (!user.getEnabled()) {
            throw new IllegalArgumentException("ç”¨æˆ·å·²è¢«ç¦ç”¨");
        }

        // ç”Ÿæˆtoken
        String token = jwtUtil.generateToken(user.getUsername(), user.getId());
        return AuthResponse.of(token, jwtUtil.getExpirationTime());
    }

    // ========== æ–°å¢æ–¹æ³• ==========
    
    @Override
    @Transactional(readOnly = true)
    public PageResponse<UserResponse> pageQuery(String username, String role, 
                                                Boolean enabled, int page, int size) {
        // åˆ›å»ºåˆ†é¡µå¯¹è±¡ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰
        Pageable pageable = PageRequest.of(page - 1, size, 
                           Sort.by(Sort.Direction.DESC, "createdAt"));

        // åŠ¨æ€æ¡ä»¶æŸ¥è¯¢
        Specification<User> spec = (root, query, cb) -> {
            List<Predicate> predicates = new ArrayList<>();

            // ç”¨æˆ·åæ¨¡ç³ŠæŸ¥è¯¢
            if (username != null && !username.trim().isEmpty()) {
                predicates.add(cb.like(root.get("username"), "%" + username + "%"));
            }

            // è§’è‰²ç²¾ç¡®æŸ¥è¯¢
            if (role != null && !role.trim().isEmpty()) {
                predicates.add(cb.equal(root.get("role"), role));
            }

            // å¯ç”¨çŠ¶æ€æŸ¥è¯¢
            if (enabled != null) {
                predicates.add(cb.equal(root.get("enabled"), enabled));
            }

            return cb.and(predicates.toArray(new Predicate[0]));
        };

        // æ‰§è¡ŒæŸ¥è¯¢
        Page<User> userPage = userRepository.findAll(spec, pageable);

        // è½¬æ¢ä¸ºå“åº”DTO
        List<UserResponse> records = userPage.getContent().stream()
                .map(UserResponse::fromEntity)
                .collect(Collectors.toList());

        return PageResponse.of(
                records,
                userPage.getTotalElements(),
                (long) userPage.getTotalPages(),
                (long) page,
                (long) size
        );
    }

    @Override
    @Transactional(readOnly = true)
    public UserResponse findById(Long id) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));
        return UserResponse.fromEntity(user);
    }

    @Override
    @Transactional
    public UserResponse create(UserCreateRequest request) {
        // éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
        if (userRepository.findByUsername(request.getUsername()).isPresent()) {
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // éªŒè¯è§’è‰²å’Œéƒ¨é—¨çš„å…³ç³»
        validateRoleAndDepartment(request.getRole(), request.getDepartment());

        // åˆ›å»ºç”¨æˆ·
        User user = new User();
        user.setUsername(request.getUsername());
        user.setPassword(passwordEncoder.encode(DEFAULT_PASSWORD));
        user.setEmail(request.getEmail());
        user.setRole(request.getRole());
        user.setDepartment(request.getDepartment());
        user.setEmployeeId(request.getEmployeeId());
        user.setEnabled(true);

        User savedUser = userRepository.save(user);
        log.info("åˆ›å»ºç”¨æˆ·æˆåŠŸ: {}, è§’è‰²: {}", savedUser.getUsername(), savedUser.getRole());

        return UserResponse.fromEntity(savedUser);
    }

    @Override
    @Transactional
    public UserResponse update(Long id, UserUpdateRequest request) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));

        // æ›´æ–°å­—æ®µ
        if (request.getEmail() != null) {
            user.setEmail(request.getEmail());
        }
        if (request.getDepartment() != null) {
            user.setDepartment(request.getDepartment());
        }
        if (request.getEmployeeId() != null) {
            user.setEmployeeId(request.getEmployeeId());
        }

        User updatedUser = userRepository.save(user);
        log.info("æ›´æ–°ç”¨æˆ·æˆåŠŸ: {}", updatedUser.getUsername());

        return UserResponse.fromEntity(updatedUser);
    }

    @Override
    @Transactional
    public void updateStatus(Long id, Boolean enabled) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));

        // ä¸èƒ½ç¦ç”¨è‡ªå·±ï¼ˆé€šè¿‡å½“å‰ç”¨æˆ·IDåˆ¤æ–­ï¼‰
        // Long currentUserId = SecurityUtil.getCurrentUserId();
        // if (user.getId().equals(currentUserId)) {
        //     throw new BusinessException("ä¸èƒ½ç¦ç”¨è‡ªå·±çš„è´¦å·");
        // }

        user.setEnabled(enabled);
        userRepository.save(user);

        log.info("æ›´æ–°ç”¨æˆ·çŠ¶æ€: {}, å¯ç”¨: {}", user.getUsername(), enabled);
    }

    @Override
    @Transactional
    public UserResponse assignRole(Long id, String role, String department, Long employeeId) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));

        // éªŒè¯è§’è‰²å’Œéƒ¨é—¨çš„å…³ç³»
        validateRoleAndDepartment(role, department);

        // æ›´æ–°è§’è‰²
        user.setRole(role);
        user.setDepartment(department);
        user.setEmployeeId(employeeId);

        User updatedUser = userRepository.save(user);
        log.info("åˆ†é…è§’è‰²æˆåŠŸ: {}, æ–°è§’è‰²: {}", updatedUser.getUsername(), role);

        return UserResponse.fromEntity(updatedUser);
    }

    @Override
    @Transactional
    public void delete(Long id) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));

        // ä¸èƒ½åˆ é™¤è¶…çº§ç®¡ç†å‘˜ï¼ˆå¯é€‰ï¼‰
        if ("SUPER_ADMIN".equals(user.getRole())) {
            throw new BusinessException("ä¸èƒ½åˆ é™¤è¶…çº§ç®¡ç†å‘˜è´¦å·");
        }

        userRepository.delete(user);
        log.info("åˆ é™¤ç”¨æˆ·æˆåŠŸ: {}", user.getUsername());
    }

    @Override
    @Transactional
    public void resetPassword(Long id, String newPassword) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));

        user.setPassword(passwordEncoder.encode(newPassword));
        userRepository.save(user);

        log.info("é‡ç½®å¯†ç æˆåŠŸ: {}", user.getUsername());
    }

    /**
     * éªŒè¯è§’è‰²å’Œéƒ¨é—¨çš„å…³ç³»
     */
    private void validateRoleAndDepartment(String role, String department) {
        if ("MANAGER".equals(role) && (department == null || department.trim().isEmpty())) {
            throw new BusinessException("éƒ¨é—¨ç»ç†å¿…é¡»æŒ‡å®šéƒ¨é—¨");
        }
    }
}
```

### 3.3 Repository å±‚

#### 3.3.1 `UserRepository.java` - ä»“åº“æ¥å£ï¼ˆæ‰©å±•ï¼‰

```java
package com.example.empmgmt.repository;

import com.example.empmgmt.domain.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;

import java.util.Optional;

/**
 * ç”¨æˆ·ä»“åº“æ¥å£
 * JpaSpecificationExecutor æä¾›åŠ¨æ€æŸ¥è¯¢èƒ½åŠ›
 */
public interface UserRepository extends JpaRepository<User, Long>, 
                                        JpaSpecificationExecutor<User> {

    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢
     */
    Optional<User> findByUsername(String username);

    /**
     * æ ¹æ®è§’è‰²æŸ¥è¯¢æ•°é‡
     */
    long countByRole(String role);

    /**
     * æ ¹æ®éƒ¨é—¨æŸ¥è¯¢æ•°é‡
     */
    long countByDepartment(String department);
}
```

### 3.4 Controller å±‚

#### 3.4.1 `UserController.java` - æ§åˆ¶å™¨ï¼ˆå®Œæ•´ç‰ˆï¼‰

```java
package com.example.empmgmt.controller;

import com.example.empmgmt.common.annotation.OperationLog;
import com.example.empmgmt.common.annotation.RequiresRole;
import com.example.empmgmt.common.enums.OperationType;
import com.example.empmgmt.dto.request.AssignRoleRequest;
import com.example.empmgmt.dto.request.ResetPasswordRequest;
import com.example.empmgmt.dto.request.UserCreateRequest;
import com.example.empmgmt.dto.request.UserUpdateRequest;
import com.example.empmgmt.dto.response.PageResponse;
import com.example.empmgmt.dto.response.Result;
import com.example.empmgmt.dto.response.UserResponse;
import com.example.empmgmt.service.UserService;
import jakarta.validation.Valid;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/users")
@Slf4j
public class UserController {

    private final UserService userService;

    public UserController(UserService userService) {
        this.userService = userService;
    }

    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
     * æ”¯æŒåˆ†é¡µå’Œç­›é€‰
     */
    @GetMapping
    @RequiresRole("SUPER_ADMIN")
    @OperationLog(
            module = "USER",
            type = OperationType.QUERY,
            description = "æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨"
    )
    public Result<PageResponse<UserResponse>> list(
            @RequestParam(required = false) String username,
            @RequestParam(required = false) String role,
            @RequestParam(required = false) Boolean enabled,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size
    ) {
        PageResponse<UserResponse> pageResult = 
                userService.pageQuery(username, role, enabled, page, size);
        return Result.success(pageResult);
    }

    /**
     * è·å–å•ä¸ªç”¨æˆ·è¯¦æƒ…ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    @GetMapping("/{id}")
    @RequiresRole("SUPER_ADMIN")
    @OperationLog(
            module = "USER",
            type = OperationType.QUERY,
            description = "æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…"
    )
    public Result<UserResponse> getById(@PathVariable Long id) {
        UserResponse user = userService.findById(id);
        return Result.success(user);
    }

    /**
     * åˆ›å»ºç”¨æˆ·ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    @PostMapping
    @RequiresRole("SUPER_ADMIN")
    @OperationLog(
            module = "USER",
            type = OperationType.CREATE,
            description = "åˆ›å»ºç”¨æˆ·",
            saveResult = true
    )
    public Result<UserResponse> create(@Valid @RequestBody UserCreateRequest request) {
        UserResponse user = userService.create(request);
        return Result.success("åˆ›å»ºæˆåŠŸ", user);
    }

    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    @PutMapping("/{id}")
    @RequiresRole("SUPER_ADMIN")
    @OperationLog(
            module = "USER",
            type = OperationType.UPDATE,
            description = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯",
            saveResult = true
    )
    public Result<UserResponse> update(
            @PathVariable Long id,
            @Valid @RequestBody UserUpdateRequest request
    ) {
        UserResponse user = userService.update(id, request);
        return Result.success("æ›´æ–°æˆåŠŸ", user);
    }

    /**
     * å¯ç”¨/ç¦ç”¨ç”¨æˆ·ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    @PutMapping("/{id}/status")
    @RequiresRole("SUPER_ADMIN")
    @OperationLog(
            module = "USER",
            type = OperationType.UPDATE,
            description = "æ›´æ–°ç”¨æˆ·çŠ¶æ€"
    )
    public Result<Void> updateStatus(
            @PathVariable Long id,
            @RequestParam Boolean enabled
    ) {
        userService.updateStatus(id, enabled);
        String action = enabled ? "å¯ç”¨" : "ç¦ç”¨";
        return Result.success(action + "æˆåŠŸ", null);
    }

    /**
     * åˆ†é…è§’è‰²ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    @PutMapping("/{id}/role")
    @RequiresRole("SUPER_ADMIN")
    @OperationLog(
            module = "USER",
            type = OperationType.UPDATE,
            description = "åˆ†é…ç”¨æˆ·è§’è‰²",
            saveResult = true
    )
    public Result<UserResponse> assignRole(
            @PathVariable Long id,
            @Valid @RequestBody AssignRoleRequest request
    ) {
        UserResponse user = userService.assignRole(
                id, 
                request.getRole(), 
                request.getDepartment(), 
                request.getEmployeeId()
        );
        return Result.success("åˆ†é…è§’è‰²æˆåŠŸ", user);
    }

    /**
     * åˆ é™¤ç”¨æˆ·ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    @DeleteMapping("/{id}")
    @RequiresRole("SUPER_ADMIN")
    @OperationLog(
            module = "USER",
            type = OperationType.DELETE,
            description = "åˆ é™¤ç”¨æˆ·"
    )
    public Result<Void> delete(@PathVariable Long id) {
        userService.delete(id);
        return Result.success("åˆ é™¤æˆåŠŸ", null);
    }

    /**
     * é‡ç½®ç”¨æˆ·å¯†ç ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    @PutMapping("/{id}/password")
    @RequiresRole("SUPER_ADMIN")
    @OperationLog(
            module = "USER",
            type = OperationType.UPDATE,
            description = "é‡ç½®ç”¨æˆ·å¯†ç "
    )
    public Result<Void> resetPassword(
            @PathVariable Long id,
            @Valid @RequestBody ResetPasswordRequest request
    ) {
        userService.resetPassword(id, request.getNewPassword());
        return Result.success("é‡ç½®å¯†ç æˆåŠŸ", null);
    }
}
```

### 3.5 PageResponse é€šç”¨å“åº”ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

```java
package com.example.empmgmt.dto.response;

import lombok.Data;
import java.util.List;

/**
 * åˆ†é¡µå“åº”DTO
 */
@Data
public class PageResponse<T> {
    private List<T> records;      // æ•°æ®åˆ—è¡¨
    private Long total;           // æ€»è®°å½•æ•°
    private Long pages;           // æ€»é¡µæ•°
    private Long current;         // å½“å‰é¡µ
    private Long size;            // æ¯é¡µå¤§å°

    public static <T> PageResponse<T> of(List<T> records, Long total, 
                                         Long pages, Long current, Long size) {
        PageResponse<T> response = new PageResponse<>();
        response.setRecords(records);
        response.setTotal(total);
        response.setPages(pages);
        response.setCurrent(current);
        response.setSize(size);
        return response;
    }
}
```

---

## 4. å‰ç«¯å®ç°

### 4.1 ç±»å‹å®šä¹‰

#### 4.1.1 `types/user.ts` - ç”¨æˆ·ç±»å‹å®šä¹‰

```typescript
/**
 * ç”¨æˆ·ç›¸å…³ç±»å‹å®šä¹‰
 */

// è§’è‰²æšä¸¾
export enum Role {
  SUPER_ADMIN = 'SUPER_ADMIN',
  MANAGER = 'MANAGER',
  EMPLOYEE = 'EMPLOYEE'
}

// è§’è‰²æ˜¾ç¤ºåç§°æ˜ å°„
export const RoleNames: Record<Role, string> = {
  [Role.SUPER_ADMIN]: 'è¶…çº§ç®¡ç†å‘˜',
  [Role.MANAGER]: 'éƒ¨é—¨ç»ç†',
  [Role.EMPLOYEE]: 'æ™®é€šå‘˜å·¥'
}

/**
 * ç”¨æˆ·ä¿¡æ¯ç±»å‹
 * å¯¹åº”åç«¯ UserResponse
 */
export interface User {
  id: number
  username: string
  email?: string
  role: Role
  department?: string
  employeeId?: number
  enabled: boolean
  createdAt: string
  updatedAt?: string
}

/**
 * åˆ›å»ºç”¨æˆ·è¯·æ±‚
 * å¯¹åº”åç«¯ UserCreateRequest
 */
export interface UserCreateRequest {
  username: string
  email?: string
  role: Role
  department?: string
  employeeId?: number
}

/**
 * æ›´æ–°ç”¨æˆ·è¯·æ±‚
 * å¯¹åº”åç«¯ UserUpdateRequest
 */
export interface UserUpdateRequest {
  email?: string
  department?: string
  employeeId?: number
}

/**
 * åˆ†é…è§’è‰²è¯·æ±‚
 * å¯¹åº”åç«¯ AssignRoleRequest
 */
export interface AssignRoleRequest {
  role: Role
  department?: string
  employeeId?: number
}

/**
 * é‡ç½®å¯†ç è¯·æ±‚
 * å¯¹åº”åç«¯ ResetPasswordRequest
 */
export interface ResetPasswordRequest {
  newPassword: string
}

/**
 * åˆ†é¡µå“åº”
 */
export interface PageResponse<T> {
  records: T[]
  total: number
  pages: number
  current: number
  size: number
}
```

### 4.2 API æ¥å£

#### 4.2.1 `api/user.ts` - ç”¨æˆ·ç®¡ç†API

```typescript
import request from '../utils/request'
import type {
  User,
  UserCreateRequest,
  UserUpdateRequest,
  AssignRoleRequest,
  ResetPasswordRequest,
  PageResponse
} from '../types/user'

/**
 * è·å–ç”¨æˆ·åˆ—è¡¨
 */
export const getUserList = (params: {
  username?: string
  role?: string
  enabled?: boolean
  page?: number
  size?: number
}) => {
  return request.get<PageResponse<User>>('/users', { params })
}

/**
 * è·å–å•ä¸ªç”¨æˆ·è¯¦æƒ…
 */
export const getUserById = (id: number) => {
  return request.get<User>(`/users/${id}`)
}

/**
 * åˆ›å»ºç”¨æˆ·
 */
export const createUser = (data: UserCreateRequest) => {
  return request.post<User>('/users', data)
}

/**
 * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
 */
export const updateUser = (id: number, data: UserUpdateRequest) => {
  return request.put<User>(`/users/${id}`, data)
}

/**
 * å¯ç”¨/ç¦ç”¨ç”¨æˆ·
 */
export const updateUserStatus = (id: number, enabled: boolean) => {
  return request.put<void>(`/users/${id}/status`, null, {
    params: { enabled }
  })
}

/**
 * åˆ†é…è§’è‰²
 */
export const assignRole = (id: number, data: AssignRoleRequest) => {
  return request.put<User>(`/users/${id}/role`, data)
}

/**
 * åˆ é™¤ç”¨æˆ·
 */
export const deleteUser = (id: number) => {
  return request.delete<void>(`/users/${id}`)
}

/**
 * é‡ç½®å¯†ç 
 */
export const resetPassword = (id: number, data: ResetPasswordRequest) => {
  return request.put<void>(`/users/${id}/password`, data)
}
```

### 4.3 ç”¨æˆ·ç®¡ç†é¡µé¢

#### 4.3.1 `pages/UserManagement.tsx` - ç”¨æˆ·ç®¡ç†ä¸»é¡µé¢

```typescript
import React, { useEffect, useState } from 'react'
import {
  Table,
  Button,
  Space,
  Tag,
  Modal,
  Form,
  Input,
  Select,
  Switch,
  message,
  Popconfirm,
  Card
} from 'antd'
import type { ColumnsType } from 'antd/es/table'
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  KeyOutlined,
  SearchOutlined,
  ReloadOutlined
} from '@ant-design/icons'
import {
  getUserList,
  createUser,
  updateUser,
  updateUserStatus,
  assignRole,
  deleteUser,
  resetPassword
} from '../api/user'
import type {
  User,
  UserCreateRequest,
  UserUpdateRequest,
  AssignRoleRequest,
  ResetPasswordRequest,
  Role
} from '../types/user'
import { RoleNames } from '../types/user'

const { Option } = Select

const UserManagement: React.FC = () => {
  const [users, setUsers] = useState<User[]>([])
  const [loading, setLoading] = useState(false)
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0
  })

  // ç­›é€‰æ¡ä»¶
  const [filters, setFilters] = useState({
    username: '',
    role: undefined as string | undefined,
    enabled: undefined as boolean | undefined
  })

  // æ¨¡æ€æ¡†çŠ¶æ€
  const [createModalVisible, setCreateModalVisible] = useState(false)
  const [editModalVisible, setEditModalVisible] = useState(false)
  const [roleModalVisible, setRoleModalVisible] = useState(false)
  const [passwordModalVisible, setPasswordModalVisible] = useState(false)
  const [currentUser, setCurrentUser] = useState<User | null>(null)

  // è¡¨å•å®ä¾‹
  const [createForm] = Form.useForm()
  const [editForm] = Form.useForm()
  const [roleForm] = Form.useForm()
  const [passwordForm] = Form.useForm()

  // åŠ è½½ç”¨æˆ·åˆ—è¡¨
  const loadUsers = async () => {
    setLoading(true)
    try {
      const res = await getUserList({
        ...filters,
        page: pagination.current,
        size: pagination.pageSize
      })
      setUsers(res.records)
      setPagination({
        ...pagination,
        total: res.total
      })
    } catch (error) {
      message.error('åŠ è½½å¤±è´¥')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    loadUsers()
  }, [pagination.current, pagination.pageSize])

  // æœç´¢
  const handleSearch = () => {
    setPagination({ ...pagination, current: 1 })
    loadUsers()
  }

  // é‡ç½®
  const handleReset = () => {
    setFilters({
      username: '',
      role: undefined,
      enabled: undefined
    })
    setPagination({ ...pagination, current: 1 })
  }

  // åˆ›å»ºç”¨æˆ·
  const handleCreate = async (values: UserCreateRequest) => {
    try {
      await createUser(values)
      message.success('åˆ›å»ºæˆåŠŸ')
      setCreateModalVisible(false)
      createForm.resetFields()
      loadUsers()
    } catch (error) {
      message.error('åˆ›å»ºå¤±è´¥')
    }
  }

  // æ›´æ–°ç”¨æˆ·
  const handleUpdate = async (values: UserUpdateRequest) => {
    if (!currentUser) return
    try {
      await updateUser(currentUser.id, values)
      message.success('æ›´æ–°æˆåŠŸ')
      setEditModalVisible(false)
      editForm.resetFields()
      loadUsers()
    } catch (error) {
      message.error('æ›´æ–°å¤±è´¥')
    }
  }

  // åˆ†é…è§’è‰²
  const handleAssignRole = async (values: AssignRoleRequest) => {
    if (!currentUser) return
    try {
      await assignRole(currentUser.id, values)
      message.success('è§’è‰²åˆ†é…æˆåŠŸ')
      setRoleModalVisible(false)
      roleForm.resetFields()
      loadUsers()
    } catch (error) {
      message.error('è§’è‰²åˆ†é…å¤±è´¥')
    }
  }

  // é‡ç½®å¯†ç 
  const handleResetPassword = async (values: ResetPasswordRequest) => {
    if (!currentUser) return
    try {
      await resetPassword(currentUser.id, values)
      message.success('å¯†ç é‡ç½®æˆåŠŸ')
      setPasswordModalVisible(false)
      passwordForm.resetFields()
    } catch (error) {
      message.error('å¯†ç é‡ç½®å¤±è´¥')
    }
  }

  // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
  const handleToggleStatus = async (user: User) => {
    try {
      await updateUserStatus(user.id, !user.enabled)
      message.success(user.enabled ? 'å·²ç¦ç”¨' : 'å·²å¯ç”¨')
      loadUsers()
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥')
    }
  }

  // åˆ é™¤ç”¨æˆ·
  const handleDelete = async (id: number) => {
    try {
      await deleteUser(id)
      message.success('åˆ é™¤æˆåŠŸ')
      loadUsers()
    } catch (error) {
      message.error('åˆ é™¤å¤±è´¥')
    }
  }

  // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
  const openEditModal = (user: User) => {
    setCurrentUser(user)
    editForm.setFieldsValue({
      email: user.email,
      department: user.department,
      employeeId: user.employeeId
    })
    setEditModalVisible(true)
  }

  // æ‰“å¼€è§’è‰²åˆ†é…æ¨¡æ€æ¡†
  const openRoleModal = (user: User) => {
    setCurrentUser(user)
    roleForm.setFieldsValue({
      role: user.role,
      department: user.department,
      employeeId: user.employeeId
    })
    setRoleModalVisible(true)
  }

  // æ‰“å¼€å¯†ç é‡ç½®æ¨¡æ€æ¡†
  const openPasswordModal = (user: User) => {
    setCurrentUser(user)
    passwordForm.resetFields()
    setPasswordModalVisible(true)
  }

  // è¡¨æ ¼åˆ—å®šä¹‰
  const columns: ColumnsType<User> = [
    {
      title: 'ID',
      dataIndex: 'id',
      width: 80
    },
    {
      title: 'ç”¨æˆ·å',
      dataIndex: 'username',
      width: 150
    },
    {
      title: 'é‚®ç®±',
      dataIndex: 'email',
      width: 200
    },
    {
      title: 'è§’è‰²',
      dataIndex: 'role',
      width: 120,
      render: (role: Role) => {
        const color = {
          SUPER_ADMIN: 'red',
          MANAGER: 'blue',
          EMPLOYEE: 'green'
        }[role]
        return <Tag color={color}>{RoleNames[role]}</Tag>
      }
    },
    {
      title: 'éƒ¨é—¨',
      dataIndex: 'department',
      width: 120
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'enabled',
      width: 100,
      render: (enabled: boolean, record) => (
        <Switch
          checked={enabled}
          onChange={() => handleToggleStatus(record)}
          checkedChildren="å¯ç”¨"
          unCheckedChildren="ç¦ç”¨"
        />
      )
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createdAt',
      width: 180,
      render: (date: string) => new Date(date).toLocaleString('zh-CN')
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      width: 300,
      fixed: 'right',
      render: (_, record) => (
        <Space>
          <Button
            type="link"
            icon={<EditOutlined />}
            onClick={() => openEditModal(record)}
          >
            ç¼–è¾‘
          </Button>
          <Button
            type="link"
            onClick={() => openRoleModal(record)}
          >
            åˆ†é…è§’è‰²
          </Button>
          <Button
            type="link"
            icon={<KeyOutlined />}
            onClick={() => openPasswordModal(record)}
          >
            é‡ç½®å¯†ç 
          </Button>
          {record.role !== 'SUPER_ADMIN' && (
            <Popconfirm
              title="ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·ï¼Ÿ"
              onConfirm={() => handleDelete(record.id)}
            >
              <Button type="link" danger icon={<DeleteOutlined />}>
                åˆ é™¤
              </Button>
            </Popconfirm>
          )}
        </Space>
      )
    }
  ]

  return (
    <div style={{ padding: 24 }}>
      <Card>
        {/* ç­›é€‰åŒºåŸŸ */}
        <Space style={{ marginBottom: 16 }}>
          <Input
            placeholder="ç”¨æˆ·å"
            value={filters.username}
            onChange={(e) => setFilters({ ...filters, username: e.target.value })}
            style={{ width: 200 }}
          />
          <Select
            placeholder="è§’è‰²"
            value={filters.role}
            onChange={(role) => setFilters({ ...filters, role })}
            style={{ width: 150 }}
            allowClear
          >
            <Option value="SUPER_ADMIN">è¶…çº§ç®¡ç†å‘˜</Option>
            <Option value="MANAGER">éƒ¨é—¨ç»ç†</Option>
            <Option value="EMPLOYEE">æ™®é€šå‘˜å·¥</Option>
          </Select>
          <Select
            placeholder="çŠ¶æ€"
            value={filters.enabled}
            onChange={(enabled) => setFilters({ ...filters, enabled })}
            style={{ width: 120 }}
            allowClear
          >
            <Option value={true}>å¯ç”¨</Option>
            <Option value={false}>ç¦ç”¨</Option>
          </Select>
          <Button type="primary" icon={<SearchOutlined />} onClick={handleSearch}>
            æœç´¢
          </Button>
          <Button icon={<ReloadOutlined />} onClick={handleReset}>
            é‡ç½®
          </Button>
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => setCreateModalVisible(true)}
          >
            æ–°å»ºç”¨æˆ·
          </Button>
        </Space>

        {/* è¡¨æ ¼ */}
        <Table
          columns={columns}
          dataSource={users}
          rowKey="id"
          loading={loading}
          pagination={{
            ...pagination,
            showTotal: (total) => `å…± ${total} æ¡`,
            showSizeChanger: true,
            onChange: (page, pageSize) => {
              setPagination({ ...pagination, current: page, pageSize })
            }
          }}
          scroll={{ x: 1400 }}
        />
      </Card>

      {/* åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† */}
      <Modal
        title="åˆ›å»ºç”¨æˆ·"
        open={createModalVisible}
        onCancel={() => {
          setCreateModalVisible(false)
          createForm.resetFields()
        }}
        onOk={() => createForm.submit()}
      >
        <Form form={createForm} onFinish={handleCreate} layout="vertical">
          <Form.Item
            label="ç”¨æˆ·å"
            name="username"
            rules={[
              { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å' },
              { pattern: /^[a-zA-Z0-9_]{3,20}$/, message: 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œé•¿åº¦3-20' }
            ]}
          >
            <Input placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
          </Form.Item>
          <Form.Item label="é‚®ç®±" name="email" rules={[{ type: 'email', message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' }]}>
            <Input placeholder="è¯·è¾“å…¥é‚®ç®±" />
          </Form.Item>
          <Form.Item label="è§’è‰²" name="role" rules={[{ required: true, message: 'è¯·é€‰æ‹©è§’è‰²' }]}>
            <Select placeholder="è¯·é€‰æ‹©è§’è‰²">
              <Option value="SUPER_ADMIN">è¶…çº§ç®¡ç†å‘˜</Option>
              <Option value="MANAGER">éƒ¨é—¨ç»ç†</Option>
              <Option value="EMPLOYEE">æ™®é€šå‘˜å·¥</Option>
            </Select>
          </Form.Item>
          <Form.Item
            noStyle
            shouldUpdate={(prev, curr) => prev.role !== curr.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'MANAGER' && (
                <Form.Item label="éƒ¨é—¨" name="department" rules={[{ required: true, message: 'éƒ¨é—¨ç»ç†å¿…é¡»æŒ‡å®šéƒ¨é—¨' }]}>
                  <Input placeholder="è¯·è¾“å…¥éƒ¨é—¨" />
                </Form.Item>
              )
            }
          </Form.Item>
          <Form.Item
            noStyle
            shouldUpdate={(prev, curr) => prev.role !== curr.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'EMPLOYEE' && (
                <Form.Item label="å…³è”å‘˜å·¥ID" name="employeeId">
                  <Input type="number" placeholder="è¯·è¾“å…¥å‘˜å·¥ID" />
                </Form.Item>
              )
            }
          </Form.Item>
          <p style={{ color: '#999', fontSize: 12 }}>é»˜è®¤å¯†ç ä¸ºï¼š123456</p>
        </Form>
      </Modal>

      {/* ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† */}
      <Modal
        title="ç¼–è¾‘ç”¨æˆ·"
        open={editModalVisible}
        onCancel={() => {
          setEditModalVisible(false)
          editForm.resetFields()
        }}
        onOk={() => editForm.submit()}
      >
        <Form form={editForm} onFinish={handleUpdate} layout="vertical">
          <Form.Item label="é‚®ç®±" name="email" rules={[{ type: 'email', message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' }]}>
            <Input placeholder="è¯·è¾“å…¥é‚®ç®±" />
          </Form.Item>
          <Form.Item label="éƒ¨é—¨" name="department">
            <Input placeholder="è¯·è¾“å…¥éƒ¨é—¨" />
          </Form.Item>
          <Form.Item label="å…³è”å‘˜å·¥ID" name="employeeId">
            <Input type="number" placeholder="è¯·è¾“å…¥å‘˜å·¥ID" />
          </Form.Item>
        </Form>
      </Modal>

      {/* åˆ†é…è§’è‰²æ¨¡æ€æ¡† */}
      <Modal
        title="åˆ†é…è§’è‰²"
        open={roleModalVisible}
        onCancel={() => {
          setRoleModalVisible(false)
          roleForm.resetFields()
        }}
        onOk={() => roleForm.submit()}
      >
        <Form form={roleForm} onFinish={handleAssignRole} layout="vertical">
          <Form.Item label="è§’è‰²" name="role" rules={[{ required: true, message: 'è¯·é€‰æ‹©è§’è‰²' }]}>
            <Select placeholder="è¯·é€‰æ‹©è§’è‰²">
              <Option value="SUPER_ADMIN">è¶…çº§ç®¡ç†å‘˜</Option>
              <Option value="MANAGER">éƒ¨é—¨ç»ç†</Option>
              <Option value="EMPLOYEE">æ™®é€šå‘˜å·¥</Option>
            </Select>
          </Form.Item>
          <Form.Item
            noStyle
            shouldUpdate={(prev, curr) => prev.role !== curr.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'MANAGER' && (
                <Form.Item label="éƒ¨é—¨" name="department" rules={[{ required: true, message: 'éƒ¨é—¨ç»ç†å¿…é¡»æŒ‡å®šéƒ¨é—¨' }]}>
                  <Input placeholder="è¯·è¾“å…¥éƒ¨é—¨" />
                </Form.Item>
              )
            }
          </Form.Item>
          <Form.Item
            noStyle
            shouldUpdate={(prev, curr) => prev.role !== curr.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'EMPLOYEE' && (
                <Form.Item label="å…³è”å‘˜å·¥ID" name="employeeId">
                  <Input type="number" placeholder="è¯·è¾“å…¥å‘˜å·¥ID" />
                </Form.Item>
              )
            }
          </Form.Item>
        </Form>
      </Modal>

      {/* é‡ç½®å¯†ç æ¨¡æ€æ¡† */}
      <Modal
        title="é‡ç½®å¯†ç "
        open={passwordModalVisible}
        onCancel={() => {
          setPasswordModalVisible(false)
          passwordForm.resetFields()
        }}
        onOk={() => passwordForm.submit()}
      >
        <Form form={passwordForm} onFinish={handleResetPassword} layout="vertical">
          <Form.Item
            label="æ–°å¯†ç "
            name="newPassword"
            rules={[
              { required: true, message: 'è¯·è¾“å…¥æ–°å¯†ç ' },
              { min: 6, max: 20, message: 'å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä¹‹é—´' }
            ]}
          >
            <Input.Password placeholder="è¯·è¾“å…¥æ–°å¯†ç " />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  )
}

export default UserManagement
```

### 4.4 è·¯ç”±é…ç½®

#### 4.4.1 `App.tsx` - æ·»åŠ ç”¨æˆ·ç®¡ç†è·¯ç”±

```typescript
import UserManagement from './pages/UserManagement'

// åœ¨ Routes ä¸­æ·»åŠ 
<Route path="users" element={<UserManagement />} />
```

### 4.5 èœå•é…ç½®

#### 4.4.2 `components/Layout.tsx` - æ·»åŠ ç”¨æˆ·ç®¡ç†èœå•

```typescript
import { UserOutlined } from '@ant-design/icons'

// åœ¨èœå•é¡¹ä¸­æ·»åŠ ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰
{
  key: '/users',
  icon: <UserOutlined />,
  label: 'ç”¨æˆ·ç®¡ç†',
}
```

---

## 5. å®ç°æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåç«¯å®ç°ï¼ˆé¢„è®¡ 2-3 å°æ—¶ï¼‰

#### 1.1 åˆ›å»º DTO ç±»ï¼ˆ30åˆ†é’Ÿï¼‰
```bash
# åœ¨ src/main/java/com/example/empmgmt/dto/ ç›®å½•ä¸‹åˆ›å»ºï¼š
- dto/response/UserResponse.java
- dto/request/UserCreateRequest.java
- dto/request/UserUpdateRequest.java
- dto/request/AssignRoleRequest.java
- dto/request/ResetPasswordRequest.java
- dto/response/PageResponse.javaï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
```

**æ“ä½œ**ï¼šç›´æ¥å¤åˆ¶ä¸Šé¢æä¾›çš„å®Œæ•´ä»£ç 

#### 1.2 æ‰©å±• Repositoryï¼ˆ10åˆ†é’Ÿï¼‰
```bash
# ä¿®æ”¹ src/main/java/com/example/empmgmt/repository/UserRepository.java
```

**æ“ä½œ**ï¼šæ·»åŠ  `JpaSpecificationExecutor<User>` æ¥å£

#### 1.3 æ‰©å±• Serviceï¼ˆ1å°æ—¶ï¼‰
```bash
# ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š
- src/main/java/com/example/empmgmt/service/UserService.java
- src/main/java/com/example/empmgmt/service/Impl/UserServiceImpl.java
```

**æ“ä½œ**ï¼š
1. åœ¨ `UserService` æ¥å£æ·»åŠ æ–°æ–¹æ³•å£°æ˜
2. åœ¨ `UserServiceImpl` å®ç°æ‰€æœ‰æ–¹æ³•
3. å¤åˆ¶ä¸Šé¢æä¾›çš„å®Œæ•´å®ç°ä»£ç 

#### 1.4 å®ç° Controllerï¼ˆ40åˆ†é’Ÿï¼‰
```bash
# ä¿®æ”¹ src/main/java/com/example/empmgmt/controller/UserController.java
```

**æ“ä½œ**ï¼šæ›¿æ¢ä¸ºä¸Šé¢æä¾›çš„å®Œæ•´ Controller ä»£ç 

#### 1.5 æµ‹è¯•åç«¯æ¥å£ï¼ˆ30åˆ†é’Ÿï¼‰
```bash
# ä½¿ç”¨ Postman æˆ– curl æµ‹è¯•ä»¥ä¸‹æ¥å£ï¼š
1. GET /api/users - è·å–ç”¨æˆ·åˆ—è¡¨
2. POST /api/users - åˆ›å»ºç”¨æˆ·
3. PUT /api/users/{id}/role - åˆ†é…è§’è‰²
4. PUT /api/users/{id}/status - ç¦ç”¨/å¯ç”¨ç”¨æˆ·
5. DELETE /api/users/{id} - åˆ é™¤ç”¨æˆ·
```

### ç¬¬äºŒæ­¥ï¼šå‰ç«¯å®ç°ï¼ˆé¢„è®¡ 2-3 å°æ—¶ï¼‰

#### 2.1 åˆ›å»ºç±»å‹å®šä¹‰ï¼ˆ20åˆ†é’Ÿï¼‰
```bash
# åœ¨ frontend/src/types/ ç›®å½•ä¸‹åˆ›å»ºï¼š
- types/user.ts
```

**æ“ä½œ**ï¼šå¤åˆ¶ä¸Šé¢æä¾›çš„å®Œæ•´ç±»å‹å®šä¹‰

#### 2.2 åˆ›å»º API å‡½æ•°ï¼ˆ20åˆ†é’Ÿï¼‰
```bash
# åœ¨ frontend/src/api/ ç›®å½•ä¸‹åˆ›å»ºï¼š
- api/user.ts
```

**æ“ä½œ**ï¼šå¤åˆ¶ä¸Šé¢æä¾›çš„å®Œæ•´ API ä»£ç 

#### 2.3 åˆ›å»ºç”¨æˆ·ç®¡ç†é¡µé¢ï¼ˆ1.5å°æ—¶ï¼‰
```bash
# åœ¨ frontend/src/pages/ ç›®å½•ä¸‹åˆ›å»ºï¼š
- pages/UserManagement.tsx
```

**æ“ä½œ**ï¼šå¤åˆ¶ä¸Šé¢æä¾›çš„å®Œæ•´é¡µé¢ä»£ç 

#### 2.4 é…ç½®è·¯ç”±å’Œèœå•ï¼ˆ20åˆ†é’Ÿï¼‰
```bash
# ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š
- frontend/src/App.tsx
- frontend/src/components/Layout.tsx
```

**æ“ä½œ**ï¼š
1. åœ¨ `App.tsx` æ·»åŠ è·¯ç”±
2. åœ¨ `Layout.tsx` æ·»åŠ èœå•é¡¹ï¼ˆæ ¹æ®è§’è‰²æ˜¾ç¤ºï¼‰

#### 2.5 æµ‹è¯•å‰ç«¯åŠŸèƒ½ï¼ˆ30åˆ†é’Ÿï¼‰
```bash
# æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š
1. æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
2. åˆ›å»ºæ–°ç”¨æˆ·
3. ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
4. åˆ†é…è§’è‰²
5. å¯ç”¨/ç¦ç”¨ç”¨æˆ·
6. åˆ é™¤ç”¨æˆ·
7. é‡ç½®å¯†ç 
```

### ç¬¬ä¸‰æ­¥ï¼šè”è°ƒæµ‹è¯•ï¼ˆé¢„è®¡ 1 å°æ—¶ï¼‰

#### 3.1 åˆ›å»ºæµ‹è¯•è´¦å·
```sql
-- è¶…çº§ç®¡ç†å‘˜
INSERT INTO user_account (username, password, role, email)
VALUES ('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lZN7.9Ng.XUH8BNSS', 
        'SUPER_ADMIN', 'admin@example.com');

-- éƒ¨é—¨ç»ç†
INSERT INTO user_account (username, password, role, department, email)
VALUES ('manager_tech', '$2a$10$5Z9p8fBqXvGWEn5ZqkayVO62PzKcl5RJZWkFdVf3WJJj.iuH8aVjK',
        'MANAGER', 'æŠ€æœ¯éƒ¨', 'manager@example.com');
```

#### 3.2 æµ‹è¯•åœºæ™¯

**åœºæ™¯1ï¼šåˆ›å»ºç”¨æˆ·æµç¨‹**
1. ä»¥ admin ç™»å½•
2. è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢
3. ç‚¹å‡»"æ–°å»ºç”¨æˆ·"
4. å¡«å†™ä¿¡æ¯å¹¶æäº¤
5. éªŒè¯ç”¨æˆ·åˆ—è¡¨ä¸­å‡ºç°æ–°ç”¨æˆ·

**åœºæ™¯2ï¼šè§’è‰²åˆ†é…æµç¨‹**
1. é€‰æ‹©ä¸€ä¸ªç”¨æˆ·
2. ç‚¹å‡»"åˆ†é…è§’è‰²"
3. ä¿®æ”¹è§’è‰²ä¸º MANAGER å¹¶å¡«å†™éƒ¨é—¨
4. æäº¤åéªŒè¯æ›´æ–°æˆåŠŸ

**åœºæ™¯3ï¼šæƒé™éªŒè¯**
1. ä»¥æ™®é€šç”¨æˆ·ç™»å½•
2. éªŒè¯æ— æ³•è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢ï¼ˆ403ï¼‰
3. éªŒè¯èœå•ä¸­ä¸æ˜¾ç¤º"ç”¨æˆ·ç®¡ç†"é€‰é¡¹

---

## 6. æµ‹è¯•æ–¹æ¡ˆ

### 6.1 Postman æµ‹è¯•ç”¨ä¾‹

#### æµ‹è¯•1ï¼šè·å–ç”¨æˆ·åˆ—è¡¨
```http
GET http://localhost:8080/api/users?page=1&size=10
Authorization: Bearer {admin_token}

æœŸæœ›ç»“æœï¼š
{
  "code": 200,
  "message": "è¿”å›æˆåŠŸ",
  "data": {
    "records": [...],
    "total": 3,
    "pages": 1,
    "current": 1,
    "size": 10
  }
}
```

#### æµ‹è¯•2ï¼šåˆ›å»ºç”¨æˆ·
```http
POST http://localhost:8080/api/users
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "username": "test_user",
  "email": "test@example.com",
  "role": "EMPLOYEE",
  "employeeId": 1
}

æœŸæœ›ç»“æœï¼š
{
  "code": 200,
  "message": "åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 4,
    "username": "test_user",
    "role": "EMPLOYEE",
    ...
  }
}
```

#### æµ‹è¯•3ï¼šåˆ†é…è§’è‰²
```http
PUT http://localhost:8080/api/users/4/role
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "role": "MANAGER",
  "department": "æŠ€æœ¯éƒ¨"
}

æœŸæœ›ç»“æœï¼š
{
  "code": 200,
  "message": "åˆ†é…è§’è‰²æˆåŠŸ",
  "data": {
    "id": 4,
    "role": "MANAGER",
    "department": "æŠ€æœ¯éƒ¨",
    ...
  }
}
```

#### æµ‹è¯•4ï¼šç¦ç”¨ç”¨æˆ·
```http
PUT http://localhost:8080/api/users/4/status?enabled=false
Authorization: Bearer {admin_token}

æœŸæœ›ç»“æœï¼š
{
  "code": 200,
  "message": "ç¦ç”¨æˆåŠŸ",
  "data": null
}
```

#### æµ‹è¯•5ï¼šåˆ é™¤ç”¨æˆ·
```http
DELETE http://localhost:8080/api/users/4
Authorization: Bearer {admin_token}

æœŸæœ›ç»“æœï¼š
{
  "code": 200,
  "message": "åˆ é™¤æˆåŠŸ",
  "data": null
}
```

### 6.2 å‰ç«¯åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•æ¸…å•
- [ ] åˆ—è¡¨å±•ç¤ºæ­£å¸¸
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- [ ] ç­›é€‰åŠŸèƒ½æ­£å¸¸
- [ ] åˆ›å»ºç”¨æˆ·æˆåŠŸ
- [ ] ç¼–è¾‘ç”¨æˆ·æˆåŠŸ
- [ ] è§’è‰²åˆ†é…æˆåŠŸ
- [ ] çŠ¶æ€åˆ‡æ¢æ­£å¸¸
- [ ] åˆ é™¤ç”¨æˆ·æˆåŠŸ
- [ ] é‡ç½®å¯†ç æˆåŠŸ
- [ ] è¡¨å•éªŒè¯æ­£å¸¸
- [ ] é”™è¯¯æç¤ºæ­£å¸¸
- [ ] æ“ä½œæ—¥å¿—è®°å½•æ­£å¸¸

---

## 7. æ³¨æ„äº‹é¡¹

### 7.1 å®‰å…¨æ€§

1. **å¯†ç å®‰å…¨**
   - é»˜è®¤å¯†ç ç»Ÿä¸€ä¸º "123456"
   - ä½¿ç”¨ BCrypt åŠ å¯†
   - é¦–æ¬¡ç™»å½•å¼ºåˆ¶ä¿®æ”¹å¯†ç ï¼ˆå¯é€‰ï¼‰

2. **æƒé™æ§åˆ¶**
   - æ‰€æœ‰æ¥å£å¿…é¡» SUPER_ADMIN æƒé™
   - ä¸èƒ½ç¦ç”¨è‡ªå·±çš„è´¦å·
   - ä¸èƒ½åˆ é™¤è¶…çº§ç®¡ç†å‘˜è´¦å·

3. **æ•°æ®éªŒè¯**
   - ç”¨æˆ·åå”¯ä¸€æ€§éªŒè¯
   - è§’è‰²å’Œéƒ¨é—¨å…³è”éªŒè¯
   - é‚®ç®±æ ¼å¼éªŒè¯

### 7.2 ä¸šåŠ¡è§„åˆ™

1. **è§’è‰²ä¸éƒ¨é—¨**
   - MANAGER å¿…é¡»æŒ‡å®šéƒ¨é—¨
   - EMPLOYEE å¯é€‰å…³è”å‘˜å·¥ID
   - SUPER_ADMIN æ— éœ€éƒ¨é—¨ä¿¡æ¯

2. **çŠ¶æ€ç®¡ç†**
   - ç¦ç”¨ç”¨æˆ·æ— æ³•ç™»å½•
   - å¯ä»¥é‡æ–°å¯ç”¨
   - å¯ç”¨/ç¦ç”¨éœ€è¦æ“ä½œæ—¥å¿—

3. **åˆ é™¤ç­–ç•¥**
   - å»ºè®®ä½¿ç”¨è½¯åˆ é™¤
   - ä¸èƒ½åˆ é™¤è¶…çº§ç®¡ç†å‘˜
   - åˆ é™¤å‰æ£€æŸ¥å…³è”æ•°æ®

---

## 8. æ€»ç»“

### 8.1 åŠŸèƒ½æ¸…å•

âœ… **åç«¯åŠŸèƒ½**
- [x] ç”¨æˆ·åˆ—è¡¨åˆ†é¡µæŸ¥è¯¢
- [x] ç”¨æˆ·è¯¦æƒ…æŸ¥è¯¢
- [x] åˆ›å»ºç”¨æˆ·
- [x] æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- [x] å¯ç”¨/ç¦ç”¨ç”¨æˆ·
- [x] åˆ†é…è§’è‰²
- [x] åˆ é™¤ç”¨æˆ·
- [x] é‡ç½®å¯†ç 
- [x] æ“ä½œæ—¥å¿—è®°å½•

âœ… **å‰ç«¯åŠŸèƒ½**
- [x] ç”¨æˆ·åˆ—è¡¨å±•ç¤º
- [x] åˆ†é¡µå’Œç­›é€‰
- [x] åˆ›å»ºç”¨æˆ·è¡¨å•
- [x] ç¼–è¾‘ç”¨æˆ·è¡¨å•
- [x] è§’è‰²åˆ†é…è¡¨å•
- [x] çŠ¶æ€åˆ‡æ¢å¼€å…³
- [x] åˆ é™¤ç¡®è®¤
- [x] å¯†ç é‡ç½®è¡¨å•
- [x] è§’è‰²æ ‡ç­¾æ˜¾ç¤º
- [x] é”™è¯¯æç¤º

### 8.2 é¢„è®¡å·¥æ—¶

| é˜¶æ®µ | å·¥ä½œå†…å®¹ | é¢„è®¡æ—¶é—´ |
|-----|---------|---------|
| åç«¯å®ç° | DTOã€Serviceã€Controller | 2-3å°æ—¶ |
| å‰ç«¯å®ç° | ç±»å‹ã€APIã€é¡µé¢ã€è·¯ç”± | 2-3å°æ—¶ |
| è”è°ƒæµ‹è¯• | åŠŸèƒ½æµ‹è¯•ã€ä¿®å¤bug | 1å°æ—¶ |
| **æ€»è®¡** | - | **5-7å°æ—¶** |

### 8.3 æ ¸å¿ƒä¼˜åŠ¿

ğŸ¯ **å®Œæ•´æ€§** - æ¶µç›–ç”¨æˆ·ç®¡ç†çš„æ‰€æœ‰åŠŸèƒ½  
ğŸ”’ **å®‰å…¨æ€§** - å®Œå–„çš„æƒé™æ§åˆ¶å’Œæ•°æ®éªŒè¯  
ğŸ“Š **å¯æ‰©å±•** - æ”¯æŒåˆ†é¡µã€ç­›é€‰ã€æ’åº  
ğŸ’¡ **æ˜“ç»´æŠ¤** - ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ³¨é‡Šå®Œæ•´  
ğŸš€ **å³ç”¨å‹** - ç›´æ¥å¤åˆ¶ä»£ç å³å¯è¿è¡Œ  

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-02  
**ä½œè€…**: AI Assistant  
**çŠ¶æ€**: âœ… å¯ç›´æ¥ä½¿ç”¨
