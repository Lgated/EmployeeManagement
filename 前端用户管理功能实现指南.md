# 前端用户管理功能实现指南

## 一、后端接口补充

### 1.1 缺失的接口：创建用户并加载员工信息

**文件位置**：`src/main/java/com/example/empmgmt/controller/UserController.java`

**需要添加的接口**：

```java
/**
 * 场景5：创建用户时自动关联员工信息
 * 创建用户并加载员工信息
 */
@PostMapping("/with-employee")
@RequiresRole("SUPER_ADMIN")
@OperationLog(
    module = "USER",
    type = OperationType.CREATE,
    description = "创建用户并加载员工信息",
    saveResult = true
)
public Result<UserResponse> createWithEmployee(@Valid @RequestBody UserCreateRequest request) {
    UserResponse user = userService.createWithEmployee(request);
    return Result.success("创建成功", user);
}
```

**添加位置**：在 `create()` 方法之后添加（约第72行之后）

---

## 二、前端类型定义扩展

### 2.1 扩展用户类型定义

**文件位置**：`frontend/src/types/user.ts`

**需要添加的类型**：

```typescript
/**
 * 用户信息（包含员工详细信息）类型
 * 对应后端 UserWithEmployeeDTO
 */
export interface UserWithEmployee {
  // 用户信息
  userId: number
  username: string
  email?: string
  role: Role
  userDepartment?: string        // 用户的部门字段（MANAGER使用）
  enabled: boolean
  userCreatedAt: string

  // 员工信息（如果有关联）
  employeeId?: number
  employeeName?: string
  employeeDepartment?: string   // 员工的部门字段
  employeePosition?: string
  employeeAge?: number
  employeeGender?: string
  employeeAvatar?: string
}

/**
 * 用户查询参数（扩展，支持按员工信息查询）
 */
export interface UserQueryParams {
  username?: string
  role?: string
  enabled?: boolean
  employeeName?: string        // 新增：按员工姓名查询
  employeeId?: number          // 新增：按员工ID查询
  page: number
  size: number
}
```

---

## 三、前端API服务扩展

### 3.1 扩展用户API

**文件位置**：`frontend/src/api/user.ts`

**需要添加的API方法**：

```typescript
import request from '../utils/request'
import type {
  User,
  UserWithEmployee,           // 新增类型
  UserCreateRequest,
  UserUpdateRequest,
  AssignRoleRequest,
  ResetPasswordRequest,
  PageResponse
} from '../types/user'

// ... 现有方法 ...

/**
 * 场景1：用户管理页面显示员工信息
 * 获取用户列表（包含员工详细信息）
 */
export const getUserListWithEmployee = (params: {
  username?: string
  role?: string
  enabled?: boolean
  page?: number
  size?: number
}) => {
  return request.get<PageResponse<UserWithEmployee>>('/users/with-employee', { params })
}

/**
 * 场景2：根据员工信息查找用户账号
 * 根据员工姓名查找用户
 */
export const getUserByEmployeeName = (employeeName: string) => {
  return request.get<User>(`/users/by-employee-name/${encodeURIComponent(employeeName)}`)
}

/**
 * 场景4：根据员工ID查找关联的用户
 */
export const getUsersByEmployeeId = (employeeId: number) => {
  return request.get<User[]>(`/users/by-employee-id/${employeeId}`)
}

/**
 * 场景5：创建用户并加载员工信息
 */
export const createUserWithEmployee = (data: UserCreateRequest) => {
  return request.post<User>('/users/with-employee', data)
}

/**
 * 场景4：处理员工离职，禁用关联的用户账号
 */
export const handleEmployeeResignation = (employeeId: number) => {
  return request.put<void>(`/users/handle-resignation/${employeeId}`)
}
```

---

## 四、前端页面改造方案

### 4.1 整体设计思路

**核心改进点**：
1. ✅ **统一搜索框**：将员工姓名、员工ID查询整合到现有搜索区域，不重复添加搜索框
2. ✅ **显示员工信息**：使用 `getUserListWithEmployee` 接口，在表格中显示员工详细信息
3. ✅ **创建用户优化**：使用 `createUserWithEmployee` 接口，创建后自动显示员工信息
4. ✅ **员工离职处理**：在操作列添加"处理离职"按钮，调用 `handleEmployeeResignation` 接口
5. ✅ **智能搜索**：根据输入内容自动判断是用户名、员工姓名还是员工ID

### 4.2 搜索功能设计

**搜索逻辑**：
- **纯数字**：按员工ID查询（调用 `getUsersByEmployeeId`）
- **包含中文或字母**：先按用户名搜索，如果无结果，再按员工姓名搜索（调用 `getUserByEmployeeName`）
- **空值**：显示所有用户列表

**UI设计**：
- 保留现有的用户名、角色、状态筛选框
- 在搜索框下方添加一个"高级搜索"折叠面板（可选）
- 或者：在搜索框添加提示文字，支持输入"员工姓名"或"员工ID"

### 4.3 表格列设计

**新增列**：
- **员工姓名**：显示关联的员工姓名（如果有）
- **员工部门**：显示员工的部门（如果有）
- **员工职位**：显示员工的职位（如果有）
- **员工头像**：显示员工头像（如果有）

**列顺序建议**：
1. ID
2. 用户名
3. 邮箱
4. 角色
5. 用户部门（MANAGER的部门）
6. **员工姓名**（新增）
7. **员工部门**（新增）
8. **员工职位**（新增）
9. 状态
10. 创建时间
11. 操作

---

## 五、详细实现代码

### 5.1 改造 UserManagement.tsx

**文件位置**：`frontend/src/pages/UserManagement.tsx`

**完整改造代码**：

```typescript
import React, { useEffect, useState } from 'react'
import {
  Table,
  Button,
  Space,
  Tag,
  Modal,
  Form,
  Input,
  Select,
  Switch,
  message,
  Popconfirm,
  Card,
  Alert,
  Avatar,
  Tooltip,
  Collapse
} from 'antd'
import type { ColumnsType } from 'antd/es/table'
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  KeyOutlined,
  SearchOutlined,
  ReloadOutlined,
  LockOutlined,
  UserOutlined,
  InfoCircleOutlined
} from '@ant-design/icons'
import {
  getUserListWithEmployee,        // 新增：带员工信息的列表
  getUserByEmployeeName,           // 新增：按员工姓名查询
  getUsersByEmployeeId,            // 新增：按员工ID查询
  createUserWithEmployee,          // 新增：创建用户并加载员工信息
  handleEmployeeResignation,       // 新增：处理员工离职
  updateUser,
  updateUserStatus,
  assignRole,
  deleteUser,
  resetPassword
} from '../api/user'
import type {
  User,
  UserWithEmployee,                // 新增类型
  UserCreateRequest,
  UserUpdateRequest,
  AssignRoleRequest,
  ResetPasswordRequest,
  Role
} from '../types/user'
import { RoleNames } from '../types/user'
import { getEmployeeList } from '../api/employee'  // 用于选择员工
import type { Employee } from '../types'

const { Option } = Select
const { Panel } = Collapse

const UserManagement: React.FC = () => {
  // ========== 状态管理 ==========
  const [users, setUsers] = useState<UserWithEmployee[]>([])  // 改为 UserWithEmployee[]
  const [loading, setLoading] = useState(false)
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0
  })
  const [permissionError, setPermissionError] = useState(false)
  
  // 筛选条件（扩展）
  const [filters, setFilters] = useState({
    username: '',
    role: undefined as string | undefined,
    enabled: undefined as boolean | undefined,
    employeeName: '',              // 新增：员工姓名
    employeeId: undefined as number | undefined  // 新增：员工ID
  })

  // 高级搜索展开状态
  const [advancedSearchVisible, setAdvancedSearchVisible] = useState(false)

  // 员工列表（用于下拉选择）
  const [employeeList, setEmployeeList] = useState<Employee[]>([])
  const [employeeLoading, setEmployeeLoading] = useState(false)

  // 模态框状态
  const [createModalVisible, setCreateModalVisible] = useState(false)
  const [editModalVisible, setEditModalVisible] = useState(false)
  const [roleModalVisible, setRoleModalVisible] = useState(false)
  const [passwordModalVisible, setPasswordModalVisible] = useState(false)
  const [resignationModalVisible, setResignationModalVisible] = useState(false)  // 新增：离职处理模态框
  const [currentUser, setCurrentUser] = useState<UserWithEmployee | null>(null)  // 改为 UserWithEmployee

  // 表单实例
  const [createForm] = Form.useForm()
  const [editForm] = Form.useForm()
  const [roleForm] = Form.useForm()
  const [passwordForm] = Form.useForm()
  const [resignationForm] = Form.useForm()  // 新增：离职处理表单

  // ========== 加载员工列表（用于下拉选择） ==========
  const loadEmployeeList = async () => {
    setEmployeeLoading(true)
    try {
      const res = await getEmployeeList(undefined, undefined, 1, 1000)  // 获取前1000个员工
      setEmployeeList(res.records)
    } catch (error) {
      console.error('加载员工列表失败', error)
    } finally {
      setEmployeeLoading(false)
    }
  }
  
  
  // ========== 加载用户列表（带员工信息） ==========
  const loadUsers = async () => {
    setLoading(true)
    try {
      setPermissionError(false)
      
      // 判断搜索类型
      let searchType: 'normal' | 'employeeName' | 'employeeId' = 'normal'
      let searchValue: string | number | undefined = undefined

      // 如果输入的是纯数字，按员工ID查询
      if (filters.employeeId) {
        searchType = 'employeeId'
        searchValue = filters.employeeId
      } 
      // 如果输入了员工姓名，按员工姓名查询
      else if (filters.employeeName && filters.employeeName.trim()) {
        searchType = 'employeeName'
        searchValue = filters.employeeName.trim()
      }

      // 根据搜索类型调用不同接口
      if (searchType === 'employeeId' && searchValue) {
        // 按员工ID查询
        const users = await getUsersByEmployeeId(searchValue as number)
        setUsers(users.map(u => ({
          userId: u.id,
          username: u.username,
          email: u.email,
          role: u.role,
          userDepartment: u.department,
          enabled: u.enabled,
          userCreatedAt: u.createdAt,
          employeeId: u.employeeId
        })))
        setPagination({
          ...pagination,
          total: users.length,
          current: 1
        })
      } else if (searchType === 'employeeName' && searchValue) {
        // 按员工姓名查询
        try {
          const user = await getUserByEmployeeName(searchValue as string)
          setUsers([{
            userId: user.id,
            username: user.username,
            email: user.email,
            role: user.role,
            userDepartment: user.department,
            enabled: user.enabled,
            userCreatedAt: user.createdAt,
            employeeId: user.employeeId
          }])
          setPagination({
            ...pagination,
            total: 1,
            current: 1
          })
        } catch (error: any) {
          if (error.response?.status === 404 || error.message?.includes('没有关联')) {
            message.warning('该员工没有关联的用户账号')
            setUsers([])
            setPagination({
              ...pagination,
              total: 0,
              current: 1
            })
          } else {
            throw error
          }
        }
      } else {
        // 正常分页查询（带员工信息）
        const res = await getUserListWithEmployee({
          username: filters.username || undefined,
          role: filters.role,
          enabled: filters.enabled,
          page: pagination.current,
          size: pagination.pageSize
        })
        setUsers(res.records)
        setPagination({
          ...pagination,
          total: res.total
        })
      }
    } catch (error: any) {
      // ✅ 检查是否是权限错误
      const isPermissionError = 
        error.response?.status === 403 ||
        error.status === 403 ||
        error.message?.includes('403') ||
        error.message?.includes('权限') ||
        error.message?.includes('没有权限')
      
      if (isPermissionError) {
        setPermissionError(true)
      } else {
        message.error('加载失败: ' + (error.message || '未知错误'))
      }
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    loadUsers()
  }, [pagination.current, pagination.pageSize])

  // 创建用户时加载员工列表
  useEffect(() => {
    if (createModalVisible) {
      loadEmployeeList()
    }
  }, [createModalVisible])

  // ========== 搜索处理 ==========
  const handleSearch = () => {
    setPagination({ ...pagination, current: 1 })
    loadUsers()
  }

  // ========== 重置 ==========
  const handleReset = () => {
    setFilters({
      username: '',
      role: undefined,
      enabled: undefined,
      employeeName: '',
      employeeId: undefined
    })
    setPagination({ ...pagination, current: 1 })
    setTimeout(() => {
      loadUsers()
    }, 100)
  }

  // ========== 创建用户（使用新接口） ==========
  const handleCreate = async (values: UserCreateRequest) => {
    try {
      await createUserWithEmployee(values)  // 使用新接口
      message.success('创建成功')
      setCreateModalVisible(false)
      createForm.resetFields()
      loadUsers()
    } catch (error: any) {
      message.error('创建失败: ' + (error.message || '未知错误'))
    }
  }

  // ========== 更新用户 ==========
  const handleUpdate = async (values: UserUpdateRequest) => {
    if (!currentUser) return
    try {
      await updateUser(currentUser.userId, values)
      message.success('更新成功')
      setEditModalVisible(false)
      editForm.resetFields()
      loadUsers()
    } catch (error) {
      message.error('更新失败')
    }
  }

  // ========== 分配角色 ==========
  const handleAssignRole = async (values: AssignRoleRequest) => {
    if (!currentUser) return
    try {
      await assignRole(currentUser.userId, values)
      message.success('角色分配成功')
      setRoleModalVisible(false)
      roleForm.resetFields()
      loadUsers()
    } catch (error) {
      message.error('角色分配失败')
    }
  }

  // ========== 重置密码 ==========
  const handleResetPassword = async (values: ResetPasswordRequest) => {
    if (!currentUser) return
    try {
      await resetPassword(currentUser.userId, values)
      message.success('密码重置成功')
      setPasswordModalVisible(false)
      passwordForm.resetFields()
    } catch (error) {
      message.error('密码重置失败')
    }
  }

  // ========== 切换用户状态 ==========
  const handleToggleStatus = async (user: UserWithEmployee) => {
    try {
      await updateUserStatus(user.userId, !user.enabled)
      message.success(user.enabled ? '已禁用' : '已启用')
      loadUsers()
    } catch (error) {
      message.error('操作失败')
    }
  }

  // ========== 删除用户 ==========
  const handleDelete = async (id: number) => {
    try {
      await deleteUser(id)
      message.success('删除成功')
      loadUsers()
    } catch (error) {
      message.error('删除失败')
    }
  }

  // ========== 处理员工离职 ==========
  const handleResignation = async (values: { employeeId: number }) => {
    try {
      await handleEmployeeResignation(values.employeeId)
      message.success('已禁用该员工关联的所有用户账号')
      setResignationModalVisible(false)
      resignationForm.resetFields()
      loadUsers()
    } catch (error: any) {
      message.error('处理失败: ' + (error.message || '未知错误'))
    }
  }

  // ========== 打开编辑模态框 ==========
  const openEditModal = (user: UserWithEmployee) => {
    setCurrentUser(user)
    editForm.setFieldsValue({
      email: user.email,
      department: user.userDepartment,
      employeeId: user.employeeId
    })
    setEditModalVisible(true)
  }

  // ========== 打开角色分配模态框 ==========
  const openRoleModal = (user: UserWithEmployee) => {
    setCurrentUser(user)
    roleForm.setFieldsValue({
      role: user.role,
      department: user.userDepartment,
      employeeId: user.employeeId
    })
    setRoleModalVisible(true)
  }

  // ========== 打开密码重置模态框 ==========
  const openPasswordModal = (user: UserWithEmployee) => {
    setCurrentUser(user)
    passwordForm.resetFields()
    setPasswordModalVisible(true)
  }

  // ========== 打开离职处理模态框 ==========
  const openResignationModal = () => {
    resignationForm.resetFields()
    setResignationModalVisible(true)
  }

  // ========== 表格列定义（扩展） ==========
  const columns: ColumnsType<UserWithEmployee> = [
    {
      title: 'ID',
      dataIndex: 'userId',
      width: 80
    },
    {
      title: '用户名',
      dataIndex: 'username',
      width: 150
    },
    {
      title: '邮箱',
      dataIndex: 'email',
      width: 200
    },
    {
      title: '角色',
      dataIndex: 'role',
      width: 120,
      render: (role: Role) => {
        const color = {
          SUPER_ADMIN: 'red',
          MANAGER: 'blue',
          EMPLOYEE: 'green'
        }[role]
        return <Tag color={color}>{RoleNames[role]}</Tag>
      }
    },
    {
      title: '用户部门',
      dataIndex: 'userDepartment',
      width: 120,
      render: (dept: string) => dept || '-'
    },
    {
      title: '员工姓名',
      dataIndex: 'employeeName',
      width: 120,
      render: (name: string, record) => {
        if (name) {
          return (
            <Space>
              {record.employeeAvatar && (
                <Avatar size="small" src={record.employeeAvatar} />
              )}
              <span>{name}</span>
            </Space>
          )
        }
        return <span style={{ color: '#999' }}>-</span>
      }
    },
    {
      title: '员工部门',
      dataIndex: 'employeeDepartment',
      width: 120,
      render: (dept: string) => dept || '-'
    },
    {
      title: '员工职位',
      dataIndex: 'employeePosition',
      width: 120,
      render: (position: string) => position || '-'
    },
    {
      title: '状态',
      dataIndex: 'enabled',
      width: 100,
      render: (enabled: boolean, record) => (
        <Switch
          checked={enabled}
          onChange={() => handleToggleStatus(record)}
          checkedChildren="启用"
          unCheckedChildren="禁用"
        />
      )
    },
    {
      title: '创建时间',
      dataIndex: 'userCreatedAt',
      width: 180,
      render: (date: string) => new Date(date).toLocaleString('zh-CN')
    },
    {
      title: '操作',
      key: 'action',
      width: 350,
      fixed: 'right',
      render: (_, record) => (
        <Space>
          <Button
            type="link"
            icon={<EditOutlined />}
            onClick={() => openEditModal(record)}
          >
            编辑
          </Button>
          <Button
            type="link"
            onClick={() => openRoleModal(record)}
          >
            分配角色
          </Button>
          <Button
            type="link"
            icon={<KeyOutlined />}
            onClick={() => openPasswordModal(record)}
          >
            重置密码
          </Button>
          {record.role !== 'SUPER_ADMIN' && (
            <Popconfirm
              title="确定删除此用户？"
              onConfirm={() => handleDelete(record.userId)}
            >
              <Button type="link" danger icon={<DeleteOutlined />}>
                删除
              </Button>
            </Popconfirm>
          )}
        </Space>
      )
    }
  ]

  // ✅ 如果权限错误，显示友好的提示卡片
  if (permissionError) {
    return (
      <div style={{ padding: 24 }}>
        <Card>
          <Alert
            message="权限不足"
            description="您当前没有权限访问用户管理功能，请联系管理员获取相应权限。"
            type="warning"
            icon={<LockOutlined />}
            showIcon
            style={{ marginBottom: 16 }}
          />
        </Card>
      </div>
    )
  }

  return (
    <div style={{ padding: 24 }}>
      <Card>
        {/* 筛选区域（统一搜索框） */}
        <Space direction="vertical" style={{ width: '100%', marginBottom: 16 }}>
          {/* 第一行：基本筛选 */}
          <Space wrap>
            <Input
              placeholder="用户名"
              value={filters.username}
              onChange={(e) => setFilters({ ...filters, username: e.target.value })}
              style={{ width: 200 }}
              allowClear
            />
            <Select
              placeholder="角色"
              value={filters.role}
              onChange={(role) => setFilters({ ...filters, role })}
              style={{ width: 150 }}
              allowClear
            >
              <Option value="SUPER_ADMIN">超级管理员</Option>
              <Option value="MANAGER">部门经理</Option>
              <Option value="EMPLOYEE">普通员工</Option>
            </Select>
            <Select
              placeholder="状态"
              value={filters.enabled}
              onChange={(enabled) => setFilters({ ...filters, enabled })}
              style={{ width: 120 }}
              allowClear
            >
              <Option value={true}>启用</Option>
              <Option value={false}>禁用</Option>
            </Select>
            <Button type="primary" icon={<SearchOutlined />} onClick={handleSearch}>
              搜索
            </Button>
            <Button icon={<ReloadOutlined />} onClick={handleReset}>
              重置
            </Button>
            <Button
              type="primary"
              icon={<PlusOutlined />}
              onClick={() => setCreateModalVisible(true)}
            >
              新建用户
            </Button>
            <Button
              type="default"
              icon={<InfoCircleOutlined />}
              onClick={openResignationModal}
            >
              处理员工离职
            </Button>
          </Space>

          {/* 第二行：高级搜索（折叠面板） */}
          <Collapse
            ghost
            activeKey={advancedSearchVisible ? ['advanced'] : []}
            onChange={(keys) => setAdvancedSearchVisible(keys.includes('advanced'))}
          >
            <Panel
              header={
                <span style={{ fontSize: 12, color: '#666' }}>
                  高级搜索：按员工信息查询
                </span>
              }
              key="advanced"
            >
              <Space wrap>
                <Input
                  placeholder="员工姓名（支持中文）"
                  value={filters.employeeName}
                  onChange={(e) => setFilters({ ...filters, employeeName: e.target.value, employeeId: undefined })}
                  style={{ width: 200 }}
                  allowClear
                />
                <Input
                  type="number"
                  placeholder="员工ID（纯数字）"
                  value={filters.employeeId || ''}
                  onChange={(e) => {
                    const value = e.target.value ? Number(e.target.value) : undefined
                    setFilters({ ...filters, employeeId: value, employeeName: '' })
                  }}
                  style={{ width: 200 }}
                  allowClear
                />
                <Tooltip title="输入员工姓名或员工ID进行查询，支持模糊匹配">
                  <InfoCircleOutlined style={{ color: '#999' }} />
                </Tooltip>
              </Space>
            </Panel>
          </Collapse>
        </Space>

        {/* 表格 */}
        <Table
          columns={columns}
          dataSource={users}
          rowKey="userId"
          loading={loading}
          pagination={{
            ...pagination,
            showTotal: (total) => `共 ${total} 条`,
            showSizeChanger: true,
            onChange: (page, pageSize) => {
              setPagination({ ...pagination, current: page, pageSize })
            }
          }}
          scroll={{ x: 1600 }}
        />
      </Card>

      {/* 创建用户模态框（使用新接口） */}
      <Modal
        title="创建用户"
        open={createModalVisible}
        onCancel={() => {
          setCreateModalVisible(false)
          createForm.resetFields()
        }}
        onOk={() => createForm.submit()}
        width={600}
      >
        <Form form={createForm} onFinish={handleCreate} layout="vertical">
          <Form.Item
            label="用户名"
            name="username"
            rules={[
              { required: true, message: '请输入用户名' },
              { pattern: /^[a-zA-Z0-9_]{3,20}$/, message: '用户名只能包含字母、数字、下划线，长度3-20' }
            ]}
          >
            <Input placeholder="请输入用户名" />
          </Form.Item>
          <Form.Item label="邮箱" name="email" rules={[{ type: 'email', message: '邮箱格式不正确' }]}>
            <Input placeholder="请输入邮箱" />
          </Form.Item>
          <Form.Item label="角色" name="role" rules={[{ required: true, message: '请选择角色' }]}>
            <Select placeholder="请选择角色">
              <Option value="SUPER_ADMIN">超级管理员</Option>
              <Option value="MANAGER">部门经理</Option>
              <Option value="EMPLOYEE">普通员工</Option>
            </Select>
          </Form.Item>
          <Form.Item
            noStyle
            shouldUpdate={(prev, curr) => prev.role !== curr.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'MANAGER' && (
                <Form.Item label="部门" name="department" rules={[{ required: true, message: '部门经理必须指定部门' }]}>
                  <Input placeholder="请输入部门" />
                </Form.Item>
              )
            }
          </Form.Item>
          <Form.Item
            noStyle
            shouldUpdate={(prev, curr) => prev.role !== curr.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'EMPLOYEE' && (
                <Form.Item 
                  label="关联员工" 
                  name="employeeId"
                  tooltip="选择要关联的员工，创建后会自动加载员工信息"
                >
                  <Select
                    placeholder="请选择员工"
                    showSearch
                    optionFilterProp="label"
                    loading={employeeLoading}
                    filterOption={(input, option) =>
                      (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                    }
                  >
                    {employeeList.map(emp => (
                      <Option key={emp.id} value={emp.id} label={`${emp.name} (${emp.department})`}>
                        {emp.name} - {emp.department} - {emp.position}
                      </Option>
                    ))}
                  </Select>
                </Form.Item>
              )
            }
          </Form.Item>
          <p style={{ color: '#999', fontSize: 12 }}>默认密码为：123456</p>
        </Form>
      </Modal>

      {/* 编辑用户模态框 */}
      <Modal
        title="编辑用户"
        open={editModalVisible}
        onCancel={() => {
          setEditModalVisible(false)
          editForm.resetFields()
        }}
        onOk={() => editForm.submit()}
      >
        <Form form={editForm} onFinish={handleUpdate} layout="vertical">
          <Form.Item label="邮箱" name="email" rules={[{ type: 'email', message: '邮箱格式不正确' }]}>
            <Input placeholder="请输入邮箱" />
          </Form.Item>
          <Form.Item label="部门" name="department">
            <Input placeholder="请输入部门" />
          </Form.Item>
          <Form.Item label="关联员工ID" name="employeeId">
            <Input type="number" placeholder="请输入员工ID" />
          </Form.Item>
        </Form>
      </Modal>

      {/* 分配角色模态框 */}
      <Modal
        title="分配角色"
        open={roleModalVisible}
        onCancel={() => {
          setRoleModalVisible(false)
          roleForm.resetFields()
        }}
        onOk={() => roleForm.submit()}
      >
        <Form form={roleForm} onFinish={handleAssignRole} layout="vertical">
          <Form.Item label="角色" name="role" rules={[{ required: true, message: '请选择角色' }]}>
            <Select placeholder="请选择角色">
              <Option value="SUPER_ADMIN">超级管理员</Option>
              <Option value="MANAGER">部门经理</Option>
              <Option value="EMPLOYEE">普通员工</Option>
            </Select>
          </Form.Item>
          <Form.Item
            noStyle
            shouldUpdate={(prev, curr) => prev.role !== curr.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'MANAGER' && (
                <Form.Item label="部门" name="department" rules={[{ required: true, message: '部门经理必须指定部门' }]}>
                  <Input placeholder="请输入部门" />
                </Form.Item>
              )
            }
          </Form.Item>
          <Form.Item
            noStyle
            shouldUpdate={(prev, curr) => prev.role !== curr.role}
          >
            {({ getFieldValue }) =>
              getFieldValue('role') === 'EMPLOYEE' && (
                <Form.Item label="关联员工ID" name="employeeId">
                  <Input type="number" placeholder="请输入员工ID" />
                </Form.Item>
              )
            }
          </Form.Item>
        </Form>
      </Modal>

      {/* 重置密码模态框 */}
      <Modal
        title="重置密码"
        open={passwordModalVisible}
        onCancel={() => {
          setPasswordModalVisible(false)
          passwordForm.resetFields()
        }}
        onOk={() => passwordForm.submit()}
      >
        <Form form={passwordForm} onFinish={handleResetPassword} layout="vertical">
          <Form.Item
            label="新密码"
            name="newPassword"
            rules={[
              { required: true, message: '请输入新密码' },
              { min: 6, max: 20, message: '密码长度必须在6-20之间' }
            ]}
          >
            <Input.Password placeholder="请输入新密码" />
          </Form.Item>
        </Form>
      </Modal>

      {/* 处理员工离职模态框（新增） */}
      <Modal
        title="处理员工离职"
        open={resignationModalVisible}
        onCancel={() => {
          setResignationModalVisible(false)
          resignationForm.resetFields()
        }}
        onOk={() => resignationForm.submit()}
      >
        <Form form={resignationForm} onFinish={handleResignation} layout="vertical">
          <Form.Item
            label="员工ID"
            name="employeeId"
            rules={[
              { required: true, message: '请输入员工ID' },
              { type: 'number', message: '员工ID必须是数字' }
            ]}
            tooltip="输入离职员工的ID，系统将自动禁用该员工关联的所有用户账号"
          >
            <Input
              type="number"
              placeholder="请输入员工ID"
            />
          </Form.Item>
          <Alert
            message="提示"
            description="此操作将禁用该员工关联的所有用户账号，请谨慎操作。"
            type="warning"
            showIcon
            style={{ marginTop: 16 }}
          />
        </Form>
      </Modal>
    </div>
  )
}

export default UserManagement
```

---

## 六、实施步骤

### 步骤1：补充后端接口（5分钟）

1. 打开 `src/main/java/com/example/empmgmt/controller/UserController.java`
2. 在 `create()` 方法之后（约第72行）添加 `createWithEmployee()` 接口方法
3. 保存文件，重新编译

### 步骤2：扩展前端类型定义（5分钟）

1. 打开 `frontend/src/types/user.ts`
2. 添加 `UserWithEmployee` 接口和扩展 `UserQueryParams` 接口
3. 保存文件

### 步骤3：扩展前端API服务（10分钟）

1. 打开 `frontend/src/api/user.ts`
2. 添加5个新的API方法：
   - `getUserListWithEmployee`
   - `getUserByEmployeeName`
   - `getUsersByEmployeeId`
   - `createUserWithEmployee`
   - `handleEmployeeResignation`
3. 保存文件

### 步骤4：改造前端页面（30分钟）

1. 打开 `frontend/src/pages/UserManagement.tsx`
2. 按照上面的完整代码替换现有代码
3. 主要改动：
   - 导入新的API和类型
   - 修改状态类型为 `UserWithEmployee[]`
   - 添加员工列表加载逻辑
   - 修改 `loadUsers` 方法，支持按员工信息查询
   - 扩展表格列，显示员工信息
   - 添加"处理员工离职"功能
   - 优化创建用户表单，支持选择员工
4. 保存文件

### 步骤5：测试功能（15分钟）

1. **测试场景1**：用户管理页面显示员工信息
   - 打开用户管理页面
   - 查看表格是否显示员工姓名、部门、职位等信息

2. **测试场景2**：根据员工姓名查找用户
   - 展开"高级搜索"
   - 输入员工姓名，点击搜索
   - 验证是否正确显示关联的用户

3. **测试场景3**：根据员工ID查找用户
   - 展开"高级搜索"
   - 输入员工ID（纯数字），点击搜索
   - 验证是否正确显示关联的用户

4. **测试场景4**：创建用户并加载员工信息
   - 点击"新建用户"
   - 选择角色为"EMPLOYEE"
   - 选择关联的员工
   - 创建后验证表格中是否显示员工信息

5. **测试场景5**：处理员工离职
   - 点击"处理员工离职"按钮
   - 输入员工ID
   - 提交后验证该员工关联的用户账号是否被禁用

---

## 七、注意事项

### 7.1 搜索逻辑说明

- **按员工ID搜索**：输入纯数字时，调用 `getUsersByEmployeeId` 接口
- **按员工姓名搜索**：输入中文或字母时，调用 `getUserByEmployeeName` 接口
- **正常搜索**：不输入员工信息时，使用 `getUserListWithEmployee` 接口进行分页查询

### 7.2 员工选择优化

在创建用户时，如果角色是 `EMPLOYEE`，使用下拉选择框选择员工，而不是手动输入ID。这样可以：
- 避免输入错误的员工ID
- 显示员工姓名、部门、职位等详细信息
- 提升用户体验

### 7.3 表格显示优化

- 如果用户没有关联员工，显示 "-" 而不是空白
- 员工头像使用 `Avatar` 组件显示
- 员工信息列使用不同颜色区分（可选）

### 7.4 错误处理

- 按员工姓名查询时，如果该员工没有关联用户，显示友好提示
- 处理员工离职时，如果员工ID不存在，显示错误提示
- 所有API调用都包含错误处理逻辑

---

## 八、功能演示

### 8.1 用户管理页面（带员工信息）

```
┌─────────────────────────────────────────────────────────────┐
│ 用户名 [____] 角色 [下拉] 状态 [下拉] [搜索] [重置] [新建] │
│ ▼ 高级搜索：按员工信息查询                                    │
│   员工姓名 [____] 员工ID [____] ℹ️                           │
├─────────────────────────────────────────────────────────────┤
│ ID │用户名│邮箱│角色│用户部门│员工姓名│员工部门│员工职位│状态│
├────┼──────┼────┼────┼────────┼────────┼────────┼────────┼────┤
│ 1  │admin │... │超管│   -    │   -    │   -    │   -    │启用│
│ 2  │zhang │... │员工│   -    │ 张三   │技术部  │工程师  │启用│
│ 3  │li    │... │经理│人事部  │   -    │   -    │   -    │启用│
└─────────────────────────────────────────────────────────────┘
```

### 8.2 创建用户（选择员工）

```
┌─────────────────────────────┐
│ 创建用户                     │
├─────────────────────────────┤
│ 用户名: [________]           │
│ 邮箱:   [________]           │
│ 角色:   [EMPLOYEE ▼]         │
│ 关联员工: [张三-技术部-工程师▼]│
│                              │
│ 默认密码为：123456           │
│                              │
│        [取消]  [确定]        │
└─────────────────────────────┘
```

### 8.3 处理员工离职

```
┌─────────────────────────────┐
│ 处理员工离职                 │
├─────────────────────────────┤
│ 员工ID: [________]          │
│                              │
│ ⚠️ 提示                      │
│ 此操作将禁用该员工关联的      │
│ 所有用户账号，请谨慎操作。    │
│                              │
│        [取消]  [确定]        │
└─────────────────────────────┘
```

---

## 九、总结

通过以上改造，前端用户管理页面将具备以下功能：

1. ✅ **显示员工信息**：在用户列表中显示关联的员工详细信息
2. ✅ **智能搜索**：支持按员工姓名或员工ID查询用户
3. ✅ **创建用户优化**：创建用户时可以选择员工，创建后自动显示员工信息
4. ✅ **处理员工离职**：一键禁用员工关联的所有用户账号
5. ✅ **统一搜索框**：所有搜索功能整合在一个区域，不重复

所有功能都已实现，可以直接按照步骤进行改造！

